{% extends "base.html" %}

{% block head %}
  <style>
    .panel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .form-row .form-group {
      flex: 1 1 160px;
    }

    input,
    select {
      padding: 0.6rem 0.75rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text);
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.25);
    }

    .status-message {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .status-message.success {
      color: var(--success);
    }

    .status-message.error {
      color: var(--danger);
    }

    .table-wrapper {
      margin-top: 1rem;
      overflow-x: auto;
    }

    .actions-column {
      display: flex;
      gap: 0.5rem;
    }

    @media (max-width: 640px) {
      .form-row {
        flex-direction: column;
      }
    }
  </style>
{% endblock %}

{% block header_controls %}
  <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
    <span class="badge">Logged in as {{ user }}</span>
    <a href="/" class="button secondary">Dashboard</a>
    <form method="post" action="/logout">
      <button type="submit">Logout</button>
    </form>
  </div>
{% endblock %}

{% block content %}
  <section class="card" style="margin-bottom: 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
      <div>
        <h2 style="margin: 0 0 0.5rem;">Trading panel</h2>
        <p style="margin: 0; color: var(--muted);">
          Manage orders and positions across connected accounts in real time.
        </p>
      </div>
      <button type="button" class="button secondary" id="refresh-button">Refresh</button>
    </div>
  </section>

  <section class="panel-grid" aria-live="polite">
    <section class="card" id="order-card">
      <h3 style="margin-top: 0;">Create order</h3>
      <form id="order-form" style="display: flex; flex-direction: column; gap: 1rem;">
        <div class="form-row">
          <div class="form-group">
            <label for="account-select">Account</label>
            <select id="account-select" name="account" required></select>
          </div>
          <div class="form-group">
            <label for="symbol-input">Symbol</label>
            <input id="symbol-input" name="symbol" placeholder="e.g. BTC/USDT" required />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="side-select">Side</label>
            <select id="side-select" name="side" required>
              <option value="buy">Buy</option>
              <option value="sell">Sell</option>
            </select>
          </div>
          <div class="form-group">
            <label for="type-select">Order type</label>
            <select id="type-select" name="order_type" required></select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="amount-input">Amount</label>
            <input id="amount-input" name="amount" type="number" step="any" min="0" required />
          </div>
          <div class="form-group">
            <label for="price-input">Price (optional for market)</label>
            <input id="price-input" name="price" type="number" step="any" min="0" />
          </div>
        </div>
        <div class="form-group">
          <label for="params-input">Additional params (JSON)</label>
          <textarea
            id="params-input"
            name="params"
            rows="3"
            style="resize: vertical; padding: 0.6rem 0.75rem; border-radius: 0.6rem; border: 1px solid rgba(148, 163, 184, 0.2); background: rgba(15, 23, 42, 0.6); color: var(--text);"
            placeholder="{\n  &quot;reduceOnly&quot;: true\n}"
          ></textarea>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
          <button type="submit" class="button">Submit order</button>
          <div class="status-message" id="order-status" hidden></div>
        </div>
      </form>
    </section>

    <section class="card" id="stop-loss-card">
      <h3 style="margin-top: 0;">Portfolio stop loss</h3>
      <p style="color: var(--muted);" id="stop-loss-summary"></p>
      <form id="stop-loss-form" style="display: flex; flex-direction: column; gap: 1rem;">
        <div class="form-row">
          <div class="form-group">
            <label for="stop-loss-threshold">Drawdown threshold (%)</label>
            <input id="stop-loss-threshold" name="threshold" type="number" step="0.1" min="0" required />
          </div>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
          <button type="submit" class="button">Set threshold</button>
          <button type="button" class="button secondary" id="stop-loss-clear">Clear</button>
          <div class="status-message" id="stop-loss-status" hidden></div>
        </div>
      </form>
    </section>
  </section>

  <section class="card" style="margin-top: 1.5rem;" id="positions-card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0;">Positions</h3>
      <span id="positions-summary" style="color: var(--muted);"></span>
    </div>
    <div class="table-wrapper">
      <table id="positions-table">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Side</th>
            <th>Notional</th>
            <th>Exposure %</th>
            <th>Unrealised PnL</th>
            <th>Daily realised PnL</th>
            <th>Entry</th>
            <th>Mark</th>
            <th>Liq.</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card" style="margin-top: 1.5rem;" id="orders-card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0;">Open orders</h3>
      <span id="orders-summary" style="color: var(--muted);"></span>
    </div>
    <div class="table-wrapper">
      <table id="orders-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Symbol</th>
            <th>Side</th>
            <th>Type</th>
            <th>Price</th>
            <th>Amount</th>
            <th>Remaining</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
{% endblock %}

{% block scripts %}
  <script>
    const initialSnapshot = {{ snapshot | tojson | safe }};
    const state = {
      snapshot: initialSnapshot,
      currentAccount: (initialSnapshot.accounts && initialSnapshot.accounts[0]?.name) || "",
      orderTypes: new Map(),
    };

    const accountSelect = document.getElementById("account-select");
    const typeSelect = document.getElementById("type-select");
    const orderStatus = document.getElementById("order-status");
    const positionsTableBody = document.querySelector("#positions-table tbody");
    const ordersTableBody = document.querySelector("#orders-table tbody");
    const positionsSummary = document.getElementById("positions-summary");
    const ordersSummary = document.getElementById("orders-summary");
    const stopLossSummary = document.getElementById("stop-loss-summary");
    const stopLossStatus = document.getElementById("stop-loss-status");
    const refreshButton = document.getElementById("refresh-button");

    const formatCurrency = (value) => {
      const number = Number(value);
      if (!Number.isFinite(number)) {
        return "-";
      }
      return new Intl.NumberFormat(undefined, { style: "currency", currency: "USD" }).format(number);
    };

    const formatPct = (value) => {
      const number = Number(value);
      if (!Number.isFinite(number)) {
        return "0.00%";
      }
      return `${(number * 100).toFixed(2)}%`;
    };

    const showStatus = (element, message, variant = "info") => {
      if (!element) return;
      element.hidden = !message;
      element.textContent = message || "";
      element.classList.remove("success", "error");
      if (variant === "success") {
        element.classList.add("success");
      } else if (variant === "error") {
        element.classList.add("error");
      }
    };

    const renderAccountOptions = () => {
      if (!accountSelect) {
        return;
      }
      const accounts = Array.isArray(state.snapshot.accounts) ? state.snapshot.accounts : [];
      if (!accounts.some((account) => account.name === state.currentAccount)) {
        state.currentAccount = accounts.length > 0 ? accounts[0].name : "";
      }
      const options = accounts
        .map((account) => {
          const selected = account.name === state.currentAccount ? "selected" : "";
          return `<option value="${account.name}" ${selected}>${account.name}</option>`;
        })
        .join("");
      accountSelect.innerHTML = options;
    };

    const renderOrderTypes = () => {
      if (!typeSelect) {
        return;
      }
      const types = state.orderTypes.get(state.currentAccount) || [];
      const fallback = types.length === 0 ? ["limit", "market"] : types;
      typeSelect.innerHTML = fallback
        .map((type) => `<option value="${type}">${type}</option>`)
        .join("");
    };

    const renderPositions = () => {
      const accounts = Array.isArray(state.snapshot.accounts) ? state.snapshot.accounts : [];
      const account = accounts.find((item) => item.name === state.currentAccount);
      const positions = account && Array.isArray(account.positions) ? account.positions : [];
      positionsSummary.textContent = `${positions.length} position${positions.length === 1 ? "" : "s"}`;
      positionsTableBody.innerHTML = positions
        .map((position) => {
          const pnlClass = Number(position.unrealized_pnl) >= 0 ? "gain" : "loss";
          const realizedClass = Number(position.daily_realized_pnl) >= 0 ? "gain" : "loss";
          return `
            <tr>
              <td>${position.symbol}</td>
              <td>${position.side}</td>
              <td>${formatCurrency(position.notional)}</td>
              <td>${formatPct(position.exposure)}</td>
              <td class="${pnlClass}">${formatCurrency(position.unrealized_pnl)}</td>
              <td class="${realizedClass}">${formatCurrency(position.daily_realized_pnl)}</td>
              <td>${formatCurrency(position.entry_price)}</td>
              <td>${formatCurrency(position.mark_price)}</td>
              <td>${position.liquidation_price !== null && position.liquidation_price !== undefined ? formatCurrency(position.liquidation_price) : "-"}</td>
              <td>
                <div class="actions-column">
                  <button type="button" class="button danger small" data-close-position data-symbol="${position.symbol}">Close</button>
                </div>
              </td>
            </tr>
          `;
        })
        .join("");
      if (positions.length === 0) {
        positionsTableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: var(--muted);">No open positions.</td></tr>';
      }
    };

    const renderOrders = () => {
      const accounts = Array.isArray(state.snapshot.accounts) ? state.snapshot.accounts : [];
      const account = accounts.find((item) => item.name === state.currentAccount);
      const orders = account && Array.isArray(account.orders) ? account.orders : [];
      ordersSummary.textContent = `${orders.length} order${orders.length === 1 ? "" : "s"}`;
      ordersTableBody.innerHTML = orders
        .map((order) => {
          const orderId = order.order_id || "";
          const cancelAction = orderId
            ? `<button type="button" class="button danger small" data-cancel-order data-order-id="${orderId}" data-symbol="${order.symbol}">Cancel</button>`
            : '<span style="color: var(--muted);">N/A</span>';
          return `
            <tr>
              <td>${orderId || "-"}</td>
              <td>${order.symbol}</td>
              <td>${order.side}</td>
              <td>${order.type}</td>
              <td>${order.price !== null && order.price !== undefined ? formatCurrency(order.price) : "-"}</td>
              <td>${order.amount ?? "-"}</td>
              <td>${order.remaining ?? "-"}</td>
              <td>${order.status || "-"}</td>
              <td>
                <div class="actions-column">
                  ${cancelAction}
                </div>
              </td>
            </tr>
          `;
        })
        .join("");
      if (orders.length === 0) {
        ordersTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--muted);">No open orders.</td></tr>';
      }
    };

    const renderStopLoss = () => {
      const stopLoss = state.snapshot.portfolio_stop_loss;
      if (!stopLoss) {
        stopLossSummary.textContent = "No active stop loss.";
        document.getElementById("stop-loss-threshold").value = "";
        return;
      }
      const threshold = Number(stopLoss.threshold_pct ?? 0);
      const baseline = stopLoss.baseline_balance ? formatCurrency(stopLoss.baseline_balance) : "-";
      const currentBalance = stopLoss.current_balance ? formatCurrency(stopLoss.current_balance) : "-";
      const drawdown = Number(stopLoss.current_drawdown_pct);
      const drawdownStr = Number.isFinite(drawdown) ? `${(drawdown * 100).toFixed(2)}%` : "-";
      const triggered = stopLoss.triggered ? "Triggered" : "Active";
      stopLossSummary.textContent = `Status: ${triggered}. Threshold ${threshold.toFixed(2)}%. Baseline ${baseline}, current ${currentBalance}, drawdown ${drawdownStr}.`;
      if (!stopLoss.triggered && threshold > 0) {
        document.getElementById("stop-loss-threshold").value = threshold;
      }
    };

    const renderAll = () => {
      renderAccountOptions();
      renderOrderTypes();
      renderPositions();
      renderOrders();
      renderStopLoss();
    };

    const parseParams = (raw) => {
      if (!raw) {
        return null;
      }
      try {
        const parsed = JSON.parse(raw);
        return typeof parsed === "object" && parsed !== null ? parsed : null;
      } catch (error) {
        return null;
      }
    };

    const fetchOrderTypes = async (accountName) => {
      if (!accountName) {
        return;
      }
      try {
        const response = await fetch(`/api/trading/accounts/${encodeURIComponent(accountName)}/order-types`, {
          credentials: "include",
        });
        if (!response.ok) {
          throw new Error(`Unable to load order types (${response.status})`);
        }
        const payload = await response.json();
        state.orderTypes.set(accountName, payload.order_types || []);
        renderOrderTypes();
      } catch (error) {
        console.error(error);
        showStatus(orderStatus, error.message, "error");
      }
    };

    const refreshSnapshot = async () => {
      try {
        const response = await fetch("/api/snapshot", { credentials: "include" });
        if (!response.ok) {
          throw new Error(`Failed to refresh snapshot (${response.status})`);
        }
        state.snapshot = await response.json();
        const accounts = Array.isArray(state.snapshot.accounts) ? state.snapshot.accounts : [];
        if (!accounts.some((account) => account.name === state.currentAccount)) {
          state.currentAccount = accounts.length > 0 ? accounts[0].name : "";
        }
        renderAll();
        await fetchOrderTypes(state.currentAccount);
      } catch (error) {
        console.error(error);
        showStatus(orderStatus, error.message, "error");
      }
    };

    const orderSelectHandler = async (event) => {
      state.currentAccount = event.target.value;
      renderPositions();
      renderOrders();
      await fetchOrderTypes(state.currentAccount);
    };

    if (accountSelect) {
      accountSelect.addEventListener("change", async (event) => {
        await orderSelectHandler(event);
      });
    }

    document.getElementById("order-form").addEventListener("submit", async (event) => {
      event.preventDefault();
      const form = event.currentTarget;
      const formData = new FormData(form);
      const accountName = formData.get("account");
      const payload = {
        symbol: formData.get("symbol"),
        side: formData.get("side"),
        order_type: formData.get("order_type"),
        amount: formData.get("amount"),
        price: formData.get("price"),
      };
      const paramsRaw = formData.get("params");
      const params = parseParams(paramsRaw);
      if (params) {
        payload.params = params;
      }
      showStatus(orderStatus, "Submitting order...");
      try {
        const response = await fetch(`/api/trading/accounts/${encodeURIComponent(accountName)}/orders`, {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!response.ok) {
          const errorPayload = await response.json().catch(() => ({}));
          throw new Error(errorPayload.detail || `Order failed (${response.status})`);
        }
        showStatus(orderStatus, "Order submitted.", "success");
        form.reset();
        await refreshSnapshot();
      } catch (error) {
        console.error(error);
        showStatus(orderStatus, error.message, "error");
      }
    });

    document.getElementById("stop-loss-form").addEventListener("submit", async (event) => {
      event.preventDefault();
      const threshold = Number(document.getElementById("stop-loss-threshold").value);
      if (!Number.isFinite(threshold) || threshold <= 0) {
        showStatus(stopLossStatus, "Threshold must be greater than zero.", "error");
        return;
      }
      showStatus(stopLossStatus, "Updating stop loss...");
      try {
        const response = await fetch("/api/trading/portfolio/stop-loss", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ threshold_pct: threshold }),
        });
        if (!response.ok) {
          const errorPayload = await response.json().catch(() => ({}));
          throw new Error(errorPayload.detail || `Update failed (${response.status})`);
        }
        showStatus(stopLossStatus, "Stop loss updated.", "success");
        await refreshSnapshot();
      } catch (error) {
        console.error(error);
        showStatus(stopLossStatus, error.message, "error");
      }
    });

    document.getElementById("stop-loss-clear").addEventListener("click", async () => {
      showStatus(stopLossStatus, "Clearing stop loss...");
      try {
        const response = await fetch("/api/trading/portfolio/stop-loss", {
          method: "DELETE",
          credentials: "include",
        });
        if (!response.ok) {
          const errorPayload = await response.json().catch(() => ({}));
          throw new Error(errorPayload.detail || `Unable to clear (${response.status})`);
        }
        showStatus(stopLossStatus, "Stop loss cleared.", "success");
        await refreshSnapshot();
      } catch (error) {
        console.error(error);
        showStatus(stopLossStatus, error.message, "error");
      }
    });

    document.addEventListener("click", async (event) => {
      const cancelButton = event.target.closest("[data-cancel-order]");
      if (cancelButton) {
        const orderId = cancelButton.getAttribute("data-order-id");
        const symbol = cancelButton.getAttribute("data-symbol");
        showStatus(orderStatus, `Cancelling ${orderId || "order"}...`);
        try {
          const response = await fetch(
            `/api/trading/accounts/${encodeURIComponent(state.currentAccount)}/orders/${encodeURIComponent(orderId || "")}`,
            {
              method: "DELETE",
              credentials: "include",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ symbol }),
            }
          );
          if (!response.ok) {
            const errorPayload = await response.json().catch(() => ({}));
            throw new Error(errorPayload.detail || `Cancel failed (${response.status})`);
          }
          showStatus(orderStatus, "Order cancelled.", "success");
          await refreshSnapshot();
        } catch (error) {
          console.error(error);
          showStatus(orderStatus, error.message, "error");
        }
        return;
      }
      const closeButton = event.target.closest("[data-close-position]");
      if (closeButton) {
        const symbol = closeButton.getAttribute("data-symbol");
        showStatus(orderStatus, `Closing ${symbol}...`);
        try {
          const response = await fetch(
            `/api/trading/accounts/${encodeURIComponent(state.currentAccount)}/positions/${encodeURIComponent(symbol)}/close`,
            {
              method: "POST",
              credentials: "include",
            }
          );
          if (!response.ok) {
            const errorPayload = await response.json().catch(() => ({}));
            throw new Error(errorPayload.detail || `Close failed (${response.status})`);
          }
          showStatus(orderStatus, "Position close requested.", "success");
          await refreshSnapshot();
        } catch (error) {
          console.error(error);
          showStatus(orderStatus, error.message, "error");
        }
      }
    });

    refreshButton.addEventListener("click", async () => {
      showStatus(orderStatus, "Refreshing snapshot...");
      await refreshSnapshot();
      showStatus(orderStatus, "Snapshot updated.", "success");
    });

    renderAll();
    fetchOrderTypes(state.currentAccount);
  </script>
{% endblock %}
