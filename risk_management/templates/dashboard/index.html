{% extends "base.html" %}

{% block head %}{% endblock %}

{% block header_controls %}
  <div class="header-toolbar">
    <span class="badge">Logged in as {{ user }}</span>
    <button type="button" class="button secondary" data-open-trading>Trading controls</button>
    <button type="button" class="button danger" data-kill-portfolio>Kill portfolio</button>
    <div class="status-message" data-kill-status="__portfolio__" hidden></div>
    <form method="post" action="/logout">
      <button type="submit">Logout</button>
    </form>
  </div>
{% endblock %}

{% block content %}
  <nav class="view-nav" role="tablist" aria-label="Dashboard sections">
    <button
      type="button"
      class="view-nav__button active"
      role="tab"
      aria-selected="true"
      data-page-target="overview"
    >
      Overview
    </button>
    <button
      type="button"
      class="view-nav__button"
      role="tab"
      aria-selected="false"
      data-page-target="accounts"
    >
      Accounts
    </button>
    <button
      type="button"
      class="view-nav__button"
      role="tab"
      aria-selected="false"
      data-page-target="trading"
    >
      Trading
    </button>
    <button
      type="button"
      class="view-nav__button"
      role="tab"
      aria-selected="false"
      data-page-target="alerts"
    >
      Alerts &amp; notifications
    </button>
    {% if grafana_dashboards %}
      <button
        type="button"
        class="view-nav__button"
        role="tab"
        aria-selected="false"
        data-page-target="analytics"
      >
        Analytics
      </button>
    {% endif %}
  </nav>

  <div class="page-sections">
    <div class="page-section" data-page-section="overview">
      <section class="card" data-portfolio>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 style="margin-bottom: 0.5rem;">Portfolio overview</h2>
            <p style="color: var(--muted); margin: 0;">
              Snapshot generated at <strong data-overview-generated>{{ snapshot.generated_at }}</strong>
            </p>
          </div>
          <span class="badge {% if snapshot.alerts %}alert{% else %}ok{% endif %}" data-alert-summary>
            {% if snapshot.alerts %}
              {{ snapshot.alerts|length }} active alert{{ 's' if snapshot.alerts|length != 1 else '' }}
            {% else %}
              All clear
            {% endif %}
          </span>
        </div>
        <div class="metrics" style="margin-top: 1.5rem;">
          <div class="metric">
            <span class="label">Total Balance</span>
            <span class="value">{{ snapshot.portfolio.balance|currency }}</span>
          </div>
          <div class="metric">
            <span class="label">Daily Realised PnL</span>
            <span class="value {% if snapshot.portfolio.daily_realized_pnl >= 0 %}gain{% else %}loss{% endif %}">
              {{ snapshot.portfolio.daily_realized_pnl|currency }}
            </span>
          </div>
          <div class="metric">
            <span class="label">Gross Exposure</span>
            <span class="value">{{ snapshot.portfolio.gross_exposure|currency }}</span>
            <span class="subvalue">{{ snapshot.portfolio.gross_exposure_pct|pct }}</span>
          </div>
          <div class="metric">
            <span class="label">Net Exposure</span>
            <span class="value {% if snapshot.portfolio.net_exposure >= 0 %}gain{% else %}loss{% endif %}">{{ snapshot.portfolio.net_exposure|currency }}</span>
            <span class="subvalue {% if snapshot.portfolio.net_exposure_pct >= 0 %}gain{% else %}loss{% endif %}">{{ snapshot.portfolio.net_exposure_pct|pct }}</span>
          </div>
        </div>
        {% set portfolio_performance = snapshot.portfolio.performance if snapshot.portfolio.performance is defined else None %}
        {% if portfolio_performance %}
          <div class="metrics" style="margin-top: 1.5rem;">
            {% set daily = portfolio_performance.daily %}
            {% set daily_class = 'gain' if daily is not none and daily >= 0 else ('loss' if daily is not none else '') %}
            <div class="metric">
              <span class="label">Daily PnL (4pm)</span>
              <span class="value {{ daily_class }}">{% if daily is not none %}{{ daily|currency }}{% else %}-{% endif %}</span>
              {% set daily_since = portfolio_performance.since.daily if portfolio_performance.since is defined and portfolio_performance.since %}
              <span class="subvalue">{% if daily_since %}Since {{ daily_since }}{% else %}&nbsp;{% endif %}</span>
            </div>
            {% set weekly = portfolio_performance.weekly %}
            {% set weekly_class = 'gain' if weekly is not none and weekly >= 0 else ('loss' if weekly is not none else '') %}
            <div class="metric">
              <span class="label">Weekly PnL</span>
              <span class="value {{ weekly_class }}">{% if weekly is not none %}{{ weekly|currency }}{% else %}-{% endif %}</span>
              {% set weekly_since = portfolio_performance.since.weekly if portfolio_performance.since is defined and portfolio_performance.since %}
              <span class="subvalue">{% if weekly_since %}Since {{ weekly_since }}{% else %}&nbsp;{% endif %}</span>
            </div>
            {% set monthly = portfolio_performance.monthly %}
            {% set monthly_class = 'gain' if monthly is not none and monthly >= 0 else ('loss' if monthly is not none else '') %}
            <div class="metric">
              <span class="label">Monthly PnL</span>
              <span class="value {{ monthly_class }}">{% if monthly is not none %}{{ monthly|currency }}{% else %}-{% endif %}</span>
              {% set monthly_since = portfolio_performance.since.monthly if portfolio_performance.since is defined and portfolio_performance.since %}
              <span class="subvalue">{% if monthly_since %}Since {{ monthly_since }}{% else %}&nbsp;{% endif %}</span>
            </div>
          </div>
        {% endif %}
        {% set portfolio_vol = snapshot.portfolio.volatility if snapshot.portfolio.volatility is defined else {} %}
        {% set portfolio_funding = snapshot.portfolio.funding_rates if snapshot.portfolio.funding_rates is defined else {} %}
        {% if portfolio_vol or portfolio_funding %}
          <div class="table-wrapper" style="margin-top: 1.5rem;">
            <table class="compact">
              <thead>
                <tr>
                  <th>Window</th>
                  <th>Volatility</th>
                  <th>Funding rate</th>
                </tr>
              </thead>
              <tbody>
                {% for window in ["4h", "24h", "3d", "7d"] %}
                  <tr>
                    <td>{{ window }}</td>
                    {% set vol_value = portfolio_vol.get(window) if portfolio_vol else None %}
                    {% set funding_value = portfolio_funding.get(window) if portfolio_funding else None %}
                    <td>{% if vol_value is not none %}{{ vol_value|pct }}{% else %}-{% endif %}</td>
                    <td>{% if funding_value is not none %}{{ funding_value|pct }}{% else %}-{% endif %}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
            <div class="table-pagination" aria-label="Portfolio metrics">
              <button type="button" disabled>Prev</button>
              <span>4 rows</span>
              <button type="button" disabled>Next</button>
            </div>
          </div>
        {% endif %}
        {% if snapshot.portfolio.symbols %}
          <div class="table-wrapper" style="margin-top: 1.5rem;">
            <table>
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Gross Exposure</th>
                  <th>Gross %</th>
                  <th>Net Exposure</th>
                  <th>Net %</th>
                  <th>Vol 4h</th>
                  <th>Vol 24h</th>
                  <th>Vol 3d</th>
                  <th>Vol 7d</th>
                  <th>Fund 4h</th>
                  <th>Fund 24h</th>
                  <th>Fund 3d</th>
                  <th>Fund 7d</th>
                </tr>
              </thead>
              <tbody>
                {% for entry in snapshot.portfolio.symbols %}
                  {% set symbol_vol = entry.volatility if entry.volatility is defined else {} %}
                  {% set symbol_funding = entry.funding_rates if entry.funding_rates is defined else {} %}
                  <tr>
                    <td>{{ entry.symbol }}</td>
                    <td>{{ entry.gross_notional|currency }}</td>
                    <td>{{ entry.gross_pct|pct }}</td>
                    <td class="{% if entry.net_notional >= 0 %}gain{% else %}loss{% endif %}">{{ entry.net_notional|currency }}</td>
                    <td class="{% if entry.net_pct >= 0 %}gain{% else %}loss{% endif %}">{{ entry.net_pct|pct }}</td>
                    <td>{% if symbol_vol and symbol_vol.get("4h") is not none %}{{ symbol_vol.get("4h")|pct }}{% else %}-{% endif %}</td>
                    <td>{% if symbol_vol and symbol_vol.get("24h") is not none %}{{ symbol_vol.get("24h")|pct }}{% else %}-{% endif %}</td>
                    <td>{% if symbol_vol and symbol_vol.get("3d") is not none %}{{ symbol_vol.get("3d")|pct }}{% else %}-{% endif %}</td>
                    <td>{% if symbol_vol and symbol_vol.get("7d") is not none %}{{ symbol_vol.get("7d")|pct }}{% else %}-{% endif %}</td>
                    <td>{% if symbol_funding and symbol_funding.get("4h") is not none %}{{ symbol_funding.get("4h")|pct }}{% else %}-{% endif %}</td>
                    <td>{% if symbol_funding and symbol_funding.get("24h") is not none %}{{ symbol_funding.get("24h")|pct }}{% else %}-{% endif %}</td>
                    <td>{% if symbol_funding and symbol_funding.get("3d") is not none %}{{ symbol_funding.get("3d")|pct }}{% else %}-{% endif %}</td>
                    <td>{% if symbol_funding and symbol_funding.get("7d") is not none %}{{ symbol_funding.get("7d")|pct }}{% else %}-{% endif %}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
            <div class="table-pagination" aria-label="Portfolio exposures">
              <button type="button" disabled>Prev</button>
              <span>
                {{ snapshot.portfolio.symbols|length }} row{{ 's' if snapshot.portfolio.symbols|length != 1 else '' }}
              </span>
              <button type="button" disabled>Next</button>
            </div>
          </div>
        {% else %}
          <p style="color: var(--muted); margin-top: 1rem;">No active exposures.</p>
        {% endif %}
      </section>
    </div>

    <div class="page-section" data-page-section="accounts" hidden>
      <div class="accounts-controls" data-accounts-controls>
        <div class="accounts-controls__row">
          <label class="field">
            <span>Search</span>
            <input
              type="search"
              name="accounts-search"
              placeholder="Search account or symbol"
              autocomplete="off"
              data-accounts-search
            />
          </label>
          <label class="field">
            <span>Exposure filter</span>
            <select name="accounts-exposure" data-accounts-exposure>
              <option value="any">All accounts</option>
              <option value="gross">With gross exposure</option>
              <option value="net_long">Net long</option>
              <option value="net_short">Net short</option>
              <option value="flat">Flat</option>
            </select>
          </label>
          <label class="field">
            <span>Page size</span>
            <select name="accounts-page-size" data-accounts-page-size>
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </label>
        </div>
        <div class="accounts-controls__row">
          <div class="chip-group" role="group" aria-label="Hide empty sections">
            <button type="button" class="chip" data-hide-empty="exposures">Hide empty exposures</button>
            <button type="button" class="chip" data-hide-empty="positions">Hide empty positions</button>
            <button type="button" class="chip" data-hide-empty="orders">Hide empty orders</button>
          </div>
        </div>
        <div class="accounts-sort" role="group" aria-label="Sort accounts">
          <button type="button" class="accounts-sort__button" data-sort-key="name">
            Account
            <span aria-hidden="true">↕</span>
          </button>
          <button type="button" class="accounts-sort__button" data-sort-key="balance">
            Balance
            <span aria-hidden="true">↕</span>
          </button>
          <button type="button" class="accounts-sort__button" data-sort-key="gross">
            Gross exposure
            <span aria-hidden="true">↕</span>
          </button>
          <button type="button" class="accounts-sort__button" data-sort-key="net">
            Net exposure
            <span aria-hidden="true">↕</span>
          </button>
          <button type="button" class="accounts-sort__button" data-sort-key="unrealized">
            Unrealized PnL
            <span aria-hidden="true">↕</span>
          </button>
          <button type="button" class="accounts-sort__button" data-sort-key="daily_realized">
            Daily realised PnL
            <span aria-hidden="true">↕</span>
          </button>
        </div>
      </div>
      {% set accounts_meta = snapshot.accounts_meta if snapshot.accounts_meta is defined else {} %}
      {% set current_page = accounts_meta.page if accounts_meta.page is defined else 1 %}
      {% set total_pages = accounts_meta.pages if accounts_meta.pages is defined else 1 %}
      {% set page_size = accounts_meta.page_size if accounts_meta.page_size is defined else snapshot.accounts|length %}
      {% set filtered_total = accounts_meta.filtered if accounts_meta.filtered is defined else snapshot.accounts|length %}
      {% set start_index = ((current_page - 1) * page_size + 1) if filtered_total else 0 %}
      {% set end_index = (start_index + snapshot.accounts|length - 1) if filtered_total else 0 %}
      {% set sort_labels = {
        'name': 'Account',
        'balance': 'Balance',
        'gross': 'Gross exposure',
        'net': 'Net exposure',
        'unrealized': 'Unrealized PnL',
        'daily_realized': 'Daily realised PnL'
      } %}
      <div class="accounts-summary" data-accounts-summary>
        <span>
          {% if filtered_total %}
            Showing {{ start_index }}–{{ end_index }} of {{ filtered_total }} account{{ 's' if filtered_total != 1 else '' }}
          {% else %}
            No accounts match the selected filters.
          {% endif %}
        </span>
        <span>
          Sorted by {{ sort_labels.get(accounts_meta.sort_key, 'Balance') }}
          ({{ 'ascending' if accounts_meta.sort_order == 'asc' else 'descending' }})
        </span>
      </div>
      <div data-accounts>
        {% for account in snapshot.accounts %}
          <section class="card" data-account="{{ account.name }}">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
              <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <h2 style="margin: 0;">{{ account.name }}</h2>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  <span class="badge">{{ account.positions|length }} position{{ 's' if account.positions|length != 1 else '' }}</span>
                  <span class="badge">{{ account.orders|length }} order{{ 's' if account.orders|length != 1 else '' }}</span>
                </div>
              </div>
              <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                <button type="button" class="button danger" data-kill-switch="{{ account.name }}">Kill switch</button>
                <div class="status-message" data-kill-status="{{ account.name }}" hidden></div>
              </div>
            </div>
            {% if account.message %}
              <div class="status">{{ account.message }}</div>
            {% endif %}
            <div class="metrics">
              <div class="metric">
                <span class="label">Balance</span>
                <span class="value">{{ account.balance|currency }}</span>
              </div>
              <div class="metric">
                <span class="label">Daily Realised PnL</span>
                <span class="value {% if account.daily_realized_pnl >= 0 %}gain{% else %}loss{% endif %}">{{ account.daily_realized_pnl|currency }}</span>
              </div>
              <div class="metric">
                <span class="label">Gross Exposure</span>
                <span class="value">{{ account.gross_exposure_notional|currency }}</span>
                <span class="subvalue">{{ account.gross_exposure|pct }}</span>
              </div>
              <div class="metric">
                <span class="label">Net Exposure</span>
                <span class="value {% if account.net_exposure_notional >= 0 %}gain{% else %}loss{% endif %}">{{ account.net_exposure_notional|currency }}</span>
                <span class="subvalue {% if account.net_exposure >= 0 %}gain{% else %}loss{% endif %}">{{ account.net_exposure|pct }}</span>
              </div>
              <div class="metric">
                <span class="label">Unrealized PnL</span>
                <span class="value {% if account.unrealized_pnl >= 0 %}gain{% else %}loss{% endif %}">{{ account.unrealized_pnl|currency }}</span>
              </div>
            </div>
            {% set account_performance = account.performance if account.performance is defined else None %}
            {% if account_performance %}
              <div class="metrics" style="margin-top: 1.5rem;">
                {% set daily = account_performance.daily %}
                {% set daily_class = 'gain' if daily is not none and daily >= 0 else ('loss' if daily is not none else '') %}
                <div class="metric">
                  <span class="label">Daily PnL (4pm)</span>
                  <span class="value {{ daily_class }}">{% if daily is not none %}{{ daily|currency }}{% else %}-{% endif %}</span>
                  {% set daily_since = account_performance.since.daily if account_performance.since is defined and account_performance.since %}
                  <span class="subvalue">{% if daily_since %}Since {{ daily_since }}{% else %}&nbsp;{% endif %}</span>
                </div>
                {% set weekly = account_performance.weekly %}
                {% set weekly_class = 'gain' if weekly is not none and weekly >= 0 else ('loss' if weekly is not none else '') %}
                <div class="metric">
                  <span class="label">Weekly PnL</span>
                  <span class="value {{ weekly_class }}">{% if weekly is not none %}{{ weekly|currency }}{% else %}-{% endif %}</span>
                  {% set weekly_since = account_performance.since.weekly if account_performance.since is defined and account_performance.since %}
                  <span class="subvalue">{% if weekly_since %}Since {{ weekly_since }}{% else %}&nbsp;{% endif %}</span>
                </div>
                {% set monthly = account_performance.monthly %}
                {% set monthly_class = 'gain' if monthly is not none and monthly >= 0 else ('loss' if monthly is not none else '') %}
                <div class="metric">
                  <span class="label">Monthly PnL</span>
                  <span class="value {{ monthly_class }}">{% if monthly is not none %}{{ monthly|currency }}{% else %}-{% endif %}</span>
                  {% set monthly_since = account_performance.since.monthly if account_performance.since is defined and account_performance.since %}
                  <span class="subvalue">{% if monthly_since %}Since {{ monthly_since }}{% else %}&nbsp;{% endif %}</span>
                </div>
              </div>
            {% endif %}
            {% if account.stop_loss %}
              {% set sl = account.stop_loss %}
              <div class="status" style="margin-top: 1rem;">
                Stop loss {% if sl.triggered %}<strong>triggered</strong>{% else %}active{% endif %} at
                {% if sl.threshold_pct is not none %}{{ sl.threshold_pct|round(2) }}%{% else %}?%{% endif %}.
                {% if sl.current_drawdown_pct is not none %}
                  Current drawdown {{ (sl.current_drawdown_pct * 100)|round(2) }}%.
                {% endif %}
                {% if sl.baseline_balance is not none %}
                  Baseline {{ sl.baseline_balance|currency }}.
                {% endif %}
                {% if sl.triggered_at %}
                  Triggered at {{ sl.triggered_at }}.
                {% endif %}
              </div>
            {% endif %}
            {% set account_vol = account.volatility if account.volatility is defined else {} %}
            {% set account_funding = account.funding_rates if account.funding_rates is defined else {} %}
            {% if account_vol or account_funding %}
              <div class="table-wrapper" style="margin-bottom: 1.5rem;">
                <table class="compact">
                  <thead>
                    <tr>
                      <th>Window</th>
                      <th>Volatility</th>
                      <th>Funding rate</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for window in ["4h", "24h", "3d", "7d"] %}
                      {% set vol_value = account_vol.get(window) if account_vol else None %}
                      {% set funding_value = account_funding.get(window) if account_funding else None %}
                      <tr>
                        <td>{{ window }}</td>
                        <td>{% if vol_value is not none %}{{ vol_value|pct }}{% else %}-{% endif %}</td>
                        <td>{% if funding_value is not none %}{{ funding_value|pct }}{% else %}-{% endif %}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endif %}
            {% if account.symbol_exposures %}
              <div class="table-wrapper" style="margin-bottom: 1.5rem;">
                <table>
                  <thead>
                    <tr>
                      <th>Symbol</th>
                      <th>Gross Exposure</th>
                      <th>Gross %</th>
                      <th>Net Exposure</th>
                      <th>Net %</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for exposure in account.symbol_exposures %}
                      <tr>
                        <td>{{ exposure.symbol }}</td>
                        <td>{{ exposure.gross_notional|currency }}</td>
                        <td>{{ exposure.gross_pct|pct }}</td>
                        <td class="{% if exposure.net_notional >= 0 %}gain{% else %}loss{% endif %}">{{ exposure.net_notional|currency }}</td>
                        <td class="{% if exposure.net_pct >= 0 %}gain{% else %}loss{% endif %}">{{ exposure.net_pct|pct }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
                <div class="table-pagination" aria-label="{{ account.name }} exposures">
                  <button type="button" disabled>Prev</button>
                  <span>
                    {{ account.symbol_exposures|length }} row{{ 's' if account.symbol_exposures|length != 1 else '' }}
                  </span>
                  <button type="button" disabled>Next</button>
                </div>
              </div>
            {% endif %}
              <div class="report-actions" style="margin: 1.5rem 0;">
                <button type="button" class="button secondary" data-generate-report="{{ account.name }}">Generate report</button>
                <div class="status-message" data-report-status="{{ account.name }}" hidden></div>
              </div>
            {% if account.positions %}
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Symbol</th>
                      <th>Side</th>
                      <th>Notional</th>
                      <th>Exposure %</th>
                      <th>PnL</th>
                      <th>Daily realised PnL</th>
                      <th>Entry</th>
                      <th>Mark</th>
                      <th>Liq.</th>
                      <th>Max DD</th>
                      <th>TP</th>
                      <th>SL</th>
                      <th>Vol 4h</th>
                      <th>Vol 24h</th>
                      <th>Vol 3d</th>
                      <th>Vol 7d</th>
                      <th>Fund 4h</th>
                      <th>Fund 24h</th>
                      <th>Fund 3d</th>
                      <th>Fund 7d</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for position in account.positions %}
                      {% set position_vol = position.volatility if position.volatility is defined else {} %}
                      {% set position_funding = position.funding_rates if position.funding_rates is defined else {} %}
                      <tr>
                        <td>{{ position.symbol }}</td>
                        <td>{{ position.side }}</td>
                        <td>{{ position.notional|currency }}</td>
                        <td>{{ position.exposure|pct }}</td>
                        <td class="{% if position.unrealized_pnl >= 0 %}gain{% else %}loss{% endif %}">{{ position.unrealized_pnl|currency }} ({{ position.pnl_pct|pct }})</td>
                        <td class="{% if position.daily_realized_pnl >= 0 %}gain{% else %}loss{% endif %}">{{ position.daily_realized_pnl|currency }}</td>
                        <td>{{ position.entry_price|currency }}</td>
                        <td>{{ position.mark_price|currency }}</td>
                        <td>{% if position.liquidation_price is not none %}{{ position.liquidation_price|currency }}{% else %}-{% endif %}</td>
                        <td>{% if position.max_drawdown_pct is not none %}{{ position.max_drawdown_pct|pct }}{% else %}-{% endif %}</td>
                        <td>{% if position.take_profit_price is not none %}{{ position.take_profit_price|currency }}{% else %}-{% endif %}</td>
                        <td>{% if position.stop_loss_price is not none %}{{ position.stop_loss_price|currency }}{% else %}-{% endif %}</td>
                        <td>{% if position_vol and position_vol.get("4h") is not none %}{{ position_vol.get("4h")|pct }}{% else %}-{% endif %}</td>
                        <td>{% if position_vol and position_vol.get("24h") is not none %}{{ position_vol.get("24h")|pct }}{% else %}-{% endif %}</td>
                        <td>{% if position_vol and position_vol.get("3d") is not none %}{{ position_vol.get("3d")|pct }}{% else %}-{% endif %}</td>
                        <td>{% if position_vol and position_vol.get("7d") is not none %}{{ position_vol.get("7d")|pct }}{% else %}-{% endif %}</td>
                        <td>{% if position_funding and position_funding.get("4h") is not none %}{{ position_funding.get("4h")|pct }}{% else %}-{% endif %}</td>
                        <td>{% if position_funding and position_funding.get("24h") is not none %}{{ position_funding.get("24h")|pct }}{% else %}-{% endif %}</td>
                        <td>{% if position_funding and position_funding.get("3d") is not none %}{{ position_funding.get("3d")|pct }}{% else %}-{% endif %}</td>
                        <td>{% if position_funding and position_funding.get("7d") is not none %}{{ position_funding.get("7d")|pct }}{% else %}-{% endif %}</td>
                        <td>
                          <div style="display: flex; flex-direction: column; gap: 0.35rem; min-width: 9rem;">
                            <button
                              type="button"
                              class="button danger small"
                              data-position-kill
                              data-position-account="{{ account.name }}"
                              data-position-symbol="{{ position.symbol }}"
                            >
                              Kill position
                            </button>
                            <div
                              class="status-message"
                              data-position-status="{{ account.name }}::{{ position.symbol }}"
                              hidden
                            ></div>
                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
                <div class="table-pagination" aria-label="{{ account.name }} positions">
                  <button type="button" disabled>Prev</button>
                  <span>
                    {{ account.positions|length }} row{{ 's' if account.positions|length != 1 else '' }}
                  </span>
                  <button type="button" disabled>Next</button>
                </div>
              </div>
            {% else %}
              <p style="color: var(--muted);">No open positions.</p>
            {% endif %}
            {% if account.orders %}
              <h3 style="margin-top: 1.5rem;">Open orders</h3>
              <div class="table-wrapper" style="overflow-x: auto;">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Symbol</th>
                      <th>Side</th>
                      <th>Type</th>
                      <th>Price</th>
                      <th>Amount</th>
                      <th>Remaining</th>
                      <th>Status</th>
                      <th>Reduce only</th>
                      <th>Notional</th>
                      <th>Stop price</th>
                      <th>Created</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for order in account.orders %}
                      <tr>
                        <td>{{ order.order_id or '-' }}</td>
                        <td>{{ order.symbol }}</td>
                        <td>{{ order.side }}</td>
                        <td>{{ order.type }}</td>
                        <td>{{ order.price|currency if order.price is not none else '-' }}</td>
                        <td>{{ order.amount if order.amount is not none else '-' }}</td>
                        <td>{{ order.remaining if order.remaining is not none else '-' }}</td>
                        <td>{{ order.status }}</td>
                        <td>{{ 'Yes' if order.reduce_only else 'No' }}</td>
                        <td>{{ order.notional|currency if order.notional is not none else '-' }}</td>
                        <td>{{ order.stop_price|currency if order.stop_price is not none else '-' }}</td>
                        <td>{{ order.created_at or '-' }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
                <div class="table-pagination" aria-label="{{ account.name }} orders">
                  <button type="button" disabled>Prev</button>
                  <span>
                    {{ account.orders|length }} row{{ 's' if account.orders|length != 1 else '' }}
                  </span>
                  <button type="button" disabled>Next</button>
                </div>
              </div>
            {% else %}
              <p style="color: var(--muted);">No open orders.</p>
            {% endif %}
          </section>
        {% endfor %}
      </div>
      <div class="pagination" data-accounts-pagination>
        <button type="button" data-page="prev" {% if not accounts_meta.has_previous %}disabled{% endif %}>Previous</button>
        <span>Page {{ current_page }} of {{ total_pages }}</span>
        <button type="button" data-page="next" {% if not accounts_meta.has_next %}disabled{% endif %}>Next</button>
      </div>
    </div>

    <div class="page-section" data-page-section="trading" hidden>
      <section class="card" style="margin-bottom: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
          <div>
            <h2 style="margin: 0 0 0.5rem;">Trading controls</h2>
            <p style="margin: 0; color: var(--muted);">
              Manage orders and risk stops for connected accounts in real time.
            </p>
          </div>
          <button type="button" class="button secondary" id="refresh-button">Refresh</button>
        </div>
      </section>

      <section class="panel-grid" aria-live="polite">
        <section class="card" id="order-card">
          <h3 style="margin-top: 0;">Create order</h3>
          <form id="order-form" style="display: flex; flex-direction: column; gap: 1rem;">
            <div class="form-row">
              <div class="form-group">
                <label for="account-select">Account</label>
                <select id="account-select" name="account" required></select>
              </div>
              <div class="form-group">
                <label for="symbol-input">Symbol</label>
                <input id="symbol-input" name="symbol" placeholder="e.g. BTC/USDT" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="side-select">Side</label>
                <select id="side-select" name="side" required>
                  <option value="buy">Buy</option>
                  <option value="sell">Sell</option>
                </select>
              </div>
              <div class="form-group">
                <label for="type-select">Order type</label>
                <select id="type-select" name="order_type" required></select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="amount-input">Amount</label>
                <input id="amount-input" name="amount" type="number" step="any" min="0" required />
              </div>
              <div class="form-group">
                <label for="price-input">Price (optional for market)</label>
                <input id="price-input" name="price" type="number" step="any" min="0" />
              </div>
            </div>
            <div class="form-group">
              <label for="params-input">Additional params (JSON)</label>
              <textarea
                id="params-input"
                name="params"
                rows="3"
                placeholder="{\n  &quot;reduceOnly&quot;: true\n}"
              ></textarea>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
              <button type="submit" class="button">Submit order</button>
              <div class="status-message" id="order-status" hidden></div>
            </div>
          </form>
        </section>

        <section class="card" id="stop-loss-card">
          <h3 style="margin-top: 0;">Portfolio stop loss</h3>
          <p style="color: var(--muted);" id="stop-loss-summary"></p>
          <form id="stop-loss-form" style="display: flex; flex-direction: column; gap: 1rem;">
            <div class="form-row">
              <div class="form-group">
                <label for="stop-loss-threshold">Drawdown threshold (%)</label>
                <input id="stop-loss-threshold" name="threshold" type="number" step="0.1" min="0" required />
              </div>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
              <button type="submit" class="button">Set threshold</button>
              <button type="button" class="button secondary" id="stop-loss-clear">Clear</button>
              <div class="status-message" id="stop-loss-status" hidden></div>
            </div>
          </form>
        </section>

        <section class="card" id="account-stop-loss-card">
          <h3 style="margin-top: 0;">Account stop loss</h3>
          <p style="color: var(--muted);" id="account-stop-loss-summary"></p>
          <form id="account-stop-loss-form" style="display: flex; flex-direction: column; gap: 1rem;">
            <div class="form-row">
              <div class="form-group">
                <label for="account-stop-loss-threshold">Drawdown threshold (%)</label>
                <input
                  id="account-stop-loss-threshold"
                  name="threshold"
                  type="number"
                  step="0.1"
                  min="0"
                  required
                />
              </div>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
              <button type="submit" class="button">Set threshold</button>
              <button type="button" class="button secondary" id="account-stop-loss-clear">Clear</button>
              <div class="status-message" id="account-stop-loss-status" hidden></div>
            </div>
          </form>
        </section>
      </section>

      <section class="card" style="margin-top: 1.5rem;" id="positions-card">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
          <h3 style="margin: 0;">Positions</h3>
          <span id="positions-summary" style="color: var(--muted);"></span>
          <button type="button" class="button secondary small" id="close-all-positions">Close all positions</button>
        </div>
        <div class="table-wrapper">
          <table id="positions-table">
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Side</th>
                <th>Notional</th>
                <th>Exposure %</th>
                <th>Unrealised PnL</th>
                <th>Daily realised PnL</th>
                <th>Entry</th>
                <th>Mark</th>
                <th>Liq.</th>
                <th>Max DD</th>
                <th>TP</th>
                <th>SL</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="card" style="margin-top: 1.5rem;" id="orders-card">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
          <h3 style="margin: 0;">Open orders</h3>
          <span id="orders-summary" style="color: var(--muted);"></span>
          <button type="button" class="button secondary small" id="cancel-all-orders">Cancel all orders</button>
        </div>
        <div class="table-wrapper">
          <table id="orders-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Symbol</th>
                <th>Side</th>
                <th>Type</th>
                <th>Price</th>
                <th>Amount</th>
                <th>Remaining</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>

    <div class="page-section" data-page-section="alerts" hidden>
      <section class="card alerts">
        <h2>Alerts</h2>
        {% if snapshot.alerts %}
          <ul data-alerts>
            {% for alert in snapshot.alerts %}
              <li>{{ alert }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p data-alerts style="color: var(--muted);">No active alerts. All monitored metrics are within thresholds.</p>
        {% endif %}
      </section>

      <section class="card notifications">
        <h2>Notification channels</h2>
        {% if snapshot.notifications %}
          <ul data-notifications>
            {% for channel in snapshot.notifications %}
              <li>{{ channel }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p data-notifications style="color: var(--muted);">No notification channels configured.</p>
        {% endif %}
      </section>
    </div>

    {% if grafana_dashboards %}
      <div class="page-section" data-page-section="analytics" hidden>
        <section class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
            <div>
              <h2 style="margin-bottom: 0.25rem;">Performance analytics</h2>
              <p style="color: var(--muted); margin: 0;">Live Grafana dashboards embedded from your monitoring stack.</p>
            </div>
            <!-- Optional: add a last-refreshed badge target for JS if desired -->
          </div>
          <div class="grafana-grid" style="margin-top: 1.5rem;">
            {% for dashboard in grafana_dashboards %}
              <article class="grafana-panel">
                <div class="grafana-panel__meta">
                  <div>
                    <h3 style="margin: 0 0 0.25rem;">{{ dashboard.title }}</h3>
                    {% if dashboard.description %}
                      <p style="margin: 0; color: var(--muted); font-size: 0.9rem;">{{ dashboard.description }}</p>
                    {% endif %}
                  </div>
                  <a class="button secondary" href="{{ dashboard.url }}" target="_blank" rel="noopener">
                    Open in Grafana
                  </a>
                </div>
                <iframe
                  src="{{ dashboard.url }}"
                  title="{{ dashboard.title }}"
                  height="{{ dashboard.height }}"
                  loading="lazy"
                  referrerpolicy="no-referrer-when-downgrade"
                  allowfullscreen
                ></iframe>
              </article>
            {% endfor %}
          </div>
        </section>
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block generated_at %}{{ snapshot.generated_at }}{% endblock %}

{% block scripts %}
  <script>
    const REFRESH_INTERVAL_MS = 10000;
    const DEFAULT_PAGE = "overview";
    const STORAGE_KEY = "risk-dashboard.activePage";
    const METRIC_WINDOWS = ["4h", "24h", "3d", "7d"];
    const DEFAULT_SORT_KEY = "balance";
    const DEFAULT_SORT_ORDER = "desc";
    const SORT_LABELS = {
      name: "Account",
      balance: "Balance",
      gross: "Gross exposure",
      net: "Net exposure",
      unrealized: "Unrealized PnL",
      daily_realized: "Daily realised PnL",
    };
    const DEFAULT_ACCOUNTS_STATE = {
      search: "",
      exposure: "any",
      hideEmpty: {
        exposures: false,
        positions: false,
        orders: false,
      },
      sortKey: DEFAULT_SORT_KEY,
      sortOrder: DEFAULT_SORT_ORDER,
      page: 1,
      pageSize: 25,
    };

    const loadPersistedState = () => {
      const baseState = {
        activePage: DEFAULT_PAGE,
        accounts: { ...DEFAULT_ACCOUNTS_STATE },
      };
      try {
        const stored = window.localStorage.getItem(STORAGE_KEY);
        if (!stored) {
          return baseState;
        }
        let parsed;
        try {
          parsed = JSON.parse(stored);
        } catch (error) {
          if (typeof stored === "string") {
            return { ...baseState, activePage: stored };
          }
          return baseState;
        }
        if (typeof parsed === "string") {
          return { ...baseState, activePage: parsed };
        }
        if (parsed && typeof parsed === "object") {
          const activePage = typeof parsed.activePage === "string" ? parsed.activePage : baseState.activePage;
          const accountsState = parsed.accounts && typeof parsed.accounts === "object" ? parsed.accounts : {};
          return {
            activePage,
            accounts: {
              ...DEFAULT_ACCOUNTS_STATE,
              ...accountsState,
              hideEmpty: {
                ...DEFAULT_ACCOUNTS_STATE.hideEmpty,
                ...(accountsState.hideEmpty || {}),
              },
            },
          };
        }
      } catch (error) {
        console.debug("Failed to restore dashboard state", error);
      }
      return baseState;
    };

    let state = loadPersistedState();
    let latestSnapshot = null;
    let lastAccountsMeta = null;
    let isFetchingSnapshot = false;
    let fetchQueued = false;
    let searchDebounceHandle = null;

    const pageSections = Array.from(document.querySelectorAll("[data-page-section]"));
    const navButtons = Array.from(document.querySelectorAll("[data-page-target]"));
    const accountsSection = document.querySelector('[data-page-section="accounts"]');
    const accountsContainer = accountsSection ? accountsSection.querySelector("[data-accounts]") : null;
    const accountsControlsElement = document.querySelector("[data-accounts-controls]");
    const accountsSummaryEl = document.querySelector("[data-accounts-summary]");
    const paginationContainer = document.querySelector("[data-accounts-pagination]");
    const searchInput = accountsControlsElement ? accountsControlsElement.querySelector("[data-accounts-search]") : null;
    const exposureSelect = accountsControlsElement ? accountsControlsElement.querySelector("[data-accounts-exposure]") : null;
    const pageSizeSelect = accountsControlsElement ? accountsControlsElement.querySelector("[data-accounts-page-size]") : null;
    const hideEmptyChips = accountsControlsElement
      ? Array.from(accountsControlsElement.querySelectorAll("[data-hide-empty]"))
      : [];
    const sortButtons = accountsControlsElement
      ? Array.from(accountsControlsElement.querySelectorAll("[data-sort-key]"))
      : [];

    const persistState = () => {
      try {
        window.localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (error) {
        console.debug("Failed to persist dashboard state", error);
      }
    };

    const setActivePage = (page) => {
      const targetExists = pageSections.some(
        (section) => section.getAttribute("data-page-section") === page,
      );
      const targetPage = targetExists ? page : DEFAULT_PAGE;

      pageSections.forEach((section) => {
        const isActive = section.getAttribute("data-page-section") === targetPage;
        section.toggleAttribute("hidden", !isActive);
        section.setAttribute("aria-hidden", String(!isActive));
      });

      navButtons.forEach((button) => {
        const isActive = button.getAttribute("data-page-target") === targetPage;
        button.classList.toggle("active", isActive);
        button.setAttribute("aria-selected", String(isActive));
      });

      state.activePage = targetPage;
      persistState();
    };

    navButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const target = button.getAttribute("data-page-target");
        setActivePage(target || DEFAULT_PAGE);
      });
    });

    const tradingShortcut = document.querySelector("[data-open-trading]");
    if (tradingShortcut) {
      tradingShortcut.addEventListener("click", () => {
        setActivePage("trading");
      });
    }

    setActivePage(state.activePage || DEFAULT_PAGE);

    const updateSortButtons = () => {
      sortButtons.forEach((button) => {
        const key = button.getAttribute("data-sort-key");
        const indicator = button.querySelector("span");
        const isActive = key === state.accounts.sortKey;
        button.dataset.active = String(isActive);
        if (indicator) {
          indicator.textContent = isActive
            ? state.accounts.sortOrder === "asc"
              ? "↑"
              : "↓"
            : "↕";
        }
      });
    };

    const updateHideEmptyChips = () => {
      hideEmptyChips.forEach((chip) => {
        const key = chip.getAttribute("data-hide-empty");
        const pressed = Boolean(state.accounts.hideEmpty?.[key]);
        chip.classList.toggle("active", pressed);
        chip.setAttribute("aria-pressed", String(pressed));
      });
    };

    const applyAccountsControlsFromState = () => {
      if (searchInput && searchInput.value !== state.accounts.search) {
        searchInput.value = state.accounts.search;
      }
      if (exposureSelect) {
        const targetValue = state.accounts.exposure || "any";
        if (exposureSelect.value !== targetValue) {
          exposureSelect.value = targetValue;
        }
      }
      if (pageSizeSelect) {
        const pageSizeValue = String(state.accounts.pageSize || DEFAULT_ACCOUNTS_STATE.pageSize);
        if (pageSizeSelect.value !== pageSizeValue) {
          pageSizeSelect.value = pageSizeValue;
        }
      }
      updateHideEmptyChips();
      updateSortButtons();
    };

    applyAccountsControlsFromState();

    const formatCurrency = (value) => {
      const number = Number(value || 0);
      return new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(number);
    };

    const formatPrice = (value) => {
      if (value === null || value === undefined || Number.isNaN(Number(value))) {
        return "-";
      }
      return Number(value).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 6 });
    };

    const formatPct = (value) => {
      const number = Number(value || 0) * 100;
      return `${number.toFixed(2)}%`;
    };

    const tradingModule = (() => {
      const initialSnapshot = {{ snapshot | tojson | safe }};
      const state = {
        snapshot: initialSnapshot,
        currentAccount:
          (Array.isArray(initialSnapshot.accounts) && initialSnapshot.accounts[0]?.name) || "",
        orderTypes: new Map(),
      };

      const elements = {
        accountSelect: document.getElementById("account-select"),
        typeSelect: document.getElementById("type-select"),
        orderStatus: document.getElementById("order-status"),
        positionsTableBody: document.querySelector("#positions-table tbody"),
        ordersTableBody: document.querySelector("#orders-table tbody"),
        positionsSummary: document.getElementById("positions-summary"),
        ordersSummary: document.getElementById("orders-summary"),
        stopLossSummary: document.getElementById("stop-loss-summary"),
        stopLossStatus: document.getElementById("stop-loss-status"),
        stopLossThreshold: document.getElementById("stop-loss-threshold"),
        accountStopLossSummary: document.getElementById("account-stop-loss-summary"),
        accountStopLossStatus: document.getElementById("account-stop-loss-status"),
        accountStopLossThreshold: document.getElementById("account-stop-loss-threshold"),
        accountStopLossClear: document.getElementById("account-stop-loss-clear"),
        orderForm: document.getElementById("order-form"),
        stopLossForm: document.getElementById("stop-loss-form"),
        accountStopLossForm: document.getElementById("account-stop-loss-form"),
        refreshButton: document.getElementById("refresh-button"),
        cancelAllOrdersButton: document.getElementById("cancel-all-orders"),
        closeAllPositionsButton: document.getElementById("close-all-positions"),
        stopLossClearButton: document.getElementById("stop-loss-clear"),
      };

      const showStatus = (element, message, variant = "info") => {
        if (!element) return;
        element.hidden = !message;
        element.textContent = message || "";
        element.classList.remove("success", "error");
        if (variant === "success") {
          element.classList.add("success");
        } else if (variant === "error") {
          element.classList.add("error");
        }
      };

      const parseParams = (raw) => {
        if (!raw) {
          return null;
        }
        try {
          const parsed = JSON.parse(raw);
          return typeof parsed === "object" && parsed !== null ? parsed : null;
        } catch (error) {
          return null;
        }
      };

      const renderAccountOptions = () => {
        const select = elements.accountSelect;
        if (!select) {
          return;
        }
        const accounts = Array.isArray(state.snapshot.accounts) ? state.snapshot.accounts : [];
        if (!accounts.some((account) => account.name === state.currentAccount)) {
          state.currentAccount = accounts.length > 0 ? accounts[0].name : "";
        }
        select.innerHTML = accounts
          .map((account) => {
            const selected = account.name === state.currentAccount ? "selected" : "";
            return `<option value="${account.name}" ${selected}>${account.name}</option>`;
          })
          .join("");
      };

      const renderOrderTypes = () => {
        const select = elements.typeSelect;
        if (!select) {
          return;
        }
        const types = state.orderTypes.get(state.currentAccount) || [];
        const fallback = types.length === 0 ? ["limit", "market"] : types;
        select.innerHTML = fallback.map((type) => `<option value="${type}">${type}</option>`).join("");
      };

      const renderPositions = () => {
        const tbody = elements.positionsTableBody;
        if (!tbody) {
          return;
        }
        const accounts = Array.isArray(state.snapshot.accounts) ? state.snapshot.accounts : [];
        const account = accounts.find((item) => item.name === state.currentAccount);
        const positions = account && Array.isArray(account.positions) ? account.positions : [];
        if (elements.positionsSummary) {
          elements.positionsSummary.textContent = `${positions.length} position${positions.length === 1 ? "" : "s"}`;
        }
        tbody.innerHTML = positions
          .map((position) => {
            const pnlClass = Number(position.unrealized_pnl) >= 0 ? "gain" : "loss";
            const realizedClass = Number(position.daily_realized_pnl) >= 0 ? "gain" : "loss";
            const liquidation =
              position.liquidation_price !== null && position.liquidation_price !== undefined
                ? formatCurrency(position.liquidation_price)
                : "-";
            const maxDrawdown =
              position.max_drawdown_pct !== null && position.max_drawdown_pct !== undefined
                ? formatPct(position.max_drawdown_pct)
                : "-";
            const takeProfit =
              position.take_profit_price !== null && position.take_profit_price !== undefined
                ? formatCurrency(position.take_profit_price)
                : "-";
            const stopLossPrice =
              position.stop_loss_price !== null && position.stop_loss_price !== undefined
                ? formatCurrency(position.stop_loss_price)
                : "-";
            return `
              <tr>
                <td>${position.symbol}</td>
                <td>${position.side}</td>
                <td>${formatCurrency(position.notional)}</td>
                <td>${formatPct(position.exposure)}</td>
                <td class="${pnlClass}">${formatCurrency(position.unrealized_pnl)}</td>
                <td class="${realizedClass}">${formatCurrency(position.daily_realized_pnl)}</td>
                <td>${formatCurrency(position.entry_price)}</td>
                <td>${formatCurrency(position.mark_price)}</td>
                <td>${liquidation}</td>
                <td>${maxDrawdown}</td>
                <td>${takeProfit}</td>
                <td>${stopLossPrice}</td>
                <td>
                  <div class="actions-column">
                    <button type="button" class="button danger small" data-close-position data-symbol="${position.symbol}">Close</button>
                  </div>
                </td>
              </tr>
            `;
          })
          .join("");
        if (positions.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="13" style="text-align: center; color: var(--muted);">No open positions.</td></tr>';
        }
      };

      const renderOrders = () => {
        const tbody = elements.ordersTableBody;
        if (!tbody) {
          return;
        }
        const accounts = Array.isArray(state.snapshot.accounts) ? state.snapshot.accounts : [];
        const account = accounts.find((item) => item.name === state.currentAccount);
        const orders = account && Array.isArray(account.orders) ? account.orders : [];
        if (elements.ordersSummary) {
          elements.ordersSummary.textContent = `${orders.length} order${orders.length === 1 ? "" : "s"}`;
        }
        tbody.innerHTML = orders
          .map((order) => {
            const orderId = order.order_id || "";
            const cancelAction = orderId
              ? `<button type="button" class="button danger small" data-cancel-order data-order-id="${orderId}" data-symbol="${order.symbol}">Cancel</button>`
              : '<span style="color: var(--muted);">N/A</span>';
            const price =
              order.price !== null && order.price !== undefined ? formatCurrency(order.price) : "-";
            const amount = order.amount ?? "-";
            const remaining = order.remaining ?? "-";
            const status = order.status || "-";
            return `
              <tr>
                <td>${orderId || "-"}</td>
                <td>${order.symbol}</td>
                <td>${order.side}</td>
                <td>${order.type}</td>
                <td>${price}</td>
                <td>${amount}</td>
                <td>${remaining}</td>
                <td>${status}</td>
                <td>
                  <div class="actions-column">
                    ${cancelAction}
                  </div>
                </td>
              </tr>
            `;
          })
          .join("");
        if (orders.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="9" style="text-align: center; color: var(--muted);">No open orders.</td></tr>';
        }
      };

      const renderPortfolioStopLoss = () => {
        if (!elements.stopLossSummary) {
          return;
        }
        const stopLoss = state.snapshot.portfolio_stop_loss;
        if (!stopLoss) {
          elements.stopLossSummary.textContent = "No active stop loss.";
          if (elements.stopLossThreshold) {
            elements.stopLossThreshold.value = "";
          }
          return;
        }
        const threshold = Number(stopLoss.threshold_pct ?? 0);
        const baseline =
          stopLoss.baseline_balance !== undefined && stopLoss.baseline_balance !== null
            ? formatCurrency(stopLoss.baseline_balance)
            : "-";
        const currentBalance =
          stopLoss.current_balance !== undefined && stopLoss.current_balance !== null
            ? formatCurrency(stopLoss.current_balance)
            : "-";
        const drawdown = Number(stopLoss.current_drawdown_pct);
        const drawdownStr = Number.isFinite(drawdown) ? `${(drawdown * 100).toFixed(2)}%` : "-";
        const triggered = stopLoss.triggered ? "Triggered" : "Active";
        elements.stopLossSummary.textContent = `Status: ${triggered}. Threshold ${threshold.toFixed(
          2,
        )}%. Baseline ${baseline}, current ${currentBalance}, drawdown ${drawdownStr}.`;
        if (!stopLoss.triggered && threshold > 0 && elements.stopLossThreshold) {
          elements.stopLossThreshold.value = threshold;
        }
      };

      const renderAccountStopLoss = () => {
        if (!elements.accountStopLossSummary) {
          return;
        }
        const accounts = Array.isArray(state.snapshot.accounts) ? state.snapshot.accounts : [];
        const account = accounts.find((item) => item.name === state.currentAccount);
        if (!account) {
          elements.accountStopLossSummary.textContent = "No account selected.";
          if (elements.accountStopLossThreshold) {
            elements.accountStopLossThreshold.value = "";
          }
          return;
        }
        const stopLoss =
          account.stop_loss || (state.snapshot.account_stop_losses && state.snapshot.account_stop_losses[account.name]);
        if (!stopLoss) {
          elements.accountStopLossSummary.textContent = `No active stop loss for ${account.name}.`;
          if (elements.accountStopLossThreshold) {
            elements.accountStopLossThreshold.value = "";
          }
          return;
        }
        const threshold = Number(stopLoss.threshold_pct ?? 0);
        const baseline =
          stopLoss.baseline_balance !== undefined && stopLoss.baseline_balance !== null
            ? formatCurrency(stopLoss.baseline_balance)
            : "-";
        const currentBalance =
          stopLoss.current_balance !== undefined && stopLoss.current_balance !== null
            ? formatCurrency(stopLoss.current_balance)
            : formatCurrency(account.balance);
        const drawdown = Number(stopLoss.current_drawdown_pct ?? NaN);
        const drawdownStr = Number.isFinite(drawdown) ? `${(drawdown * 100).toFixed(2)}%` : "-";
        const status = stopLoss.triggered ? "Triggered" : "Active";
        elements.accountStopLossSummary.textContent = `${account.name}: ${status}. Threshold ${threshold.toFixed(
          2,
        )}%. Baseline ${baseline}, current ${currentBalance}, drawdown ${drawdownStr}.`;
        if (!stopLoss.triggered && threshold > 0 && elements.accountStopLossThreshold) {
          elements.accountStopLossThreshold.value = threshold;
        }
      };

      const renderAll = () => {
        renderAccountOptions();
        renderOrderTypes();
        renderPositions();
        renderOrders();
        renderPortfolioStopLoss();
        renderAccountStopLoss();
      };

      const fetchOrderTypes = async (accountName) => {
        if (!accountName) {
          return;
        }
        try {
          const response = await fetch(`/api/trading/accounts/${encodeURIComponent(accountName)}/order-types`, {
            credentials: "include",
          });
          if (!response.ok) {
            throw new Error(`Unable to load order types (${response.status})`);
          }
          const payload = await response.json();
          state.orderTypes.set(accountName, payload.order_types || []);
          renderOrderTypes();
        } catch (error) {
          console.error(error);
          showStatus(elements.orderStatus, error.message, "error");
        }
      };

      const updateSnapshot = (snapshot) => {
        state.snapshot = snapshot;
        const accounts = Array.isArray(snapshot.accounts) ? snapshot.accounts : [];
        if (!accounts.some((account) => account.name === state.currentAccount)) {
          state.currentAccount = accounts.length > 0 ? accounts[0].name : "";
        }
        renderAll();
      };

      const handleAccountChange = async (event) => {
        state.currentAccount = event.target.value;
        renderPositions();
        renderOrders();
        await fetchOrderTypes(state.currentAccount);
        renderAccountStopLoss();
      };

      if (elements.accountSelect) {
        elements.accountSelect.addEventListener("change", handleAccountChange);
      }

      if (elements.orderForm) {
        elements.orderForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const formData = new FormData(elements.orderForm);
          const accountName = formData.get("account");
          const payload = {
            symbol: formData.get("symbol"),
            side: formData.get("side"),
            order_type: formData.get("order_type"),
            amount: formData.get("amount"),
            price: formData.get("price"),
          };
          const paramsRaw = formData.get("params");
          const params = parseParams(paramsRaw);
          if (params) {
            payload.params = params;
          }
          showStatus(elements.orderStatus, "Submitting order...");
          try {
            const response = await fetch(`/api/trading/accounts/${encodeURIComponent(accountName)}/orders`, {
              method: "POST",
              credentials: "include",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (!response.ok) {
              const errorPayload = await response.json().catch(() => ({}));
              throw new Error(errorPayload.detail || `Order failed (${response.status})`);
            }
            showStatus(elements.orderStatus, "Order submitted.", "success");
            elements.orderForm.reset();
            await requestSnapshot();
          } catch (error) {
            console.error(error);
            showStatus(elements.orderStatus, error.message, "error");
          }
        });
      }

      if (elements.stopLossForm) {
        elements.stopLossForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const threshold = Number(elements.stopLossThreshold?.value);
          if (!Number.isFinite(threshold) || threshold <= 0) {
            showStatus(elements.stopLossStatus, "Threshold must be greater than zero.", "error");
            return;
          }
          showStatus(elements.stopLossStatus, "Updating stop loss...");
          try {
            const response = await fetch("/api/trading/portfolio/stop-loss", {
              method: "POST",
              credentials: "include",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ threshold_pct: threshold }),
            });
            if (!response.ok) {
              const errorPayload = await response.json().catch(() => ({}));
              throw new Error(errorPayload.detail || `Update failed (${response.status})`);
            }
            showStatus(elements.stopLossStatus, "Stop loss updated.", "success");
            await requestSnapshot();
          } catch (error) {
            console.error(error);
            showStatus(elements.stopLossStatus, error.message, "error");
          }
        });
      }

      if (elements.stopLossClearButton) {
        elements.stopLossClearButton.addEventListener("click", async () => {
          showStatus(elements.stopLossStatus, "Clearing stop loss...");
          try {
            const response = await fetch("/api/trading/portfolio/stop-loss", {
              method: "DELETE",
              credentials: "include",
            });
            if (!response.ok) {
              const errorPayload = await response.json().catch(() => ({}));
              throw new Error(errorPayload.detail || `Unable to clear (${response.status})`);
            }
            showStatus(elements.stopLossStatus, "Stop loss cleared.", "success");
            await requestSnapshot();
          } catch (error) {
            console.error(error);
            showStatus(elements.stopLossStatus, error.message, "error");
          }
        });
      }

      if (elements.accountStopLossForm) {
        elements.accountStopLossForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (!state.currentAccount) {
            showStatus(elements.accountStopLossStatus, "Select an account first.", "error");
            return;
          }
          const threshold = Number(elements.accountStopLossThreshold?.value);
          if (!Number.isFinite(threshold) || threshold <= 0) {
            showStatus(elements.accountStopLossStatus, "Threshold must be greater than zero.", "error");
            return;
          }
          showStatus(elements.accountStopLossStatus, "Updating stop loss...");
          try {
            const response = await fetch(
              `/api/trading/accounts/${encodeURIComponent(state.currentAccount)}/stop-loss`,
              {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ threshold_pct: threshold }),
              },
            );
            if (!response.ok) {
              const errorPayload = await response.json().catch(() => ({}));
              throw new Error(errorPayload.detail || `Update failed (${response.status})`);
            }
            showStatus(elements.accountStopLossStatus, "Stop loss updated.", "success");
            await requestSnapshot();
          } catch (error) {
            console.error(error);
            showStatus(elements.accountStopLossStatus, error.message, "error");
          }
        });
      }

      if (elements.accountStopLossClear) {
        elements.accountStopLossClear.addEventListener("click", async () => {
          if (!state.currentAccount) {
            showStatus(elements.accountStopLossStatus, "Select an account first.", "error");
            return;
          }
          showStatus(elements.accountStopLossStatus, "Clearing stop loss...");
          try {
            const response = await fetch(
              `/api/trading/accounts/${encodeURIComponent(state.currentAccount)}/stop-loss`,
              {
                method: "DELETE",
                credentials: "include",
              },
            );
            if (!response.ok) {
              const errorPayload = await response.json().catch(() => ({}));
              throw new Error(errorPayload.detail || `Unable to clear (${response.status})`);
            }
            showStatus(elements.accountStopLossStatus, "Stop loss cleared.", "success");
            await requestSnapshot();
          } catch (error) {
            console.error(error);
            showStatus(elements.accountStopLossStatus, error.message, "error");
          }
        });
      }

      document.addEventListener("click", async (event) => {
        const cancelButton = event.target.closest("[data-cancel-order]");
        if (cancelButton) {
          const orderId = cancelButton.getAttribute("data-order-id");
          const symbol = cancelButton.getAttribute("data-symbol");
          showStatus(elements.orderStatus, `Cancelling ${orderId || "order"}...`);
          try {
            const response = await fetch(
              `/api/trading/accounts/${encodeURIComponent(state.currentAccount)}/orders/${encodeURIComponent(orderId || "")}`,
              {
                method: "DELETE",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ symbol }),
              },
            );
            if (!response.ok) {
              const errorPayload = await response.json().catch(() => ({}));
              throw new Error(errorPayload.detail || `Cancel failed (${response.status})`);
            }
            showStatus(elements.orderStatus, "Order cancelled.", "success");
            await requestSnapshot();
          } catch (error) {
            console.error(error);
            showStatus(elements.orderStatus, error.message, "error");
          }
          return;
        }
        const closeButton = event.target.closest("[data-close-position]");
        if (closeButton) {
          const symbol = closeButton.getAttribute("data-symbol");
          showStatus(elements.orderStatus, `Closing ${symbol}...`);
          try {
            const response = await fetch(
              `/api/trading/accounts/${encodeURIComponent(state.currentAccount)}/positions/${encodeURIComponent(symbol)}/close`,
              {
                method: "POST",
                credentials: "include",
              },
            );
            if (!response.ok) {
              const errorPayload = await response.json().catch(() => ({}));
              throw new Error(errorPayload.detail || `Close failed (${response.status})`);
            }
            showStatus(elements.orderStatus, "Position close requested.", "success");
            await requestSnapshot();
          } catch (error) {
            console.error(error);
            showStatus(elements.orderStatus, error.message, "error");
          }
        }
      });

      if (elements.refreshButton) {
        elements.refreshButton.addEventListener("click", async () => {
          showStatus(elements.orderStatus, "Refreshing snapshot...");
          try {
            await requestSnapshot();
            showStatus(elements.orderStatus, "Snapshot updated.", "success");
          } catch (error) {
            console.error(error);
            showStatus(elements.orderStatus, error.message, "error");
          }
        });
      }

      if (elements.cancelAllOrdersButton) {
        elements.cancelAllOrdersButton.addEventListener("click", async () => {
          if (!state.currentAccount) {
            showStatus(elements.orderStatus, "Select an account first.", "error");
            return;
          }
          showStatus(elements.orderStatus, "Cancelling all orders...");
          try {
            const response = await fetch(
              `/api/trading/accounts/${encodeURIComponent(state.currentAccount)}/orders/cancel-all`,
              {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({}),
              },
            );
            if (!response.ok) {
              const errorPayload = await response.json().catch(() => ({}));
              throw new Error(errorPayload.detail || `Cancel failed (${response.status})`);
            }
            showStatus(elements.orderStatus, "All orders cancelled.", "success");
            await requestSnapshot();
          } catch (error) {
            console.error(error);
            showStatus(elements.orderStatus, error.message, "error");
          }
        });
      }

      if (elements.closeAllPositionsButton) {
        elements.closeAllPositionsButton.addEventListener("click", async () => {
          if (!state.currentAccount) {
            showStatus(elements.orderStatus, "Select an account first.", "error");
            return;
          }
          showStatus(elements.orderStatus, "Closing all positions...");
          try {
            const response = await fetch(
              `/api/trading/accounts/${encodeURIComponent(state.currentAccount)}/positions/close-all`,
              {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({}),
              },
            );
            if (!response.ok) {
              const errorPayload = await response.json().catch(() => ({}));
              throw new Error(errorPayload.detail || `Close failed (${response.status})`);
            }
            showStatus(elements.orderStatus, "Close requests submitted.", "success");
            await requestSnapshot();
          } catch (error) {
            console.error(error);
            showStatus(elements.orderStatus, error.message, "error");
          }
        });
      }

      renderAll();
      fetchOrderTypes(state.currentAccount);

      return { updateSnapshot };
    })();

    const isFiniteNumber = (value) => typeof value === "number" && Number.isFinite(value);

    const formatMetricValue = (value) => (isFiniteNumber(value) ? formatPct(value) : "-");

    const formatBytes = (value) => {
      const number = Number(value);
      if (!Number.isFinite(number) || number <= 0) {
        return "0 B";
      }
      const units = ["B", "KB", "MB", "GB", "TB"];
      const exponent = Math.min(Math.floor(Math.log(number) / Math.log(1024)), units.length - 1);
      const size = number / 1024 ** exponent;
      const precision = exponent === 0 ? 0 : 2;
      return `${size.toFixed(precision)} ${units[exponent]}`;
    };

    const renderTablePaginationFooter = (label, count) => `
      <div class="table-pagination" role="navigation" aria-label="${label}">
        <button type="button" disabled>Prev</button>
        <span>${count} row${count === 1 ? "" : "s"}</span>
        <button type="button" disabled>Next</button>
      </div>
    `;

    const updateAccountsSummary = (meta, visibleCount) => {
      if (!accountsSummaryEl) {
        return;
      }
      const filtered = Number(meta?.filtered ?? 0);
      const page = Number(meta?.page ?? state.accounts.page ?? 1);
      const pageSize = Number(meta?.page_size ?? state.accounts.pageSize ?? DEFAULT_ACCOUNTS_STATE.pageSize);
      let summaryText = "No accounts match the selected filters.";
      if (filtered && visibleCount) {
        const start = (page - 1) * pageSize + 1;
        const end = start + visibleCount - 1;
        summaryText = `Showing ${start}–${end} of ${filtered} account${filtered === 1 ? "" : "s"}`;
      }
      const sortKey = meta?.sort_key || state.accounts.sortKey || DEFAULT_SORT_KEY;
      const sortOrder = (meta?.sort_order || state.accounts.sortOrder || DEFAULT_SORT_ORDER).toLowerCase() === "asc"
        ? "ascending"
        : "descending";
      const sortLabel = SORT_LABELS[sortKey] || SORT_LABELS[DEFAULT_SORT_KEY];
      accountsSummaryEl.innerHTML = `
        <span>${summaryText}</span>
        <span>Sorted by ${sortLabel} (${sortOrder})</span>
      `;
    };

    const updateAccountsPagination = (meta) => {
      if (!paginationContainer) {
        return;
      }
      const page = Number(meta?.page ?? state.accounts.page ?? 1);
      const pages = Math.max(1, Number(meta?.pages ?? 1));
      const hasPrev = Boolean(meta?.has_previous ?? page > 1);
      const hasNext = Boolean(meta?.has_next ?? page < pages);
      paginationContainer.innerHTML = `
        <button type="button" data-page="prev"${hasPrev ? "" : " disabled"}>Previous</button>
        <span>Page ${page} of ${pages}</span>
        <button type="button" data-page="next"${hasNext ? "" : " disabled"}>Next</button>
      `;
    };

    const renderPortfolio = (snapshot) => {
      const portfolioSection = document.querySelector(
        '[data-page-section="overview"] [data-portfolio]',
      );
      if (!portfolioSection || !snapshot.portfolio) {
        return;
      }
      const portfolio = snapshot.portfolio;
      const symbolEntries = Array.isArray(portfolio.symbols) ? portfolio.symbols : [];
      const symbolRows = symbolEntries
        .map((entry) => {
          const volatility = entry.volatility || {};
          const funding = entry.funding_rates || {};
          return `
          <tr>
            <td>${entry.symbol}</td>
            <td>${formatCurrency(entry.gross_notional)}</td>
            <td>${formatPct(entry.gross_pct)}</td>
            <td class="${Number(entry.net_notional) >= 0 ? "gain" : "loss"}">${formatCurrency(entry.net_notional)}</td>
            <td class="${Number(entry.net_pct) >= 0 ? "gain" : "loss"}">${formatPct(entry.net_pct)}</td>
            ${METRIC_WINDOWS.map((window) => `<td>${formatMetricValue(volatility?.[window])}</td>`).join("")}
            ${METRIC_WINDOWS.map((window) => `<td>${formatMetricValue(funding?.[window])}</td>`).join("")}
          </tr>
        `;
        })
        .join("");
      const hasPortfolioMetrics = METRIC_WINDOWS.some(
        (window) =>
          isFiniteNumber(portfolio.volatility?.[window]) ||
          isFiniteNumber(portfolio.funding_rates?.[window]),
      );
      const metricsTable = hasPortfolioMetrics
        ? `
          <div class="table-wrapper" style="margin-top: 1.5rem;">
            <table class="compact">
              <thead>
                <tr>
                  <th>Window</th>
                  <th>Volatility</th>
                  <th>Funding rate</th>
                </tr>
              </thead>
              <tbody>
                ${METRIC_WINDOWS.map(
                  (window) => `
                    <tr>
                      <td>${window}</td>
                      <td>${formatMetricValue(portfolio.volatility?.[window])}</td>
                      <td>${formatMetricValue(portfolio.funding_rates?.[window])}</td>
                    </tr>
                  `,
                ).join("")}
              </tbody>
            </table>
            ${renderTablePaginationFooter("Portfolio metrics", METRIC_WINDOWS.length)}
          </div>
        `
        : "";
      const exposuresTable = symbolRows
        ? `
          <div class="table-wrapper" style="margin-top: 1.5rem;">
            <table>
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Gross Exposure</th>
                  <th>Gross %</th>
                  <th>Net Exposure</th>
                  <th>Net %</th>
                  ${METRIC_WINDOWS.map((window) => `<th>Vol ${window}</th>`).join("")}
                  ${METRIC_WINDOWS.map((window) => `<th>Fund ${window}</th>`).join("")}
                </tr>
              </thead>
              <tbody>${symbolRows}</tbody>
            </table>
            ${renderTablePaginationFooter("Portfolio exposures", symbolEntries.length)}
          </div>
        `
        : '<p style="color: var(--muted); margin-top: 1rem;">No active exposures.</p>';
      portfolioSection.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 style="margin-bottom: 0.5rem;">Portfolio overview</h2>
            <p style="color: var(--muted); margin: 0;">
              Snapshot generated at <strong data-overview-generated>${new Date(snapshot.generated_at).toLocaleString()}</strong>
            </p>
          </div>
          <span class="badge ${Array.isArray(snapshot.alerts) && snapshot.alerts.length > 0 ? "alert" : "ok"}" data-alert-summary>
            ${Array.isArray(snapshot.alerts) && snapshot.alerts.length > 0 ? `${snapshot.alerts.length} active alert${snapshot.alerts.length === 1 ? "" : "s"}` : "All clear"}
          </span>
        </div>
        <div class="metrics" style="margin-top: 1.5rem;">
          <div class="metric">
            <span class="label">Total Balance</span>
            <span class="value">${formatCurrency(portfolio.balance)}</span>
          </div>
          <div class="metric">
            <span class="label">Daily Realised PnL</span>
            <span class="value ${Number(portfolio.daily_realized_pnl) >= 0 ? "gain" : "loss"}">${formatCurrency(portfolio.daily_realized_pnl)}</span>
          </div>
          <div class="metric">
            <span class="label">Gross Exposure</span>
            <span class="value">${formatCurrency(portfolio.gross_exposure)}</span>
            <span class="subvalue">${formatPct(portfolio.gross_exposure_pct)}</span>
          </div>
          <div class="metric">
            <span class="label">Net Exposure</span>
            <span class="value ${Number(portfolio.net_exposure) >= 0 ? "gain" : "loss"}">${formatCurrency(portfolio.net_exposure)}</span>
            <span class="subvalue ${Number(portfolio.net_exposure_pct) >= 0 ? "gain" : "loss"}">${formatPct(portfolio.net_exposure_pct)}</span>
          </div>
        </div>
        ${metricsTable}
        ${exposuresTable}
      `;
    };

    const renderAccounts = (snapshot) => {
      if (!accountsContainer) {
        return;
      }
      const accountsData = Array.isArray(snapshot.accounts) ? snapshot.accounts : [];
      const hideEmpty = state.accounts.hideEmpty || {};

      accountsContainer.innerHTML = accountsData
        .map((account) => {
          const exposures = Array.isArray(account.symbol_exposures) ? account.symbol_exposures : [];
          const positions = Array.isArray(account.positions) ? account.positions : [];
          const orders = Array.isArray(account.orders) ? account.orders : [];
          const exposuresRows = exposures
            .map((exposure) => `
              <tr>
                <td>${exposure.symbol}</td>
                <td>${formatCurrency(exposure.gross_notional)}</td>
                <td>${formatPct(exposure.gross_pct)}</td>
                <td class="${Number(exposure.net_notional) >= 0 ? "gain" : "loss"}">${formatCurrency(exposure.net_notional)}</td>
                <td class="${Number(exposure.net_pct) >= 0 ? "gain" : "loss"}">${formatPct(exposure.net_pct)}</td>
              </tr>
            `)
            .join("");
          const accountVolatility = account.volatility || {};
          const accountFunding = account.funding_rates || {};
          const hasAccountMetrics = METRIC_WINDOWS.some(
            (window) =>
              isFiniteNumber(accountVolatility?.[window]) ||
              isFiniteNumber(accountFunding?.[window]),
          );
          let accountMetricsTable = "";
          if (hasAccountMetrics) {
            accountMetricsTable = `
              <div class="table-wrapper" style="margin-bottom: 1.5rem;">
                <table class="compact">
                  <thead>
                    <tr>
                      <th>Window</th>
                      <th>Volatility</th>
                      <th>Funding rate</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${METRIC_WINDOWS.map(
                      (window) => `
                        <tr>
                          <td>${window}</td>
                          <td>${formatMetricValue(accountVolatility?.[window])}</td>
                          <td>${formatMetricValue(accountFunding?.[window])}</td>
                        </tr>
                      `,
                    ).join("")}
                  </tbody>
                </table>
                ${renderTablePaginationFooter(`${account.name} metrics`, METRIC_WINDOWS.length)}
              </div>
            `;
          }
          const positionsRows = positions
            .map((position) => {
              const pnlClass = Number(position.unrealized_pnl) >= 0 ? "gain" : "loss";
              const realizedClass = Number(position.daily_realized_pnl) >= 0 ? "gain" : "loss";
              const maxDd = position.max_drawdown_pct !== null && position.max_drawdown_pct !== undefined
                ? formatPct(position.max_drawdown_pct)
                : "-";
              const volatility = position.volatility || {};
              const funding = position.funding_rates || {};
              return `
                <tr>
                  <td>${position.symbol}</td>
                  <td>${position.side}</td>
                  <td>${formatCurrency(position.notional)}</td>
                  <td>${formatPct(position.exposure)}</td>
                  <td class="${pnlClass}">${formatCurrency(position.unrealized_pnl)} (${formatPct(position.pnl_pct)})</td>
                  <td class="${realizedClass}">${formatCurrency(position.daily_realized_pnl)}</td>
                  <td>${formatPrice(position.entry_price)}</td>
                  <td>${formatPrice(position.mark_price)}</td>
                  <td>${formatPrice(position.liquidation_price)}</td>
                  <td>${maxDd}</td>
                  <td>${formatPrice(position.take_profit_price)}</td>
                  <td>${formatPrice(position.stop_loss_price)}</td>
                  ${METRIC_WINDOWS.map((window) => `<td>${formatMetricValue(volatility?.[window])}</td>`).join("")}
                  ${METRIC_WINDOWS.map((window) => `<td>${formatMetricValue(funding?.[window])}</td>`).join("")}
                  <td>
                    <div style="display: flex; flex-direction: column; gap: 0.35rem; min-width: 9rem;">
                      <button
                        type="button"
                        class="button danger small"
                        data-position-kill
                        data-position-account="${account.name}"
                        data-position-symbol="${position.symbol}"
                      >
                        Kill position
                      </button>
                      <div
                        class="status-message"
                        data-position-status="${account.name}::${position.symbol}"
                        hidden
                      ></div>
                    </div>
                  </td>
                </tr>
              `;
            })
            .join("");
          const ordersRows = orders
            .map((order) => `
              <tr>
                <td>${order.order_id || "-"}</td>
                <td>${order.symbol}</td>
                <td>${order.side}</td>
                <td>${order.type}</td>
                <td>${order.price !== null && order.price !== undefined ? formatCurrency(order.price) : "-"}</td>
                <td>${order.amount ?? "-"}</td>
                <td>${order.remaining ?? "-"}</td>
                <td>${order.status || "-"}</td>
                <td>${order.reduce_only ? "Yes" : "No"}</td>
                <td>${order.notional !== null && order.notional !== undefined ? formatCurrency(order.notional) : "-"}</td>
                <td>${order.stop_price !== null && order.stop_price !== undefined ? formatCurrency(order.stop_price) : "-"}</td>
                <td>${order.created_at || "-"}</td>
              </tr>
            `)
            .join("");
          const showEmptyExposures = !hideEmpty.exposures;
          const showEmptyPositions = !hideEmpty.positions;
          const showEmptyOrders = !hideEmpty.orders;
          const exposuresTable = exposuresRows
            ? `
                <div class="table-wrapper" style="margin-bottom: 1.5rem;">
                  <table>
                    <thead>
                      <tr>
                        <th>Symbol</th>
                        <th>Gross Exposure</th>
                        <th>Gross %</th>
                        <th>Net Exposure</th>
                        <th>Net %</th>
                      </tr>
                    </thead>
                    <tbody>${exposuresRows}</tbody>
                  </table>
                  ${renderTablePaginationFooter(`${account.name} exposures`, exposures.length)}
                </div>
              `
            : showEmptyExposures
              ? '<p style="color: var(--muted); margin: 0;">No symbol exposures.</p>'
              : "";
          const positionsTable = positions.length > 0
            ? `
                <div class="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th>Notional</th>
                        <th>Exposure %</th>
                        <th>PnL</th>
                        <th>Daily realised PnL</th>
                        <th>Entry</th>
                        <th>Mark</th>
                        <th>Liq.</th>
                        <th>Max DD</th>
                        <th>TP</th>
                        <th>SL</th>
                        ${METRIC_WINDOWS.map((window) => `<th>Vol ${window}</th>`).join("")}
                        ${METRIC_WINDOWS.map((window) => `<th>Fund ${window}</th>`).join("")}
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>${positionsRows}</tbody>
                  </table>
                  ${renderTablePaginationFooter(`${account.name} positions`, positions.length)}
                </div>
              `
            : showEmptyPositions
              ? '<p style="color: var(--muted);">No open positions.</p>'
              : "";
          const ordersTable = orders.length > 0
            ? `
                <h3 style="margin-top: 1.5rem;">Open orders</h3>
                <div class="table-wrapper" style="overflow-x: auto;">
                  <table>
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th>Type</th>
                        <th>Price</th>
                        <th>Amount</th>
                        <th>Remaining</th>
                        <th>Status</th>
                        <th>Reduce only</th>
                        <th>Notional</th>
                        <th>Stop price</th>
                        <th>Created</th>
                      </tr>
                    </thead>
                    <tbody>${ordersRows}</tbody>
                  </table>
                  ${renderTablePaginationFooter(`${account.name} orders`, orders.length)}
                </div>
              `
            : showEmptyOrders
              ? `
                <h3 style="margin-top: 1.5rem;">Open orders</h3>
                <p style="color: var(--muted);">No open orders.</p>
              `
              : "";

          const accountPerformance = account.performance || null;
          let performanceBlock = "";
          if (accountPerformance) {
            const daily = accountPerformance.daily;
            const dailyClass = daily !== null && daily !== undefined ? (Number(daily) >= 0 ? "gain" : "loss") : "";
            const dailyValue = daily !== null && daily !== undefined ? formatCurrency(daily) : "-";
            const dailySince = accountPerformance.since?.daily ? `Since ${accountPerformance.since.daily}` : "&nbsp;";
            const weekly = accountPerformance.weekly;
            const weeklyClass = weekly !== null && weekly !== undefined ? (Number(weekly) >= 0 ? "gain" : "loss") : "";
            const weeklyValue = weekly !== null && weekly !== undefined ? formatCurrency(weekly) : "-";
            const weeklySince = accountPerformance.since?.weekly ? `Since ${accountPerformance.since.weekly}` : "&nbsp;";
            const monthly = accountPerformance.monthly;
            const monthlyClass = monthly !== null && monthly !== undefined ? (Number(monthly) >= 0 ? "gain" : "loss") : "";
            const monthlyValue = monthly !== null && monthly !== undefined ? formatCurrency(monthly) : "-";
            const monthlySince = accountPerformance.since?.monthly ? `Since ${accountPerformance.since.monthly}` : "&nbsp;";
            performanceBlock = `
              <div class="metrics" style="margin-top: 1.5rem;">
                <div class="metric">
                  <span class="label">Daily PnL (4pm)</span>
                  <span class="value ${dailyClass}">${dailyValue}</span>
                  <span class="subvalue">${dailySince}</span>
                </div>
                <div class="metric">
                  <span class="label">Weekly PnL</span>
                  <span class="value ${weeklyClass}">${weeklyValue}</span>
                  <span class="subvalue">${weeklySince}</span>
                </div>
                <div class="metric">
                  <span class="label">Monthly PnL</span>
                  <span class="value ${monthlyClass}">${monthlyValue}</span>
                  <span class="subvalue">${monthlySince}</span>
                </div>
              </div>
            `;
          }

          const stopLoss = account.stop_loss;
          let stopLossBlock = "";
          if (stopLoss) {
            const threshold = stopLoss.threshold_pct !== null && stopLoss.threshold_pct !== undefined
              ? `${Number(stopLoss.threshold_pct).toFixed(2)}%`
              : "?%";
            const drawdown = stopLoss.current_drawdown_pct !== null && stopLoss.current_drawdown_pct !== undefined
              ? ` Current drawdown ${(Number(stopLoss.current_drawdown_pct) * 100).toFixed(2)}%.`
              : "";
            const baseline = stopLoss.baseline_balance !== null && stopLoss.baseline_balance !== undefined
              ? ` Baseline ${formatCurrency(stopLoss.baseline_balance)}.`
              : "";
            const triggeredAt = stopLoss.triggered_at ? ` Triggered at ${stopLoss.triggered_at}.` : "";
            const stateLabel = stopLoss.triggered ? "<strong>triggered</strong>" : "active";
            stopLossBlock = `
              <div class="status" style="margin-top: 1rem;">
                Stop loss ${stateLabel} at ${threshold}.${drawdown}${baseline}${triggeredAt}
              </div>
            `;
          }

          return `
            <section class="card" data-account="${account.name}">
              <div class="card-header" style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                  <h2 style="margin: 0;">${account.name}</h2>
                  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="badge">${positions.length} position${positions.length === 1 ? "" : "s"}</span>
                    <span class="badge">${orders.length} order${orders.length === 1 ? "" : "s"}</span>
                  </div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                  <button type="button" class="button danger" data-kill-switch="${account.name}">Kill switch</button>
                  <div class="status-message" data-kill-status="${account.name}" hidden></div>
                </div>
              </div>
              ${account.message ? `<div class="status">${account.message}</div>` : ""}
              <div class="metrics">
                <div class="metric">
                  <span class="label">Balance</span>
                  <span class="value">${formatCurrency(account.balance)}</span>
                </div>
                <div class="metric">
                  <span class="label">Daily Realised PnL</span>
                  <span class="value ${Number(account.daily_realized_pnl) >= 0 ? "gain" : "loss"}">${formatCurrency(account.daily_realized_pnl)}</span>
                </div>
                <div class="metric">
                  <span class="label">Gross Exposure</span>
                  <span class="value">${formatCurrency(account.gross_exposure_notional)}</span>
                  <span class="subvalue">${formatPct(account.gross_exposure)}</span>
                </div>
                <div class="metric">
                  <span class="label">Net Exposure</span>
                  <span class="value ${Number(account.net_exposure_notional) >= 0 ? "gain" : "loss"}">${formatCurrency(account.net_exposure_notional)}</span>
                  <span class="subvalue ${Number(account.net_exposure) >= 0 ? "gain" : "loss"}">${formatPct(account.net_exposure)}</span>
                </div>
                <div class="metric">
                  <span class="label">Unrealized PnL</span>
                  <span class="value ${Number(account.unrealized_pnl) >= 0 ? "gain" : "loss"}">${formatCurrency(account.unrealized_pnl)}</span>
                </div>
              </div>
              ${performanceBlock}
              ${stopLossBlock}
              ${accountMetricsTable}
              ${exposuresTable}
              <div class="report-actions" style="margin: 1.5rem 0;">
                <button type="button" class="button secondary" data-generate-report="${account.name}">Generate report</button>
                <div class="status-message" data-report-status="${account.name}" hidden></div>
              </div>
              ${positionsTable}
              ${ordersTable}
            </section>
          `;
        })
        .join("");

      const meta = snapshot.accounts_meta || {};
      lastAccountsMeta = meta;
      if (typeof meta.page === "number") {
        state.accounts.page = meta.page;
      }
      if (typeof meta.page_size === "number") {
        state.accounts.pageSize = meta.page_size;
      }
      if (typeof meta.sort_key === "string") {
        state.accounts.sortKey = meta.sort_key;
      }
      if (typeof meta.sort_order === "string") {
        state.accounts.sortOrder = meta.sort_order;
      }
      updateAccountsSummary(meta, accountsData.length);
      updateAccountsPagination(meta);
      applyAccountsControlsFromState();
      persistState();
    };

    const setReportStatus = (accountName, message, variant = "info") => {
      const statusEl = document.querySelector(`[data-report-status="${accountName}"]`);
      if (!statusEl) {
        return;
      }
      statusEl.classList.remove("success", "error");
      if (!message) {
        statusEl.textContent = "";
        statusEl.hidden = true;
        return;
      }
      statusEl.textContent = message;
      statusEl.hidden = false;
      if (variant === "success") {
        statusEl.classList.add("success");
      } else if (variant === "error") {
        statusEl.classList.add("error");
      }
    };

    const triggerReportDownload = (downloadUrl, filename) => {
      if (!downloadUrl) {
        return;
      }
      const anchor = document.createElement("a");
      anchor.href = downloadUrl;
      if (filename) {
        anchor.download = filename;
      }
      anchor.rel = "noopener";
      anchor.style.display = "none";
      document.body.appendChild(anchor);
      anchor.click();
      requestAnimationFrame(() => anchor.remove());
    };

    const generateAccountReport = async (accountName, button) => {
      if (!accountName) {
        return;
      }
      const statusEl = document.querySelector(`[data-report-status="${accountName}"]`);
      if (statusEl) {
        statusEl.hidden = false;
        statusEl.classList.remove("success", "error");
        statusEl.textContent = "Generating report...";
      }
      if (button) {
        button.disabled = true;
      }
      try {
        const response = await fetch(`/api/accounts/${encodeURIComponent(accountName)}/reports`, {
          method: "POST",
          credentials: "include",
        });
        if (!response.ok) {
          throw new Error(`Failed to generate report (${response.status})`);
        }
        const payload = await response.json();
        if (statusEl) {
          statusEl.textContent = "Report generated.";
          statusEl.classList.remove("error");
          statusEl.classList.add("success");
        }
        triggerReportDownload(payload.download_url, payload.filename);
      } catch (error) {
        console.error(error);
        if (statusEl) {
          statusEl.textContent = `Report generation failed: ${error.message}`;
          statusEl.classList.remove("success");
          statusEl.classList.add("error");
          statusEl.hidden = false;
        }
      } finally {
        if (button) {
          button.disabled = false;
        }
      }
    };

    const renderAlerts = (snapshot) => {
      const alertsContainer = document.querySelector(
        '[data-page-section="alerts"] [data-alerts]',
      );
      if (!alertsContainer) {
        return;
      }
      if (Array.isArray(snapshot.alerts) && snapshot.alerts.length > 0) {
        if (alertsContainer.tagName === "UL") {
          alertsContainer.innerHTML = snapshot.alerts.map((alert) => `<li>${alert}</li>`).join("");
        } else {
          const ul = document.createElement("ul");
          ul.innerHTML = snapshot.alerts.map((alert) => `<li>${alert}</li>`).join("");
          alertsContainer.replaceWith(ul);
          ul.setAttribute("data-alerts", "");
        }
      } else if (alertsContainer) {
        if (alertsContainer.tagName === "UL") {
          const replacement = document.createElement("p");
          replacement.textContent = "No active alerts. All monitored metrics are within thresholds.";
          replacement.style.color = "var(--muted)";
          replacement.setAttribute("data-alerts", "");
          alertsContainer.replaceWith(replacement);
        } else {
          alertsContainer.textContent = "No active alerts. All monitored metrics are within thresholds.";
        }
      }
    };

    const renderNotifications = (snapshot) => {
      const notificationsContainer = document.querySelector(
        '[data-page-section="alerts"] [data-notifications]',
      );
      if (!notificationsContainer) {
        return;
      }
      if (Array.isArray(snapshot.notifications) && snapshot.notifications.length > 0) {
        if (notificationsContainer.tagName === "UL") {
          notificationsContainer.innerHTML = snapshot.notifications.map((channel) => `<li>${channel}</li>`).join("");
        } else {
          const ul = document.createElement("ul");
          ul.innerHTML = snapshot.notifications.map((channel) => `<li>${channel}</li>`).join("");
          notificationsContainer.replaceWith(ul);
          ul.setAttribute("data-notifications", "");
        }
      } else if (notificationsContainer) {
        if (notificationsContainer.tagName === "UL") {
          const replacement = document.createElement("p");
          replacement.textContent = "No notification channels configured.";
          replacement.style.color = "var(--muted)";
          replacement.setAttribute("data-notifications", "");
          notificationsContainer.replaceWith(replacement);
        } else {
          notificationsContainer.textContent = "No notification channels configured.";
        }
      }
    };

    const renderSnapshot = (snapshot) => {
      latestSnapshot = snapshot;
      const generatedAtEl = document.querySelector("[data-generated-at]");
      if (generatedAtEl && snapshot.generated_at) {
        generatedAtEl.textContent = new Date(snapshot.generated_at).toLocaleString();
      }
      renderPortfolio(snapshot);
      renderAccounts(snapshot);
      renderAlerts(snapshot);
      renderNotifications(snapshot);
      if (tradingModule) {
        tradingModule.updateSnapshot(snapshot);
      }
    };

    const buildSnapshotParams = () => {
      const params = new URLSearchParams();
      const accountsState = state.accounts;
      const page = Math.max(1, Number(accountsState.page || 1));
      params.set("page", String(page));
      params.set("page_size", String(Math.max(1, Number(accountsState.pageSize || DEFAULT_ACCOUNTS_STATE.pageSize))));
      if (accountsState.search) {
        params.set("search", accountsState.search);
      }
      if (accountsState.exposure && accountsState.exposure !== "any") {
        params.set("exposure", accountsState.exposure);
      }
      if (accountsState.sortKey && accountsState.sortKey !== DEFAULT_SORT_KEY) {
        params.set("sort", accountsState.sortKey);
      }
      if (accountsState.sortOrder && accountsState.sortOrder !== DEFAULT_SORT_ORDER) {
        params.set("sort_order", accountsState.sortOrder);
      }
      return params;
    };

    const fetchSnapshot = async () => {
      const params = buildSnapshotParams();
      const query = params.toString();
      const url = query ? `/api/snapshot?${query}` : "/api/snapshot";
      const response = await fetch(url, { credentials: "include" });
      if (!response.ok) {
        throw new Error(`Snapshot request failed (${response.status})`);
      }
      return response.json();
    };

    const requestSnapshot = async () => {
      if (isFetchingSnapshot) {
        fetchQueued = true;
        return;
      }
      isFetchingSnapshot = true;
      try {
        const snapshot = await fetchSnapshot();
        renderSnapshot(snapshot);
      } catch (error) {
        console.error("Failed to refresh snapshot", error);
      } finally {
        isFetchingSnapshot = false;
        if (fetchQueued) {
          fetchQueued = false;
          requestSnapshot();
        }
      }
    };

    const triggerKillSwitch = async (accountName, button, symbol) => {
      let endpoint = "/api/kill-switch";
      let statusSelector = '[data-kill-status="__portfolio__"]';
      if (accountName) {
        if (symbol) {
          endpoint = `/api/accounts/${encodeURIComponent(accountName)}/positions/${encodeURIComponent(symbol)}/kill-switch`;
          statusSelector = `[data-position-status="${accountName}::${symbol}"]`;
        } else {
          endpoint = `/api/accounts/${encodeURIComponent(accountName)}/kill-switch`;
          statusSelector = `[data-kill-status="${accountName}"]`;
        }
      }
      const statusEl = document.querySelector(statusSelector);
      if (statusEl) {
        statusEl.textContent = "Executing kill switch...";
        statusEl.hidden = false;
        statusEl.classList.remove("success");
      }
      if (button) button.disabled = true;
      try {
        const response = await fetch(endpoint, {
          method: "POST",
          credentials: "include",
        });
        if (!response.ok) {
          throw new Error(`Kill switch failed (${response.status})`);
        }
        const payload = await response.json();
        if (payload && payload.success === false) {
          const details = Array.isArray(payload.errors) && payload.errors.length
            ? payload.errors.join("; ")
            : "Kill switch encountered errors.";
          throw new Error(details);
        }
        if (statusEl) {
          statusEl.textContent = "Kill switch executed.";
          statusEl.classList.add("success");
        }
        await requestSnapshot();
      } catch (error) {
        console.error(error);
        if (statusEl) {
          statusEl.textContent = `Kill switch failed: ${error.message}`;
          statusEl.classList.remove("success");
        }
      } finally {
        if (button) button.disabled = false;
      }
    };

    if (searchInput) {
      searchInput.addEventListener("input", (event) => {
        const { value } = event.target;
        if (searchDebounceHandle) {
          window.clearTimeout(searchDebounceHandle);
        }
        searchDebounceHandle = window.setTimeout(() => {
          state.accounts.search = value.trim();
          state.accounts.page = 1;
          persistState();
          requestSnapshot();
        }, 250);
      });
    }

    if (exposureSelect) {
      exposureSelect.addEventListener("change", () => {
        state.accounts.exposure = exposureSelect.value || "any";
        state.accounts.page = 1;
        persistState();
        requestSnapshot();
      });
    }

    if (pageSizeSelect) {
      pageSizeSelect.addEventListener("change", () => {
        const parsed = Number.parseInt(pageSizeSelect.value, 10);
        if (!Number.isFinite(parsed) || parsed <= 0) {
          return;
        }
        state.accounts.pageSize = parsed;
        state.accounts.page = 1;
        persistState();
        requestSnapshot();
      });
    }

    hideEmptyChips.forEach((chip) => {
      chip.addEventListener("click", () => {
        const key = chip.getAttribute("data-hide-empty");
        if (!key) {
          return;
        }
        const current = Boolean(state.accounts.hideEmpty?.[key]);
        state.accounts.hideEmpty[key] = !current;
        persistState();
        updateHideEmptyChips();
        if (latestSnapshot) {
          renderAccounts(latestSnapshot);
        }
      });
    });

    sortButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const key = button.getAttribute("data-sort-key");
        if (!key) {
          return;
        }
        if (state.accounts.sortKey === key) {
          state.accounts.sortOrder = state.accounts.sortOrder === "asc" ? "desc" : "asc";
        } else {
          state.accounts.sortKey = key;
          state.accounts.sortOrder = key === "name" ? "asc" : DEFAULT_SORT_ORDER;
        }
        state.accounts.page = 1;
        updateSortButtons();
        persistState();
        requestSnapshot();
      });
    });

    if (paginationContainer) {
      paginationContainer.addEventListener("click", (event) => {
        const button = event.target.closest("[data-page]");
        if (!button || button.hasAttribute("disabled")) {
          return;
        }
        const direction = button.getAttribute("data-page");
        if (!direction) {
          return;
        }
        const meta = lastAccountsMeta || {};
        const currentPage = Number(state.accounts.page || meta.page || 1);
        const totalPages = Math.max(1, Number(meta.pages || currentPage));
        if (direction === "prev" && currentPage > 1) {
          state.accounts.page = currentPage - 1;
        } else if (direction === "next" && currentPage < totalPages) {
          state.accounts.page = currentPage + 1;
        } else if (direction === "next") {
          state.accounts.page = currentPage + 1;
        }
        persistState();
        requestSnapshot();
      });
    }

    document.addEventListener("click", (event) => {
      const portfolioKillButton = event.target.closest("[data-kill-portfolio]");
      if (portfolioKillButton) {
        triggerKillSwitch(null, portfolioKillButton);
        return;
      }
      const killButton = event.target.closest("[data-kill-switch]");
      if (killButton) {
        const accountName = killButton.getAttribute("data-kill-switch");
        triggerKillSwitch(accountName, killButton);
        return;
      }
      const positionKillButton = event.target.closest("[data-position-kill]");
      if (positionKillButton) {
        const accountName = positionKillButton.getAttribute("data-position-account");
        const symbol = positionKillButton.getAttribute("data-position-symbol");
        triggerKillSwitch(accountName, positionKillButton, symbol);
        return;
      }
      const reportButton = event.target.closest("[data-generate-report]");
      if (reportButton) {
        const accountName = reportButton.getAttribute("data-generate-report");
        generateAccountReport(accountName, reportButton);
      }
    });

    setInterval(() => {
      requestSnapshot();
    }, REFRESH_INTERVAL_MS);
    requestSnapshot();
  </script>
{% endblock %}