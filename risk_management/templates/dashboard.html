{% extends "base.html" %}

{% block head %}
  <style>
    .view-nav {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .view-nav__button {
      background: rgba(148, 163, 184, 0.15);
      color: var(--text);
      border-radius: 0.75rem;
      padding: 0.6rem 1.25rem;
      border: 1px solid transparent;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .view-nav__button:hover {
      background: rgba(148, 163, 184, 0.25);
    }

    .view-nav__button.active {
      background: var(--accent);
      color: #0f172a;
      border-color: transparent;
    }

    .page-section[hidden] {
      display: none;
    }

    .button.secondary {
      background: rgba(148, 163, 184, 0.2);
      color: var(--text);
    }

    .button.secondary:hover {
      background: rgba(148, 163, 184, 0.3);
      box-shadow: 0 8px 20px rgba(148, 163, 184, 0.2);
    }

    .status-message {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .status-message.success {
      color: var(--success);
    }

    .status-message.error {
      color: var(--danger);
    }

    .grafana-grid {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }

    .grafana-panel {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .grafana-panel iframe {
      width: 100%;
      border: none;
      border-radius: 0.75rem;
      background: rgba(15, 23, 42, 0.75);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.35);
    }

    .grafana-panel__meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .accounts-controls {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .accounts-controls__row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .accounts-controls .field {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      min-width: 180px;
    }

    .accounts-controls .field > span {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .accounts-controls input[type="search"],
    .accounts-controls select {
      background: rgba(148, 163, 184, 0.1);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 0.5rem;
      padding: 0.6rem 0.75rem;
      color: inherit;
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .chip {
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(148, 163, 184, 0.12);
      border-radius: 999px;
      padding: 0.4rem 0.9rem;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .chip[aria-pressed="true"],
    .chip.active {
      background: var(--accent);
      color: #0f172a;
      border-color: transparent;
    }

    .accounts-sort {
      display: grid;
      gap: 0.35rem;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }

    .accounts-sort__button {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(148, 163, 184, 0.12);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 0.6rem;
      padding: 0.55rem 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .accounts-sort__button:hover {
      background: rgba(148, 163, 184, 0.2);
    }

    .accounts-sort__button[data-active="true"] {
      background: var(--accent);
      color: #0f172a;
      border-color: transparent;
    }

    .accounts-summary {
      margin-bottom: 1rem;
      color: var(--muted);
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .pagination {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1.5rem;
    }

    .pagination button {
      border-radius: 0.5rem;
      background: rgba(148, 163, 184, 0.12);
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 0.45rem 0.9rem;
      font-weight: 600;
      cursor: pointer;
    }

    .pagination button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .table-pagination {
      display: flex;
      justify-content: flex-end;
      gap: 0.35rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }

    .table-pagination button {
      border-radius: 0.5rem;
      background: rgba(148, 163, 184, 0.12);
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .table-pagination button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .metric .delta {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--muted);
    }

    .metric.performance-metric {
      gap: 0.3rem;
    }

    .metric.performance-metric .subvalue {
      margin-top: 0.1rem;
    }

    .chart-card {
      margin-top: 1.5rem;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 0.75rem;
      padding: 1rem 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.15);
    }

    .chart-card[data-loading="true"] {
      opacity: 0.75;
    }

    .chart-card--error {
      border-color: rgba(248, 113, 113, 0.35);
    }

    .chart-card__header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .chart-card__summary {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .chart-card__summary span + span {
      margin-left: 0.35rem;
    }

    .chart-card__figure {
      position: relative;
      width: 100%;
    }

    .chart-card__figure svg {
      width: 100%;
      height: 220px;
      display: block;
    }

    .chart-card__empty {
      margin: 0;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .chart-card--empty .chart-card__figure svg {
      display: none;
    }

    .chart-card--has-data .chart-card__empty {
      display: none;
    }

    .chart-card__details {
      border-top: 1px solid rgba(148, 163, 184, 0.12);
      padding-top: 0.75rem;
    }

    .chart-card__details summary {
      cursor: pointer;
      font-weight: 600;
    }

    .chart-card__details .table-wrapper {
      margin-top: 0.75rem;
      max-height: none;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    @media (max-width: 1024px) {
      .chart-card__figure svg {
        height: 200px;
      }
    }

    @media (max-width: 768px) {
      main {
        padding: 1.5rem 1rem;
      }

      .chart-card {
        padding: 1rem;
      }

      .chart-card__figure svg {
        height: 180px;
      }
    }
  </style>
{% endblock %}

{% block header_controls %}
  <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
    <span class="badge">Logged in as {{ user }}</span>
    <a href="/trading-panel" class="button secondary">Trading panel</a>
    <button type="button" class="button danger" data-kill-portfolio>Kill portfolio</button>
    <div class="status-message" data-kill-status="__portfolio__" hidden></div>
    <form method="post" action="/logout">
      <button type="submit">Logout</button>
    </form>
  </div>
{% endblock %}

{% macro performance_metric(label, value, reference, since) %}
  {% set has_value = value is not none %}
  {% set value_class = 'gain' if has_value and value >= 0 else ('loss' if has_value else '') %}
  {% if has_value %}
    {% set formatted_value = value|currency %}
    {% if value > 0 %}{% set formatted_value = '+' ~ formatted_value %}{% endif %}
  {% else %}
    {% set formatted_value = '-' %}
  {% endif %}
  {% if has_value and reference is not none and reference != 0 %}
    {% set pct_change = value / reference %}
  {% else %}
    {% set pct_change = none %}
  {% endif %}
  {% set pct_class = 'gain' if pct_change is not none and pct_change >= 0 else ('loss' if pct_change is not none else '') %}
  {% if pct_change is not none %}
    {% set pct_text = '%+.2f%%' % (pct_change * 100) %}
  {% else %}
    {% set pct_text = '-' %}
  {% endif %}
  <div class="metric performance-metric">
    <span class="label">{{ label }}</span>
    <span class="value {{ value_class }}">{{ formatted_value }}</span>
    <span class="delta {{ pct_class }}">{{ pct_text }}</span>
    <span class="subvalue">{% if since %}Since {{ since }}{% else %}&nbsp;{% endif %}</span>
  </div>
{% endmacro %}
{% from _self import performance_metric %}

{% block content %}
  <nav class="view-nav" role="tablist" aria-label="Dashboard sections">
    <button
      type="button"
      class="view-nav__button active"
      role="tab"
      aria-selected="true"
      data-page-target="overview"
    >
      Overview
    </button>
    <button
      type="button"
      class="view-nav__button"
      role="tab"
      aria-selected="false"
      data-page-target="accounts"
    >
      Accounts
    </button>
    <button
      type="button"
      class="view-nav__button"
      role="tab"
      aria-selected="false"
      data-page-target="alerts"
    >
      Alerts &amp; notifications
    </button>
    {% if grafana_dashboards %}
      <button
        type="button"
        class="view-nav__button"
        role="tab"
        aria-selected="false"
        data-page-target="analytics"
      >
        Analytics
      </button>
    {% endif %}
  </nav>

  <div class="page-sections">
    <div class="page-section" data-page-section="overview">
      <section class="card" data-portfolio>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 style="margin-bottom: 0.5rem;">Portfolio overview</h2>
            <p style="color: var(--muted); margin: 0;">
              Snapshot generated at <strong data-overview-generated>{{ snapshot.generated_at }}</strong>
            </p>
          </div>
          <span class="badge {% if snapshot.alerts %}alert{% else %}ok{% endif %}" data-alert-summary>
            {% if snapshot.alerts %}
              {{ snapshot.alerts|length }} active alert{{ 's' if snapshot.alerts|length != 1 else '' }}
            {% else %}
              All clear
            {% endif %}
          </span>
        </div>
        <div class="metrics" style="margin-top: 1.5rem;">
          <div class="metric">
            <span class="label">Total Balance</span>
            <span class="value">{{ snapshot.portfolio.balance|currency }}</span>
          </div>
          <div class="metric">
            <span class="label">Daily Realised PnL</span>
            <span class="value {% if snapshot.portfolio.daily_realized_pnl >= 0 %}gain{% else %}loss{% endif %}">
              {{ snapshot.portfolio.daily_realized_pnl|currency }}
            </span>
          </div>
          <div class="metric">
            <span class="label">Gross Exposure</span>
            <span class="value">{{ snapshot.portfolio.gross_exposure|currency }}</span>
            <span class="subvalue">{{ snapshot.portfolio.gross_exposure_pct|pct }}</span>
          </div>
          <div class="metric">
            <span class="label">Net Exposure</span>
            <span class="value {% if snapshot.portfolio.net_exposure >= 0 %}gain{% else %}loss{% endif %}">{{ snapshot.portfolio.net_exposure|currency }}</span>
            <span class="subvalue {% if snapshot.portfolio.net_exposure_pct >= 0 %}gain{% else %}loss{% endif %}">{{ snapshot.portfolio.net_exposure_pct|pct }}</span>
          </div>
        </div>
        {% set portfolio_performance = snapshot.portfolio.performance if snapshot.portfolio.performance is defined else None %}
        {% set portfolio_references = portfolio_performance.reference_balances if portfolio_performance and portfolio_performance.reference_balances is defined else {} %}
        {% set portfolio_since = portfolio_performance.since if portfolio_performance and portfolio_performance.since is defined else {} %}
        {% if portfolio_performance %}
          <div class="metrics metrics--performance" style="margin-top: 1.5rem;">
            {{ performance_metric('Daily PnL (4pm)', portfolio_performance.daily, portfolio_references.daily if portfolio_references else none, portfolio_since.daily if portfolio_since else none) }}
            {{ performance_metric('Weekly PnL', portfolio_performance.weekly, portfolio_references.weekly if portfolio_references else none, portfolio_since.weekly if portfolio_since else none) }}
            {{ performance_metric('Monthly PnL', portfolio_performance.monthly, portfolio_references.monthly if portfolio_references else none, portfolio_since.monthly if portfolio_since else none) }}
          </div>
        {% endif %}
        <div
          class="chart-card chart-card--empty"
          data-performance-chart="portfolio"
          data-chart-scope="portfolio"
          data-chart-title="Portfolio balance history"
        >
          <div class="chart-card__header">
            <h3 id="portfolio-balance-title" style="margin: 0;">Balance trend</h3>
            <p class="chart-card__summary" data-chart-summary aria-live="polite"></p>
          </div>
          <figure class="chart-card__figure">
            <svg
              role="img"
              aria-labelledby="portfolio-balance-title portfolio-balance-description"
              data-chart-svg
              preserveAspectRatio="none"
            ></svg>
            <figcaption id="portfolio-balance-description" class="sr-only" data-chart-description>
              Daily portfolio balance history.
            </figcaption>
            <p class="chart-card__empty" data-chart-empty>No performance history available yet.</p>
          </figure>
          <details class="chart-card__details" data-chart-details>
            <summary>View balance history table</summary>
            <div class="table-wrapper">
              <table class="compact">
                <thead>
                  <tr>
                    <th scope="col">Date</th>
                    <th scope="col">Balance</th>
                    <th scope="col">Δ</th>
                    <th scope="col">Δ%</th>
                  </tr>
                </thead>
                <tbody data-chart-table-body></tbody>
              </table>
            </div>
          </details>
        </div>
        {% set portfolio_vol = snapshot.portfolio.volatility if snapshot.portfolio.volatility is defined else {} %}
        {% set portfolio_funding = snapshot.portfolio.funding_rates if snapshot.portfolio.funding_rates is defined else {} %}
        {% if portfolio_vol or portfolio_funding %}
          <div class="table-wrapper" style="margin-top: 1.5rem;">
            <table class="compact">
              <thead>
                <tr>
                  <th>Window</th>
                  <th>Volatility</th>
                  <th>Funding rate</th>
                </tr>
              </thead>
              <tbody>
                {% for window in ["4h", "24h", "3d", "7d"] %}
                  <tr>
                    <td>{{ window }}</td>
                    {% set vol_value = portfolio_vol.get(window) if portfolio_vol else None %}
                    {% set funding_value = portfolio_funding.get(window) if portfolio_funding else None %}
                    <td>{% if vol_value is not none %}{{ vol_value|pct }}{% else %}-{% endif %}</td>
                    <td>{% if funding_value is not none %}{{ funding_value|pct }}{% else %}-{% endif %}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
            <div class="table-pagination" aria-label="Portfolio metrics">
              <button type="button" disabled>Prev</button>
              <span>4 rows</span>
              <button type="button" disabled>Next</button>
            </div>
          </div>
        {% endif %}
        {% if snapshot.portfolio.symbols %}
          <div class="table-wrapper" style="margin-top: 1.5rem;">
            <table>
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Gross Exposure</th>
                  <th>Gross %</th>
                  <th>Net Exposure</th>
                  <th>Net %</th>
                  <th>Vol 4h</th>
                  <th>Vol 24h</th>
                  <th>Vol 3d</th>
                  <th>Vol 7d</th>
                  <th>Fund 4h</th>
                  <th>Fund 24h</th>
                  <th>Fund 3d</th>
                  <th>Fund 7d</th>
                </tr>
              </thead>
              <tbody>
                {% for entry in snapshot.portfolio.symbols %}
                  {% set symbol_vol = entry.volatility if entry.volatility is defined else {} %}
                  {% set symbol_funding = entry.funding_rates if entry.funding_rates is defined else {} %}
                  <tr>
                    <td>{{ entry.symbol }}</td>
                    <td>{{ entry.gross_notional|currency }}</td>
                    <td>{{ entry.gross_pct|pct }}</td>
                    <td class="{% if entry.net_notional >= 0 %}gain{% else %}loss{% endif %}">{{ entry.net_notional|currency }}</td>
                    <td class="{% if entry.net_pct >= 0 %}gain{% else %}loss{% endif %}">{{ entry.net_pct|pct }}</td>
                    <td>{% if symbol_vol and symbol_vol.get("4h") is not none %}{{ symbol_vol.get("4h")|pct }}{% else %}-{% endif %}</td>
                    <td>{% if symbol_vol and symbol_vol.get("24h") is not none %}{{ symbol_vol.get("24h")|pct }}{% else %}-{% endif %}</td>
                    <td>{% if symbol_vol and symbol_vol.get("3d") is not none %}{{ symbol_vol.get("3d")|pct }}{% else %}-{% endif %}</td>
                    <td>{% if symbol_vol and symbol_vol.get("7d") is not none %}{{ symbol_vol.get("7d")|pct }}{% else %}-{% endif %}</td>
                    <td>{% if symbol_funding and symbol_funding.get("4h") is not none %}{{ symbol_funding.get("4h")|pct }}{% else %}-{% endif %}</td>
                    <td>{% if symbol_funding and symbol_funding.get("24h") is not none %}{{ symbol_funding.get("24h")|pct }}{% else %}-{% endif %}</td>
                    <td>{% if symbol_funding and symbol_funding.get("3d") is not none %}{{ symbol_funding.get("3d")|pct }}{% else %}-{% endif %}</td>
                    <td>{% if symbol_funding and symbol_funding.get("7d") is not none %}{{ symbol_funding.get("7d")|pct }}{% else %}-{% endif %}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
            <div class="table-pagination" aria-label="Portfolio exposures">
              <button type="button" disabled>Prev</button>
              <span>
                {{ snapshot.portfolio.symbols|length }} row{{ 's' if snapshot.portfolio.symbols|length != 1 else '' }}
              </span>
              <button type="button" disabled>Next</button>
            </div>
          </div>
        {% else %}
          <p style="color: var(--muted); margin-top: 1rem;">No active exposures.</p>
        {% endif %}
      </section>
    </div>

    <div class="page-section" data-page-section="accounts" hidden>
      <div class="accounts-controls" data-accounts-controls>
        <div class="accounts-controls__row">
          <label class="field">
            <span>Search</span>
            <input
              type="search"
              name="accounts-search"
              placeholder="Search account or symbol"
              autocomplete="off"
              data-accounts-search
            />
          </label>
          <label class="field">
            <span>Exposure filter</span>
            <select name="accounts-exposure" data-accounts-exposure>
              <option value="any">All accounts</option>
              <option value="gross">With gross exposure</option>
              <option value="net_long">Net long</option>
              <option value="net_short">Net short</option>
              <option value="flat">Flat</option>
            </select>
          </label>
          <label class="field">
            <span>Page size</span>
            <select name="accounts-page-size" data-accounts-page-size>
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </label>
        </div>
        <div class="accounts-controls__row">
          <div class="chip-group" role="group" aria-label="Hide empty sections">
            <button type="button" class="chip" data-hide-empty="exposures">Hide empty exposures</button>
            <button type="button" class="chip" data-hide-empty="positions">Hide empty positions</button>
            <button type="button" class="chip" data-hide-empty="orders">Hide empty orders</button>
          </div>
        </div>
        <div class="accounts-sort" role="group" aria-label="Sort accounts">
          <button type="button" class="accounts-sort__button" data-sort-key="name">
            Account
            <span aria-hidden="true">↕</span>
          </button>
          <button type="button" class="accounts-sort__button" data-sort-key="balance">
            Balance
            <span aria-hidden="true">↕</span>
          </button>
          <button type="button" class="accounts-sort__button" data-sort-key="gross">
            Gross exposure
            <span aria-hidden="true">↕</span>
          </button>
          <button type="button" class="accounts-sort__button" data-sort-key="net">
            Net exposure
            <span aria-hidden="true">↕</span>
          </button>
          <button type="button" class="accounts-sort__button" data-sort-key="unrealized">
            Unrealized PnL
            <span aria-hidden="true">↕</span>
          </button>
          <button type="button" class="accounts-sort__button" data-sort-key="daily_realized">
            Daily realised PnL
            <span aria-hidden="true">↕</span>
          </button>
        </div>
      </div>
      {% set accounts_meta = snapshot.accounts_meta if snapshot.accounts_meta is defined else {} %}
      {% set current_page = accounts_meta.page if accounts_meta.page is defined else 1 %}
      {% set total_pages = accounts_meta.pages if accounts_meta.pages is defined else 1 %}
      {% set page_size = accounts_meta.page_size if accounts_meta.page_size is defined else snapshot.accounts|length %}
      {% set filtered_total = accounts_meta.filtered if accounts_meta.filtered is defined else snapshot.accounts|length %}
      {% set start_index = ((current_page - 1) * page_size + 1) if filtered_total else 0 %}
      {% set end_index = (start_index + snapshot.accounts|length - 1) if filtered_total else 0 %}
      {% set sort_labels = {
        'name': 'Account',
        'balance': 'Balance',
        'gross': 'Gross exposure',
        'net': 'Net exposure',
        'unrealized': 'Unrealized PnL',
        'daily_realized': 'Daily realised PnL'
      } %}
      <div class="accounts-summary" data-accounts-summary>
        <span>
          {% if filtered_total %}
            Showing {{ start_index }}–{{ end_index }} of {{ filtered_total }} account{{ 's' if filtered_total != 1 else '' }}
          {% else %}
            No accounts match the selected filters.
          {% endif %}
        </span>
        <span>
          Sorted by {{ sort_labels.get(accounts_meta.sort_key, 'Balance') }}
          ({{ 'ascending' if accounts_meta.sort_order == 'asc' else 'descending' }})
        </span>
      </div>
      <div data-accounts>
        {% for account in snapshot.accounts %}
          <section class="card" data-account="{{ account.name }}">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
              <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <h2 style="margin: 0;">{{ account.name }}</h2>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  <span class="badge">{{ account.positions|length }} position{{ 's' if account.positions|length != 1 else '' }}</span>
                  <span class="badge">{{ account.orders|length }} order{{ 's' if account.orders|length != 1 else '' }}</span>
                </div>
              </div>
              <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                <button type="button" class="button danger" data-kill-switch="{{ account.name }}">Kill switch</button>
                <div class="status-message" data-kill-status="{{ account.name }}" hidden></div>
              </div>
            </div>
            {% if account.message %}
              <div class="status">{{ account.message }}</div>
            {% endif %}
            <div class="metrics">
              <div class="metric">
                <span class="label">Balance</span>
                <span class="value">{{ account.balance|currency }}</span>
              </div>
              <div class="metric">
                <span class="label">Daily Realised PnL</span>
                <span class="value {% if account.daily_realized_pnl >= 0 %}gain{% else %}loss{% endif %}">{{ account.daily_realized_pnl|currency }}</span>
              </div>
              <div class="metric">
                <span class="label">Gross Exposure</span>
                <span class="value">{{ account.gross_exposure_notional|currency }}</span>
                <span class="subvalue">{{ account.gross_exposure|pct }}</span>
              </div>
              <div class="metric">
                <span class="label">Net Exposure</span>
                <span class="value {% if account.net_exposure_notional >= 0 %}gain{% else %}loss{% endif %}">{{ account.net_exposure_notional|currency }}</span>
                <span class="subvalue {% if account.net_exposure >= 0 %}gain{% else %}loss{% endif %}">{{ account.net_exposure|pct }}</span>
              </div>
              <div class="metric">
                <span class="label">Unrealized PnL</span>
                <span class="value {% if account.unrealized_pnl >= 0 %}gain{% else %}loss{% endif %}">{{ account.unrealized_pnl|currency }}</span>
              </div>
            </div>
            {% set account_performance = account.performance if account.performance is defined else None %}
            {% set account_references = account_performance.reference_balances if account_performance and account_performance.reference_balances is defined else {} %}
            {% set account_since = account_performance.since if account_performance and account_performance.since is defined else {} %}
            {% if account_performance %}
              <div class="metrics metrics--performance" style="margin-top: 1.5rem;">
                {{ performance_metric('Daily PnL (4pm)', account_performance.daily, account_references.daily if account_references else none, account_since.daily if account_since else none) }}
                {{ performance_metric('Weekly PnL', account_performance.weekly, account_references.weekly if account_references else none, account_since.weekly if account_since else none) }}
                {{ performance_metric('Monthly PnL', account_performance.monthly, account_references.monthly if account_references else none, account_since.monthly if account_since else none) }}
              </div>
            {% endif %}
            {% set chart_id = 'account-balance-' ~ loop.index %}
            <div
              class="chart-card chart-card--empty"
              data-performance-chart="account"
              data-account-name="{{ account.name|e }}"
              data-chart-scope="account"
              data-chart-title="{{ account.name|e }} balance history"
            >
              <div class="chart-card__header">
                <h3 id="{{ chart_id }}-title" style="margin: 0;">Balance trend</h3>
                <p class="chart-card__summary" data-chart-summary aria-live="polite"></p>
              </div>
              <figure class="chart-card__figure">
                <svg
                  role="img"
                  aria-labelledby="{{ chart_id }}-title {{ chart_id }}-description"
                  data-chart-svg
                  preserveAspectRatio="none"
                ></svg>
                <figcaption id="{{ chart_id }}-description" class="sr-only" data-chart-description>
                  Balance history for {{ account.name|e }}.
                </figcaption>
                <p class="chart-card__empty" data-chart-empty>No performance history available yet.</p>
              </figure>
              <details class="chart-card__details" data-chart-details>
                <summary>View balance history table</summary>
                <div class="table-wrapper">
                  <table class="compact">
                    <thead>
                      <tr>
                        <th scope="col">Date</th>
                        <th scope="col">Balance</th>
                        <th scope="col">Δ</th>
                        <th scope="col">Δ%</th>
                      </tr>
                    </thead>
                    <tbody data-chart-table-body></tbody>
                  </table>
                </div>
              </details>
            </div>
            {% if account.stop_loss %}
              {% set sl = account.stop_loss %}
              <div class="status" style="margin-top: 1rem;">
                Stop loss {% if sl.triggered %}<strong>triggered</strong>{% else %}active{% endif %} at
                {% if sl.threshold_pct is not none %}{{ sl.threshold_pct|round(2) }}%{% else %}?%{% endif %}.
                {% if sl.current_drawdown_pct is not none %}
                  Current drawdown {{ (sl.current_drawdown_pct * 100)|round(2) }}%.
                {% endif %}
                {% if sl.baseline_balance is not none %}
                  Baseline {{ sl.baseline_balance|currency }}.
                {% endif %}
                {% if sl.triggered_at %}
                  Triggered at {{ sl.triggered_at }}.
                {% endif %}
              </div>
            {% endif %}
            {% set account_vol = account.volatility if account.volatility is defined else {} %}
            {% set account_funding = account.funding_rates if account.funding_rates is defined else {} %}
            {% if account_vol or account_funding %}
              <div class="table-wrapper" style="margin-bottom: 1.5rem;">
                <table class="compact">
                  <thead>
                    <tr>
                      <th>Window</th>
                      <th>Volatility</th>
                      <th>Funding rate</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for window in ["4h", "24h", "3d", "7d"] %}
                      {% set vol_value = account_vol.get(window) if account_vol else None %}
                      {% set funding_value = account_funding.get(window) if account_funding else None %}
                      <tr>
                        <td>{{ window }}</td>
                        <td>{% if vol_value is not none %}{{ vol_value|pct }}{% else %}-{% endif %}</td>
                        <td>{% if funding_value is not none %}{{ funding_value|pct }}{% else %}-{% endif %}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endif %}
            {% if account.symbol_exposures %}
              <div class="table-wrapper" style="margin-bottom: 1.5rem;">
                <table>
                  <thead>
                    <tr>
                      <th>Symbol</th>
                      <th>Gross Exposure</th>
                      <th>Gross %</th>
                      <th>Net Exposure</th>
                      <th>Net %</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for exposure in account.symbol_exposures %}
                      <tr>
                        <td>{{ exposure.symbol }}</td>
                        <td>{{ exposure.gross_notional|currency }}</td>
                        <td>{{ exposure.gross_pct|pct }}</td>
                        <td class="{% if exposure.net_notional >= 0 %}gain{% else %}loss{% endif %}">{{ exposure.net_notional|currency }}</td>
                        <td class="{% if exposure.net_pct >= 0 %}gain{% else %}loss{% endif %}">{{ exposure.net_pct|pct }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
                <div class="table-pagination" aria-label="{{ account.name }} exposures">
                  <button type="button" disabled>Prev</button>
                  <span>
                    {{ account.symbol_exposures|length }} row{{ 's' if account.symbol_exposures|length != 1 else '' }}
                  </span>
                  <button type="button" disabled>Next</button>
                </div>
              </div>
            {% endif %}
              <div class="report-actions" style="margin: 1.5rem 0;">
                <button type="button" class="button secondary" data-generate-report="{{ account.name }}">Generate report</button>
                <div class="status-message" data-report-status="{{ account.name }}" hidden></div>
              </div>
            {% if account.positions %}
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Symbol</th>
                      <th>Side</th>
                      <th>Notional</th>
                      <th>Exposure %</th>
                      <th>PnL</th>
                      <th>Daily realised PnL</th>
                      <th>Entry</th>
                      <th>Mark</th>
                      <th>Liq.</th>
                      <th>Max DD</th>
                      <th>TP</th>
                      <th>SL</th>
                      <th>Vol 4h</th>
                      <th>Vol 24h</th>
                      <th>Vol 3d</th>
                      <th>Vol 7d</th>
                      <th>Fund 4h</th>
                      <th>Fund 24h</th>
                      <th>Fund 3d</th>
                      <th>Fund 7d</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for position in account.positions %}
                      {% set position_vol = position.volatility if position.volatility is defined else {} %}
                      {% set position_funding = position.funding_rates if position.funding_rates is defined else {} %}
                      <tr>
                        <td>{{ position.symbol }}</td>
                        <td>{{ position.side }}</td>
                        <td>{{ position.notional|currency }}</td>
                        <td>{{ position.exposure|pct }}</td>
                        <td class="{% if position.unrealized_pnl >= 0 %}gain{% else %}loss{% endif %}">{{ position.unrealized_pnl|currency }} ({{ position.pnl_pct|pct }})</td>
                        <td class="{% if position.daily_realized_pnl >= 0 %}gain{% else %}loss{% endif %}">{{ position.daily_realized_pnl|currency }}</td>
                        <td>{{ position.entry_price|currency }}</td>
                        <td>{{ position.mark_price|currency }}</td>
                        <td>{% if position.liquidation_price is not none %}{{ position.liquidation_price|currency }}{% else %}-{% endif %}</td>
                        <td>{% if position.max_drawdown_pct is not none %}{{ position.max_drawdown_pct|pct }}{% else %}-{% endif %}</td>
                        <td>{% if position.take_profit_price is not none %}{{ position.take_profit_price|currency }}{% else %}-{% endif %}</td>
                        <td>{% if position.stop_loss_price is not none %}{{ position.stop_loss_price|currency }}{% else %}-{% endif %}</td>
                        <td>{% if position_vol and position_vol.get("4h") is not none %}{{ position_vol.get("4h")|pct }}{% else %}-{% endif %}</td>
                        <td>{% if position_vol and position_vol.get("24h") is not none %}{{ position_vol.get("24h")|pct }}{% else %}-{% endif %}</td>
                        <td>{% if position_vol and position_vol.get("3d") is not none %}{{ position_vol.get("3d")|pct }}{% else %}-{% endif %}</td>
                        <td>{% if position_vol and position_vol.get("7d") is not none %}{{ position_vol.get("7d")|pct }}{% else %}-{% endif %}</td>
                        <td>{% if position_funding and position_funding.get("4h") is not none %}{{ position_funding.get("4h")|pct }}{% else %}-{% endif %}</td>
                        <td>{% if position_funding and position_funding.get("24h") is not none %}{{ position_funding.get("24h")|pct }}{% else %}-{% endif %}</td>
                        <td>{% if position_funding and position_funding.get("3d") is not none %}{{ position_funding.get("3d")|pct }}{% else %}-{% endif %}</td>
                        <td>{% if position_funding and position_funding.get("7d") is not none %}{{ position_funding.get("7d")|pct }}{% else %}-{% endif %}</td>
                        <td>
                          <div style="display: flex; flex-direction: column; gap: 0.35rem; min-width: 9rem;">
                            <button
                              type="button"
                              class="button danger small"
                              data-position-kill
                              data-position-account="{{ account.name }}"
                              data-position-symbol="{{ position.symbol }}"
                            >
                              Kill position
                            </button>
                            <div
                              class="status-message"
                              data-position-status="{{ account.name }}::{{ position.symbol }}"
                              hidden
                            ></div>
                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
                <div class="table-pagination" aria-label="{{ account.name }} positions">
                  <button type="button" disabled>Prev</button>
                  <span>
                    {{ account.positions|length }} row{{ 's' if account.positions|length != 1 else '' }}
                  </span>
                  <button type="button" disabled>Next</button>
                </div>
              </div>
            {% else %}
              <p style="color: var(--muted);">No open positions.</p>
            {% endif %}
            {% if account.orders %}
              <h3 style="margin-top: 1.5rem;">Open orders</h3>
              <div class="table-wrapper" style="overflow-x: auto;">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Symbol</th>
                      <th>Side</th>
                      <th>Type</th>
                      <th>Price</th>
                      <th>Amount</th>
                      <th>Remaining</th>
                      <th>Status</th>
                      <th>Reduce only</th>
                      <th>Notional</th>
                      <th>Stop price</th>
                      <th>Created</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for order in account.orders %}
                      <tr>
                        <td>{{ order.order_id or '-' }}</td>
                        <td>{{ order.symbol }}</td>
                        <td>{{ order.side }}</td>
                        <td>{{ order.type }}</td>
                        <td>{{ order.price|currency if order.price is not none else '-' }}</td>
                        <td>{{ order.amount if order.amount is not none else '-' }}</td>
                        <td>{{ order.remaining if order.remaining is not none else '-' }}</td>
                        <td>{{ order.status }}</td>
                        <td>{{ 'Yes' if order.reduce_only else 'No' }}</td>
                        <td>{{ order.notional|currency if order.notional is not none else '-' }}</td>
                        <td>{{ order.stop_price|currency if order.stop_price is not none else '-' }}</td>
                        <td>{{ order.created_at or '-' }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
                <div class="table-pagination" aria-label="{{ account.name }} orders">
                  <button type="button" disabled>Prev</button>
                  <span>
                    {{ account.orders|length }} row{{ 's' if account.orders|length != 1 else '' }}
                  </span>
                  <button type="button" disabled>Next</button>
                </div>
              </div>
            {% else %}
              <p style="color: var(--muted);">No open orders.</p>
            {% endif %}
          </section>
        {% endfor %}
      </div>
      <div class="pagination" data-accounts-pagination>
        <button type="button" data-page="prev" {% if not accounts_meta.has_previous %}disabled{% endif %}>Previous</button>
        <span>Page {{ current_page }} of {{ total_pages }}</span>
        <button type="button" data-page="next" {% if not accounts_meta.has_next %}disabled{% endif %}>Next</button>
      </div>
    </div>

    <div class="page-section" data-page-section="alerts" hidden>
      <section class="card alerts">
        <h2>Alerts</h2>
        {% if snapshot.alerts %}
          <ul data-alerts>
            {% for alert in snapshot.alerts %}
              <li>{{ alert }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p data-alerts style="color: var(--muted);">No active alerts. All monitored metrics are within thresholds.</p>
        {% endif %}
      </section>

      <section class="card notifications">
        <h2>Notification channels</h2>
        {% if snapshot.notifications %}
          <ul data-notifications>
            {% for channel in snapshot.notifications %}
              <li>{{ channel }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p data-notifications style="color: var(--muted);">No notification channels configured.</p>
        {% endif %}
      </section>
    </div>

    {% if grafana_dashboards %}
      <div class="page-section" data-page-section="analytics" hidden>
        <section class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
            <div>
              <h2 style="margin-bottom: 0.25rem;">Performance analytics</h2>
              <p style="color: var(--muted); margin: 0;">Live Grafana dashboards embedded from your monitoring stack.</p>
            </div>
            <!-- Optional: add a last-refreshed badge target for JS if desired -->
          </div>
          <div class="grafana-grid" style="margin-top: 1.5rem;">
            {% for dashboard in grafana_dashboards %}
              <article class="grafana-panel">
                <div class="grafana-panel__meta">
                  <div>
                    <h3 style="margin: 0 0 0.25rem;">{{ dashboard.title }}</h3>
                    {% if dashboard.description %}
                      <p style="margin: 0; color: var(--muted); font-size: 0.9rem;">{{ dashboard.description }}</p>
                    {% endif %}
                  </div>
                  <a class="button secondary" href="{{ dashboard.url }}" target="_blank" rel="noopener">
                    Open in Grafana
                  </a>
                </div>
                <iframe
                  src="{{ dashboard.url }}"
                  title="{{ dashboard.title }}"
                  height="{{ dashboard.height }}"
                  loading="lazy"
                  referrerpolicy="no-referrer-when-downgrade"
                  allowfullscreen
                ></iframe>
              </article>
            {% endfor %}
          </div>
        </section>
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block generated_at %}{{ snapshot.generated_at }}{% endblock %}

{% block scripts %}
  <script>
    const REFRESH_INTERVAL_MS = 10000;
    const DEFAULT_PAGE = "overview";
    const STORAGE_KEY = "risk-dashboard.activePage";
    const METRIC_WINDOWS = ["4h", "24h", "3d", "7d"];
    const DEFAULT_SORT_KEY = "balance";
    const DEFAULT_SORT_ORDER = "desc";
    const SORT_LABELS = {
      name: "Account",
      balance: "Balance",
      gross: "Gross exposure",
      net: "Net exposure",
      unrealized: "Unrealized PnL",
      daily_realized: "Daily realised PnL",
    };
    const DEFAULT_ACCOUNTS_STATE = {
      search: "",
      exposure: "any",
      hideEmpty: {
        exposures: false,
        positions: false,
        orders: false,
      },
      sortKey: DEFAULT_SORT_KEY,
      sortOrder: DEFAULT_SORT_ORDER,
      page: 1,
      pageSize: 25,
    };

    const loadPersistedState = () => {
      const baseState = {
        activePage: DEFAULT_PAGE,
        accounts: { ...DEFAULT_ACCOUNTS_STATE },
      };
      try {
        const stored = window.localStorage.getItem(STORAGE_KEY);
        if (!stored) {
          return baseState;
        }
        let parsed;
        try {
          parsed = JSON.parse(stored);
        } catch (error) {
          if (typeof stored === "string") {
            return { ...baseState, activePage: stored };
          }
          return baseState;
        }
        if (typeof parsed === "string") {
          return { ...baseState, activePage: parsed };
        }
        if (parsed && typeof parsed === "object") {
          const activePage = typeof parsed.activePage === "string" ? parsed.activePage : baseState.activePage;
          const accountsState = parsed.accounts && typeof parsed.accounts === "object" ? parsed.accounts : {};
          return {
            activePage,
            accounts: {
              ...DEFAULT_ACCOUNTS_STATE,
              ...accountsState,
              hideEmpty: {
                ...DEFAULT_ACCOUNTS_STATE.hideEmpty,
                ...(accountsState.hideEmpty || {}),
              },
            },
          };
        }
      } catch (error) {
        console.debug("Failed to restore dashboard state", error);
      }
      return baseState;
    };

    let state = loadPersistedState();
    let latestSnapshot = null;
    let lastAccountsMeta = null;
    let isFetchingSnapshot = false;
    let fetchQueued = false;
    let searchDebounceHandle = null;

    const pageSections = Array.from(document.querySelectorAll("[data-page-section]"));
    const navButtons = Array.from(document.querySelectorAll("[data-page-target]"));
    const accountsSection = document.querySelector('[data-page-section="accounts"]');
    const accountsContainer = accountsSection ? accountsSection.querySelector("[data-accounts]") : null;
    const accountsControlsElement = document.querySelector("[data-accounts-controls]");
    const accountsSummaryEl = document.querySelector("[data-accounts-summary]");
    const paginationContainer = document.querySelector("[data-accounts-pagination]");
    const searchInput = accountsControlsElement ? accountsControlsElement.querySelector("[data-accounts-search]") : null;
    const exposureSelect = accountsControlsElement ? accountsControlsElement.querySelector("[data-accounts-exposure]") : null;
    const pageSizeSelect = accountsControlsElement ? accountsControlsElement.querySelector("[data-accounts-page-size]") : null;
    const hideEmptyChips = accountsControlsElement
      ? Array.from(accountsControlsElement.querySelectorAll("[data-hide-empty]"))
      : [];
    const sortButtons = accountsControlsElement
      ? Array.from(accountsControlsElement.querySelectorAll("[data-sort-key]"))
      : [];

    const persistState = () => {
      try {
        window.localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (error) {
        console.debug("Failed to persist dashboard state", error);
      }
    };

    const setActivePage = (page) => {
      const targetExists = pageSections.some(
        (section) => section.getAttribute("data-page-section") === page,
      );
      const targetPage = targetExists ? page : DEFAULT_PAGE;

      pageSections.forEach((section) => {
        const isActive = section.getAttribute("data-page-section") === targetPage;
        section.toggleAttribute("hidden", !isActive);
        section.setAttribute("aria-hidden", String(!isActive));
      });

      navButtons.forEach((button) => {
        const isActive = button.getAttribute("data-page-target") === targetPage;
        button.classList.toggle("active", isActive);
        button.setAttribute("aria-selected", String(isActive));
      });

      state.activePage = targetPage;
      persistState();
    };

    navButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const target = button.getAttribute("data-page-target");
        setActivePage(target || DEFAULT_PAGE);
      });
    });

    setActivePage(state.activePage || DEFAULT_PAGE);

    const updateSortButtons = () => {
      sortButtons.forEach((button) => {
        const key = button.getAttribute("data-sort-key");
        const indicator = button.querySelector("span");
        const isActive = key === state.accounts.sortKey;
        button.dataset.active = String(isActive);
        if (indicator) {
          indicator.textContent = isActive
            ? state.accounts.sortOrder === "asc"
              ? "↑"
              : "↓"
            : "↕";
        }
      });
    };

    const updateHideEmptyChips = () => {
      hideEmptyChips.forEach((chip) => {
        const key = chip.getAttribute("data-hide-empty");
        const pressed = Boolean(state.accounts.hideEmpty?.[key]);
        chip.classList.toggle("active", pressed);
        chip.setAttribute("aria-pressed", String(pressed));
      });
    };

    const applyAccountsControlsFromState = () => {
      if (searchInput && searchInput.value !== state.accounts.search) {
        searchInput.value = state.accounts.search;
      }
      if (exposureSelect) {
        const targetValue = state.accounts.exposure || "any";
        if (exposureSelect.value !== targetValue) {
          exposureSelect.value = targetValue;
        }
      }
      if (pageSizeSelect) {
        const pageSizeValue = String(state.accounts.pageSize || DEFAULT_ACCOUNTS_STATE.pageSize);
        if (pageSizeSelect.value !== pageSizeValue) {
          pageSizeSelect.value = pageSizeValue;
        }
      }
      updateHideEmptyChips();
      updateSortButtons();
    };

    applyAccountsControlsFromState();

    const formatCurrency = (value) => {
      const number = Number(value || 0);
      return new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(number);
    };

    const formatPrice = (value) => {
      if (value === null || value === undefined || Number.isNaN(Number(value))) {
        return "-";
      }
      return Number(value).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 6 });
    };

    const formatPct = (value) => {
      const number = Number(value || 0) * 100;
      return `${number.toFixed(2)}%`;
    };

    const formatCurrencyDelta = (value) => {
      const number = Number(value);
      if (!Number.isFinite(number)) {
        return "-";
      }
      const formatted = formatCurrency(number);
      if (number > 0 && !formatted.startsWith("+")) {
        return `+${formatted}`;
      }
      if (Math.abs(number) < 1e-9) {
        return formatCurrency(0);
      }
      return formatted;
    };

    const formatSignedPct = (value) => {
      const number = Number(value);
      if (!Number.isFinite(number)) {
        return "-";
      }
      if (Math.abs(number) < 1e-9) {
        return "0.00%";
      }
      const percent = (number * 100).toFixed(2);
      return number > 0 ? `+${percent}%` : `${percent}%`;
    };

    const computePctChange = (pnl, reference) => {
      const pnlNumber = Number(pnl);
      const referenceNumber = Number(reference);
      if (!Number.isFinite(pnlNumber) || !Number.isFinite(referenceNumber) || referenceNumber === 0) {
        return null;
      }
      return pnlNumber / referenceNumber;
    };

    const escapeHtml = (value) => {
      if (value === null || value === undefined) {
        return "";
      }
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    };

    let chartIdCounter = 0;
    const createChartId = (prefix = "chart") => {
      chartIdCounter += 1;
      return `${prefix}-${chartIdCounter}`;
    };

    const isFiniteNumber = (value) => typeof value === "number" && Number.isFinite(value);

    const formatMetricValue = (value) => (isFiniteNumber(value) ? formatPct(value) : "-");

    const formatBytes = (value) => {
      const number = Number(value);
      if (!Number.isFinite(number) || number <= 0) {
        return "0 B";
      }
      const units = ["B", "KB", "MB", "GB", "TB"];
      const exponent = Math.min(Math.floor(Math.log(number) / Math.log(1024)), units.length - 1);
      const size = number / 1024 ** exponent;
      const precision = exponent === 0 ? 0 : 2;
      return `${size.toFixed(precision)} ${units[exponent]}`;
    };

    const renderTablePaginationFooter = (label, count) => `
      <div class="table-pagination" role="navigation" aria-label="${label}">
        <button type="button" disabled>Prev</button>
        <span>${count} row${count === 1 ? "" : "s"}</span>
        <button type="button" disabled>Next</button>
      </div>
    `;

    const renderPerformanceMetricBlock = (label, value, reference, since) => {
      const pctChange = computePctChange(value, reference);
      const valueNumber = Number(value);
      const hasValue = Number.isFinite(valueNumber);
      const valueClass = hasValue ? (valueNumber >= 0 ? "gain" : "loss") : "";
      const pctClass = pctChange === null ? "" : pctChange >= 0 ? "gain" : "loss";
      const valueText = hasValue ? formatCurrencyDelta(valueNumber) : "-";
      const pctText = pctChange === null ? "-" : formatSignedPct(pctChange);
      const sinceText = since ? `Since ${escapeHtml(since)}` : "&nbsp;";
      return `
        <div class="metric performance-metric">
          <span class="label">${escapeHtml(label)}</span>
          <span class="value ${valueClass}">${escapeHtml(valueText)}</span>
          <span class="delta ${pctClass}">${escapeHtml(pctText)}</span>
          <span class="subvalue">${sinceText}</span>
        </div>
      `;
    };

    const renderPerformanceMetrics = (performance) => {
      if (!performance) {
        return "";
      }
      const references = performance.reference_balances || {};
      const since = performance.since || {};
      const blocks = [
        renderPerformanceMetricBlock(
          "Daily PnL (4pm)",
          performance.daily,
          references?.daily,
          since?.daily,
        ),
        renderPerformanceMetricBlock(
          "Weekly PnL",
          performance.weekly,
          references?.weekly,
          since?.weekly,
        ),
        renderPerformanceMetricBlock(
          "Monthly PnL",
          performance.monthly,
          references?.monthly,
          since?.monthly,
        ),
      ];
      const content = blocks.filter(Boolean).join("");
      if (!content.trim()) {
        return "";
      }
      return `
        <div class="metrics metrics--performance" style="margin-top: 1.5rem;">
          ${content}
        </div>
      `;
    };

    const renderPerformanceChartShell = (scope, { accountName = "", chartId, description } = {}) => {
      const isAccount = scope === "account";
      const resolvedId = chartId || createChartId(`chart-${scope}`);
      const titleText = isAccount
        ? `${accountName} balance history`
        : "Portfolio balance history";
      const descriptionText = description
        || (isAccount
          ? `Balance history for ${accountName}.`
          : "Daily portfolio balance history.");
      const attributes = [
        "class=\"chart-card chart-card--empty\"",
        `data-performance-chart="${scope}"`,
        `data-chart-scope="${scope}"`,
        `data-chart-title="${escapeHtml(titleText)}"`,
      ];
      if (isAccount) {
        attributes.push(`data-account-name="${escapeHtml(accountName)}"`);
      }
      return `
        <div ${attributes.join(" ")}>
          <div class="chart-card__header">
            <h3 id="${resolvedId}-title" style="margin: 0;">Balance trend</h3>
            <p class="chart-card__summary" data-chart-summary aria-live="polite"></p>
          </div>
          <figure class="chart-card__figure">
            <svg
              role="img"
              aria-labelledby="${resolvedId}-title ${resolvedId}-description"
              data-chart-svg
              preserveAspectRatio="none"
            ></svg>
            <figcaption id="${resolvedId}-description" class="sr-only" data-chart-description>
              ${escapeHtml(descriptionText)}
            </figcaption>
            <p class="chart-card__empty" data-chart-empty>No performance history available yet.</p>
          </figure>
          <details class="chart-card__details" data-chart-details>
            <summary>View balance history table</summary>
            <div class="table-wrapper">
              <table class="compact">
                <thead>
                  <tr>
                    <th scope="col">Date</th>
                    <th scope="col">Balance</th>
                    <th scope="col">Δ</th>
                    <th scope="col">Δ%</th>
                  </tr>
                </thead>
                <tbody data-chart-table-body></tbody>
              </table>
            </div>
          </details>
        </div>
      `;
    };

    const performanceCharts = (() => {
      const SVG_NS = "http://www.w3.org/2000/svg";
      const CHART_CACHE_TTL = 60_000;
      const cache = new Map();
      const pending = new Map();

      const getKey = (scope, identifier) => (scope === "portfolio" ? "__portfolio__" : `account::${identifier}`);

      const normaliseHistory = (history) => {
        if (!Array.isArray(history)) {
          return [];
        }
        return history
          .map((entry) => {
            const balance = Number(entry?.balance);
            if (!Number.isFinite(balance)) {
              return null;
            }
            const date = entry?.date ? String(entry.date) : null;
            const timestamp = entry?.timestamp ? String(entry.timestamp) : null;
            if (!date && !timestamp) {
              return null;
            }
            return { date, timestamp, balance };
          })
          .filter(Boolean)
          .sort((a, b) => {
            const aValue = a.timestamp || a.date || "";
            const bValue = b.timestamp || b.date || "";
            const aTime = Date.parse(aValue);
            const bTime = Date.parse(bValue);
            if (!Number.isNaN(aTime) && !Number.isNaN(bTime)) {
              return aTime - bTime;
            }
            return aValue.localeCompare(bValue);
          });
      };

      const enrichHistory = (history) => history.map((entry, index) => {
        const previous = index > 0 ? history[index - 1] : null;
        let delta = null;
        let pct = null;
        if (previous) {
          delta = entry.balance - previous.balance;
          if (previous.balance !== 0) {
            pct = delta / previous.balance;
          }
        }
        return { ...entry, delta, pct };
      });

      const createSvgElement = (name, attributes = {}) => {
        const element = document.createElementNS(SVG_NS, name);
        Object.entries(attributes).forEach(([key, value]) => {
          if (value !== undefined && value !== null && value !== "") {
            element.setAttribute(key, value);
          }
        });
        return element;
      };

      const formatHistoryDate = (entry, { short = false } = {}) => {
        if (!entry) {
          return "-";
        }
        const value = entry.timestamp || entry.date;
        if (!value) {
          return entry.date || "-";
        }
        const parsed = new Date(value);
        if (Number.isNaN(parsed.getTime())) {
          return entry.date || value;
        }
        if (entry.timestamp) {
          if (short) {
            return parsed.toLocaleDateString(undefined, { month: "short", day: "numeric" });
          }
          return parsed.toLocaleString(undefined, { dateStyle: "medium", timeStyle: "short" });
        }
        if (short) {
          return parsed.toLocaleDateString(undefined, { month: "short", day: "numeric" });
        }
        return parsed.toLocaleDateString(undefined, { dateStyle: "medium" });
      };

      const getPayload = (scope, identifier) => {
        const key = getKey(scope, identifier);
        const cached = cache.get(key);
        if (cached && Date.now() - cached.timestamp < CHART_CACHE_TTL) {
          return Promise.resolve(cached.payload);
        }
        if (pending.has(key)) {
          return pending.get(key);
        }
        const url = scope === "portfolio"
          ? "/api/performance/portfolio"
          : `/api/performance/accounts/${encodeURIComponent(identifier)}`;
        const request = fetch(url, { credentials: "include" })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`Performance request failed (${response.status})`);
            }
            return response.json();
          })
          .then((payload) => {
            cache.set(key, { payload, timestamp: Date.now() });
            return payload;
          })
          .finally(() => {
            pending.delete(key);
          });
        pending.set(key, request);
        return request;
      };

      const setState = (container, loading) => {
        if (!container) {
          return;
        }
        if (loading) {
          container.setAttribute("data-loading", "true");
          container.setAttribute("aria-busy", "true");
        } else {
          container.removeAttribute("data-loading");
          container.removeAttribute("aria-busy");
        }
      };

      const showError = (container, message) => {
        if (!container) {
          return;
        }
        container.classList.remove("chart-card--has-data");
        container.classList.add("chart-card--empty", "chart-card--error");
        const svg = container.querySelector("[data-chart-svg]");
        if (svg) {
          svg.replaceChildren();
          svg.setAttribute("aria-hidden", "true");
        }
        const emptyEl = container.querySelector("[data-chart-empty]");
        if (emptyEl) {
          emptyEl.textContent = message;
          emptyEl.hidden = false;
        }
        const summaryEl = container.querySelector("[data-chart-summary]");
        if (summaryEl) {
          summaryEl.textContent = message;
          summaryEl.classList.remove("gain", "loss");
        }
        const tableBody = container.querySelector("[data-chart-table-body]");
        if (tableBody) {
          tableBody.innerHTML = `<tr><td colspan="4">${escapeHtml(message)}</td></tr>`;
        }
      };

      const renderLineChart = (svg, history) => {
        if (!svg) {
          return;
        }
        svg.replaceChildren();
        const width = 640;
        const height = 220;
        const padding = { top: 20, right: 18, bottom: 32, left: 60 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
        svg.setAttribute("aria-hidden", "false");

        const timestamps = history.map((entry, index) => {
          const raw = entry.timestamp || entry.date;
          const parsed = raw ? Date.parse(raw) : NaN;
          if (Number.isNaN(parsed)) {
            return history.length === 1 ? index : null;
          }
          return parsed;
        });
        const validTimes = timestamps.filter((value) => value !== null);
        const minTime = validTimes.length ? Math.min(...validTimes) : 0;
        const maxTime = validTimes.length ? Math.max(...validTimes) : minTime + history.length;
        const balances = history.map((entry) => entry.balance);
        const minBalance = Math.min(...balances);
        const maxBalance = Math.max(...balances);
        const paddingY = (maxBalance - minBalance) * 0.1 || Math.abs(maxBalance || 1) * 0.1;
        const yMin = minBalance - paddingY;
        const yMax = maxBalance + paddingY;
        const xRange = maxTime - minTime || 1;
        const yRange = yMax - yMin || 1;

        const points = history.map((entry, index) => {
          const raw = entry.timestamp || entry.date;
          const parsed = raw ? Date.parse(raw) : NaN;
          const ratioX = Number.isNaN(parsed)
            ? (history.length === 1 ? 0.5 : index / Math.max(history.length - 1, 1))
            : (parsed - minTime) / xRange;
          const clampedRatioX = Math.max(0, Math.min(1, ratioX));
          const ratioY = (entry.balance - yMin) / yRange;
          const x = padding.left + clampedRatioX * chartWidth;
          const y = padding.top + (1 - Math.max(0, Math.min(1, ratioY))) * chartHeight;
          return { x, y };
        });

        const gridGroup = createSvgElement("g", { stroke: "rgba(148, 163, 184, 0.2)", "stroke-width": "1" });
        const labelGroup = createSvgElement("g", { fill: "var(--muted)", "font-size": "10" });

        const ySteps = 4;
        for (let i = 0; i <= ySteps; i += 1) {
          const ratio = i / ySteps;
          const y = padding.top + ratio * chartHeight;
          const value = yMax - ratio * (yMax - yMin);
          const line = createSvgElement("line", {
            x1: padding.left,
            x2: padding.left + chartWidth,
            y1: y,
            y2: y,
            "stroke-dasharray": "4 4",
          });
          gridGroup.appendChild(line);
          const label = createSvgElement("text", {
            x: padding.left - 8,
            y: y + 4,
            "text-anchor": "end",
          });
          label.textContent = formatCurrency(value);
          labelGroup.appendChild(label);
        }

        const axis = createSvgElement("line", {
          x1: padding.left,
          x2: padding.left + chartWidth,
          y1: padding.top + chartHeight,
          y2: padding.top + chartHeight,
          stroke: "rgba(148, 163, 184, 0.3)",
        });
        gridGroup.appendChild(axis);
        svg.appendChild(gridGroup);

        const pathData = points
          .map((point, index) => `${index === 0 ? "M" : "L"}${point.x.toFixed(2)} ${point.y.toFixed(2)}`)
          .join(" ");
        const areaPath = `${pathData} L${points[points.length - 1].x.toFixed(2)} ${padding.top + chartHeight} L${points[0].x.toFixed(2)} ${padding.top + chartHeight} Z`;
        const area = createSvgElement("path", {
          d: areaPath,
          fill: "rgba(56, 189, 248, 0.15)",
        });
        svg.appendChild(area);

        const line = createSvgElement("path", {
          d: pathData,
          fill: "none",
          stroke: "var(--accent)",
          "stroke-width": "2.5",
          "stroke-linecap": "round",
          "stroke-linejoin": "round",
        });
        svg.appendChild(line);

        const finalPoint = points[points.length - 1];
        const marker = createSvgElement("circle", {
          cx: finalPoint.x,
          cy: finalPoint.y,
          r: 4,
          fill: "var(--accent)",
          stroke: "#0f172a",
          "stroke-width": 1.5,
        });
        svg.appendChild(marker);

        const xLabels = [];
        if (history.length >= 1) {
          xLabels.push({ entry: history[0], point: points[0], anchor: "start" });
        }
        if (history.length >= 3) {
          const middleIndex = Math.floor(history.length / 2);
          xLabels.push({ entry: history[middleIndex], point: points[middleIndex], anchor: "middle" });
        }
        if (history.length >= 2) {
          xLabels.push({ entry: history[history.length - 1], point: points[points.length - 1], anchor: "end" });
        }
        xLabels.forEach(({ entry, point, anchor }) => {
          const label = createSvgElement("text", {
            x: point.x,
            y: padding.top + chartHeight + 20,
            "text-anchor": anchor,
          });
          label.textContent = formatHistoryDate(entry, { short: true });
          labelGroup.appendChild(label);
        });
        svg.appendChild(labelGroup);
      };

      const renderTable = (tableBody, history) => {
        if (!tableBody) {
          return;
        }
        if (!history.length) {
          tableBody.innerHTML = '<tr><td colspan="4">No history available.</td></tr>';
          return;
        }
        const rows = history
          .map((entry) => {
            const deltaClass = entry.delta === null ? "" : entry.delta >= 0 ? "gain" : "loss";
            const pctClass = entry.pct === null ? "" : entry.pct >= 0 ? "gain" : "loss";
            const deltaText = entry.delta === null ? "-" : formatCurrencyDelta(entry.delta);
            const pctText = entry.pct === null ? "-" : formatSignedPct(entry.pct);
            return `
              <tr>
                <td>${escapeHtml(formatHistoryDate(entry))}</td>
                <td>${escapeHtml(formatCurrency(entry.balance))}</td>
                <td class="${deltaClass}">${escapeHtml(deltaText)}</td>
                <td class="${pctClass}">${escapeHtml(pctText)}</td>
              </tr>
            `;
          })
          .join("");
        tableBody.innerHTML = rows;
      };

      const renderSummary = (summaryEl, history) => {
        if (!summaryEl) {
          return;
        }
        summaryEl.classList.remove("gain", "loss");
        if (!history.length) {
          summaryEl.textContent = "No performance data yet.";
          return;
        }
        const latest = history[history.length - 1];
        const latestText = formatCurrency(latest.balance);
        if (latest.delta === null) {
          summaryEl.textContent = `${latestText} latest`;
          return;
        }
        const deltaClass = latest.delta >= 0 ? "gain" : "loss";
        const deltaText = formatCurrencyDelta(latest.delta);
        summaryEl.innerHTML = `
          <span>${escapeHtml(latestText)}</span>
          <span class="${deltaClass}">${escapeHtml(deltaText)}${latest.pct === null ? "" : ` (${escapeHtml(formatSignedPct(latest.pct))})`}</span>
        `;
        summaryEl.classList.add(deltaClass);
      };

      const updateDescription = (descriptionEl, payload, history) => {
        if (!descriptionEl) {
          return;
        }
        if (!history.length) {
          descriptionEl.textContent = payload?.scope === "account"
            ? `No balance history available for ${payload?.account || "this account"}.`
            : "No portfolio balance history available yet.";
          return;
        }
        const first = history[0];
        const last = history[history.length - 1];
        const startLabel = formatHistoryDate(first);
        const endLabel = formatHistoryDate(last);
        if (payload?.scope === "account") {
          const name = payload?.account || "this account";
          descriptionEl.textContent = `Balance history for ${name} from ${startLabel} to ${endLabel}.`;
        } else {
          descriptionEl.textContent = `Portfolio balance history from ${startLabel} to ${endLabel}.`;
        }
      };

      const renderChart = (container, scope, identifier, payload) => {
        if (!container) {
          return;
        }
        container.classList.remove("chart-card--error");
        const svg = container.querySelector("[data-chart-svg]");
        const emptyEl = container.querySelector("[data-chart-empty]");
        const tableBody = container.querySelector("[data-chart-table-body]");
        const summaryEl = container.querySelector("[data-chart-summary]");
        const descriptionEl = container.querySelector("[data-chart-description]");
        const detailsEl = container.querySelector("[data-chart-details]");

        const history = enrichHistory(normaliseHistory(payload?.history));

        if (!history.length) {
          container.classList.add("chart-card--empty");
          container.classList.remove("chart-card--has-data");
          if (svg) {
            svg.replaceChildren();
            svg.setAttribute("aria-hidden", "true");
          }
          if (emptyEl) {
            emptyEl.hidden = false;
            emptyEl.textContent = "No performance history available yet.";
          }
          if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="4">No history available.</td></tr>';
          }
          if (summaryEl) {
            summaryEl.textContent = "No performance data yet.";
            summaryEl.classList.remove("gain", "loss");
          }
          updateDescription(descriptionEl, payload, history);
          if (detailsEl) {
            detailsEl.open = false;
          }
          return;
        }

        container.classList.add("chart-card--has-data");
        container.classList.remove("chart-card--empty");
        if (emptyEl) {
          emptyEl.hidden = true;
        }
        renderLineChart(svg, history);
        renderTable(tableBody, history);
        renderSummary(summaryEl, history);
        updateDescription(descriptionEl, payload, history);
        if (detailsEl) {
          detailsEl.hidden = false;
        }
      };

      const refreshPortfolio = async () => {
        const container = document.querySelector('[data-performance-chart="portfolio"]');
        if (!container) {
          return;
        }
        setState(container, true);
        try {
          const payload = await getPayload("portfolio", "__portfolio__");
          renderChart(container, "portfolio", "__portfolio__", payload);
        } catch (error) {
          console.error("Failed to load portfolio performance", error);
          showError(container, "Failed to load performance history.");
        } finally {
          setState(container, false);
        }
      };

      const refreshAccounts = async (accounts) => {
        if (!Array.isArray(accounts) || !accounts.length) {
          return;
        }
        const containers = new Map();
        document.querySelectorAll('[data-performance-chart="account"]').forEach((node) => {
          if (node instanceof HTMLElement) {
            const name = node.dataset.accountName;
            if (name) {
              containers.set(name, node);
            }
          }
        });
        const tasks = accounts
          .map((account) => {
            const container = containers.get(account.name);
            if (!container) {
              return null;
            }
            setState(container, true);
            return getPayload("account", account.name)
              .then((payload) => {
                renderChart(container, "account", account.name, payload);
              })
              .catch((error) => {
                console.error(`Failed to load performance for ${account.name}`, error);
                showError(container, "Failed to load performance history.");
              })
              .finally(() => {
                setState(container, false);
              });
          })
          .filter(Boolean);
        await Promise.allSettled(tasks);
      };

      return { refreshPortfolio, refreshAccounts };
    })();

    const updateAccountsSummary = (meta, visibleCount) => {
      if (!accountsSummaryEl) {
        return;
      }
      const filtered = Number(meta?.filtered ?? 0);
      const page = Number(meta?.page ?? state.accounts.page ?? 1);
      const pageSize = Number(meta?.page_size ?? state.accounts.pageSize ?? DEFAULT_ACCOUNTS_STATE.pageSize);
      let summaryText = "No accounts match the selected filters.";
      if (filtered && visibleCount) {
        const start = (page - 1) * pageSize + 1;
        const end = start + visibleCount - 1;
        summaryText = `Showing ${start}–${end} of ${filtered} account${filtered === 1 ? "" : "s"}`;
      }
      const sortKey = meta?.sort_key || state.accounts.sortKey || DEFAULT_SORT_KEY;
      const sortOrder = (meta?.sort_order || state.accounts.sortOrder || DEFAULT_SORT_ORDER).toLowerCase() === "asc"
        ? "ascending"
        : "descending";
      const sortLabel = SORT_LABELS[sortKey] || SORT_LABELS[DEFAULT_SORT_KEY];
      accountsSummaryEl.innerHTML = `
        <span>${summaryText}</span>
        <span>Sorted by ${sortLabel} (${sortOrder})</span>
      `;
    };

    const updateAccountsPagination = (meta) => {
      if (!paginationContainer) {
        return;
      }
      const page = Number(meta?.page ?? state.accounts.page ?? 1);
      const pages = Math.max(1, Number(meta?.pages ?? 1));
      const hasPrev = Boolean(meta?.has_previous ?? page > 1);
      const hasNext = Boolean(meta?.has_next ?? page < pages);
      paginationContainer.innerHTML = `
        <button type="button" data-page="prev"${hasPrev ? "" : " disabled"}>Previous</button>
        <span>Page ${page} of ${pages}</span>
        <button type="button" data-page="next"${hasNext ? "" : " disabled"}>Next</button>
      `;
    };

    const renderPortfolio = (snapshot) => {
      const portfolioSection = document.querySelector(
        '[data-page-section="overview"] [data-portfolio]',
      );
      if (!portfolioSection || !snapshot.portfolio) {
        return;
      }
      const portfolio = snapshot.portfolio;
      const symbolEntries = Array.isArray(portfolio.symbols) ? portfolio.symbols : [];
      const symbolRows = symbolEntries
        .map((entry) => {
          const volatility = entry.volatility || {};
          const funding = entry.funding_rates || {};
          return `
          <tr>
            <td>${entry.symbol}</td>
            <td>${formatCurrency(entry.gross_notional)}</td>
            <td>${formatPct(entry.gross_pct)}</td>
            <td class="${Number(entry.net_notional) >= 0 ? "gain" : "loss"}">${formatCurrency(entry.net_notional)}</td>
            <td class="${Number(entry.net_pct) >= 0 ? "gain" : "loss"}">${formatPct(entry.net_pct)}</td>
            ${METRIC_WINDOWS.map((window) => `<td>${formatMetricValue(volatility?.[window])}</td>`).join("")}
            ${METRIC_WINDOWS.map((window) => `<td>${formatMetricValue(funding?.[window])}</td>`).join("")}
          </tr>
        `;
        })
        .join("");
      const hasPortfolioMetrics = METRIC_WINDOWS.some(
        (window) =>
          isFiniteNumber(portfolio.volatility?.[window]) ||
          isFiniteNumber(portfolio.funding_rates?.[window]),
      );
      const performanceMetrics = renderPerformanceMetrics(portfolio.performance || null);
      const chartBlock = renderPerformanceChartShell("portfolio", {
        chartId: "portfolio-balance",
        description: "Daily portfolio balance history.",
      });
      const metricsTable = hasPortfolioMetrics
        ? `
          <div class="table-wrapper" style="margin-top: 1.5rem;">
            <table class="compact">
              <thead>
                <tr>
                  <th>Window</th>
                  <th>Volatility</th>
                  <th>Funding rate</th>
                </tr>
              </thead>
              <tbody>
                ${METRIC_WINDOWS.map(
                  (window) => `
                    <tr>
                      <td>${window}</td>
                      <td>${formatMetricValue(portfolio.volatility?.[window])}</td>
                      <td>${formatMetricValue(portfolio.funding_rates?.[window])}</td>
                    </tr>
                  `,
                ).join("")}
              </tbody>
            </table>
            ${renderTablePaginationFooter("Portfolio metrics", METRIC_WINDOWS.length)}
          </div>
        `
        : "";
      const exposuresTable = symbolRows
        ? `
          <div class="table-wrapper" style="margin-top: 1.5rem;">
            <table>
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Gross Exposure</th>
                  <th>Gross %</th>
                  <th>Net Exposure</th>
                  <th>Net %</th>
                  ${METRIC_WINDOWS.map((window) => `<th>Vol ${window}</th>`).join("")}
                  ${METRIC_WINDOWS.map((window) => `<th>Fund ${window}</th>`).join("")}
                </tr>
              </thead>
              <tbody>${symbolRows}</tbody>
            </table>
            ${renderTablePaginationFooter("Portfolio exposures", symbolEntries.length)}
          </div>
        `
        : '<p style="color: var(--muted); margin-top: 1rem;">No active exposures.</p>';
      portfolioSection.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 style="margin-bottom: 0.5rem;">Portfolio overview</h2>
            <p style="color: var(--muted); margin: 0;">
              Snapshot generated at <strong data-overview-generated>${new Date(snapshot.generated_at).toLocaleString()}</strong>
            </p>
          </div>
          <span class="badge ${Array.isArray(snapshot.alerts) && snapshot.alerts.length > 0 ? "alert" : "ok"}" data-alert-summary>
            ${Array.isArray(snapshot.alerts) && snapshot.alerts.length > 0 ? `${snapshot.alerts.length} active alert${snapshot.alerts.length === 1 ? "" : "s"}` : "All clear"}
          </span>
        </div>
        <div class="metrics" style="margin-top: 1.5rem;">
          <div class="metric">
            <span class="label">Total Balance</span>
            <span class="value">${formatCurrency(portfolio.balance)}</span>
          </div>
          <div class="metric">
            <span class="label">Daily Realised PnL</span>
            <span class="value ${Number(portfolio.daily_realized_pnl) >= 0 ? "gain" : "loss"}">${formatCurrency(portfolio.daily_realized_pnl)}</span>
          </div>
          <div class="metric">
            <span class="label">Gross Exposure</span>
            <span class="value">${formatCurrency(portfolio.gross_exposure)}</span>
            <span class="subvalue">${formatPct(portfolio.gross_exposure_pct)}</span>
          </div>
          <div class="metric">
            <span class="label">Net Exposure</span>
            <span class="value ${Number(portfolio.net_exposure) >= 0 ? "gain" : "loss"}">${formatCurrency(portfolio.net_exposure)}</span>
            <span class="subvalue ${Number(portfolio.net_exposure_pct) >= 0 ? "gain" : "loss"}">${formatPct(portfolio.net_exposure_pct)}</span>
          </div>
        </div>
        ${performanceMetrics}
        ${chartBlock}
        ${metricsTable}
        ${exposuresTable}
      `;
      performanceCharts.refreshPortfolio();
    };

    const renderAccounts = (snapshot) => {
      if (!accountsContainer) {
        return;
      }
      const accountsData = Array.isArray(snapshot.accounts) ? snapshot.accounts : [];
      const hideEmpty = state.accounts.hideEmpty || {};

      accountsContainer.innerHTML = accountsData
        .map((account) => {
          const exposures = Array.isArray(account.symbol_exposures) ? account.symbol_exposures : [];
          const positions = Array.isArray(account.positions) ? account.positions : [];
          const orders = Array.isArray(account.orders) ? account.orders : [];
          const exposuresRows = exposures
            .map((exposure) => `
              <tr>
                <td>${exposure.symbol}</td>
                <td>${formatCurrency(exposure.gross_notional)}</td>
                <td>${formatPct(exposure.gross_pct)}</td>
                <td class="${Number(exposure.net_notional) >= 0 ? "gain" : "loss"}">${formatCurrency(exposure.net_notional)}</td>
                <td class="${Number(exposure.net_pct) >= 0 ? "gain" : "loss"}">${formatPct(exposure.net_pct)}</td>
              </tr>
            `)
            .join("");
          const accountVolatility = account.volatility || {};
          const accountFunding = account.funding_rates || {};
          const hasAccountMetrics = METRIC_WINDOWS.some(
            (window) =>
              isFiniteNumber(accountVolatility?.[window]) ||
              isFiniteNumber(accountFunding?.[window]),
          );
          let accountMetricsTable = "";
          if (hasAccountMetrics) {
            accountMetricsTable = `
              <div class="table-wrapper" style="margin-bottom: 1.5rem;">
                <table class="compact">
                  <thead>
                    <tr>
                      <th>Window</th>
                      <th>Volatility</th>
                      <th>Funding rate</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${METRIC_WINDOWS.map(
                      (window) => `
                        <tr>
                          <td>${window}</td>
                          <td>${formatMetricValue(accountVolatility?.[window])}</td>
                          <td>${formatMetricValue(accountFunding?.[window])}</td>
                        </tr>
                      `,
                    ).join("")}
                  </tbody>
                </table>
                ${renderTablePaginationFooter(`${account.name} metrics`, METRIC_WINDOWS.length)}
              </div>
            `;
          }
          const positionsRows = positions
            .map((position) => {
              const pnlClass = Number(position.unrealized_pnl) >= 0 ? "gain" : "loss";
              const realizedClass = Number(position.daily_realized_pnl) >= 0 ? "gain" : "loss";
              const maxDd = position.max_drawdown_pct !== null && position.max_drawdown_pct !== undefined
                ? formatPct(position.max_drawdown_pct)
                : "-";
              const volatility = position.volatility || {};
              const funding = position.funding_rates || {};
              return `
                <tr>
                  <td>${position.symbol}</td>
                  <td>${position.side}</td>
                  <td>${formatCurrency(position.notional)}</td>
                  <td>${formatPct(position.exposure)}</td>
                  <td class="${pnlClass}">${formatCurrency(position.unrealized_pnl)} (${formatPct(position.pnl_pct)})</td>
                  <td class="${realizedClass}">${formatCurrency(position.daily_realized_pnl)}</td>
                  <td>${formatPrice(position.entry_price)}</td>
                  <td>${formatPrice(position.mark_price)}</td>
                  <td>${formatPrice(position.liquidation_price)}</td>
                  <td>${maxDd}</td>
                  <td>${formatPrice(position.take_profit_price)}</td>
                  <td>${formatPrice(position.stop_loss_price)}</td>
                  ${METRIC_WINDOWS.map((window) => `<td>${formatMetricValue(volatility?.[window])}</td>`).join("")}
                  ${METRIC_WINDOWS.map((window) => `<td>${formatMetricValue(funding?.[window])}</td>`).join("")}
                  <td>
                    <div style="display: flex; flex-direction: column; gap: 0.35rem; min-width: 9rem;">
                      <button
                        type="button"
                        class="button danger small"
                        data-position-kill
                        data-position-account="${account.name}"
                        data-position-symbol="${position.symbol}"
                      >
                        Kill position
                      </button>
                      <div
                        class="status-message"
                        data-position-status="${account.name}::${position.symbol}"
                        hidden
                      ></div>
                    </div>
                  </td>
                </tr>
              `;
            })
            .join("");
          const ordersRows = orders
            .map((order) => `
              <tr>
                <td>${order.order_id || "-"}</td>
                <td>${order.symbol}</td>
                <td>${order.side}</td>
                <td>${order.type}</td>
                <td>${order.price !== null && order.price !== undefined ? formatCurrency(order.price) : "-"}</td>
                <td>${order.amount ?? "-"}</td>
                <td>${order.remaining ?? "-"}</td>
                <td>${order.status || "-"}</td>
                <td>${order.reduce_only ? "Yes" : "No"}</td>
                <td>${order.notional !== null && order.notional !== undefined ? formatCurrency(order.notional) : "-"}</td>
                <td>${order.stop_price !== null && order.stop_price !== undefined ? formatCurrency(order.stop_price) : "-"}</td>
                <td>${order.created_at || "-"}</td>
              </tr>
            `)
            .join("");
          const showEmptyExposures = !hideEmpty.exposures;
          const showEmptyPositions = !hideEmpty.positions;
          const showEmptyOrders = !hideEmpty.orders;
          const exposuresTable = exposuresRows
            ? `
                <div class="table-wrapper" style="margin-bottom: 1.5rem;">
                  <table>
                    <thead>
                      <tr>
                        <th>Symbol</th>
                        <th>Gross Exposure</th>
                        <th>Gross %</th>
                        <th>Net Exposure</th>
                        <th>Net %</th>
                      </tr>
                    </thead>
                    <tbody>${exposuresRows}</tbody>
                  </table>
                  ${renderTablePaginationFooter(`${account.name} exposures`, exposures.length)}
                </div>
              `
            : showEmptyExposures
              ? '<p style="color: var(--muted); margin: 0;">No symbol exposures.</p>'
              : "";
          const positionsTable = positions.length > 0
            ? `
                <div class="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th>Notional</th>
                        <th>Exposure %</th>
                        <th>PnL</th>
                        <th>Daily realised PnL</th>
                        <th>Entry</th>
                        <th>Mark</th>
                        <th>Liq.</th>
                        <th>Max DD</th>
                        <th>TP</th>
                        <th>SL</th>
                        ${METRIC_WINDOWS.map((window) => `<th>Vol ${window}</th>`).join("")}
                        ${METRIC_WINDOWS.map((window) => `<th>Fund ${window}</th>`).join("")}
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>${positionsRows}</tbody>
                  </table>
                  ${renderTablePaginationFooter(`${account.name} positions`, positions.length)}
                </div>
              `
            : showEmptyPositions
              ? '<p style="color: var(--muted);">No open positions.</p>'
              : "";
          const ordersTable = orders.length > 0
            ? `
                <h3 style="margin-top: 1.5rem;">Open orders</h3>
                <div class="table-wrapper" style="overflow-x: auto;">
                  <table>
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th>Type</th>
                        <th>Price</th>
                        <th>Amount</th>
                        <th>Remaining</th>
                        <th>Status</th>
                        <th>Reduce only</th>
                        <th>Notional</th>
                        <th>Stop price</th>
                        <th>Created</th>
                      </tr>
                    </thead>
                    <tbody>${ordersRows}</tbody>
                  </table>
                  ${renderTablePaginationFooter(`${account.name} orders`, orders.length)}
                </div>
              `
            : showEmptyOrders
              ? `
                <h3 style="margin-top: 1.5rem;">Open orders</h3>
                <p style="color: var(--muted);">No open orders.</p>
              `
              : "";

          const accountPerformance = account.performance || null;
          const performanceMetricsBlock = renderPerformanceMetrics(accountPerformance);
          const chartBlock = renderPerformanceChartShell("account", {
            accountName: account.name,
            description: `Balance history for ${account.name}.`,
          });

          const stopLoss = account.stop_loss;
          let stopLossBlock = "";
          if (stopLoss) {
            const threshold = stopLoss.threshold_pct !== null && stopLoss.threshold_pct !== undefined
              ? `${Number(stopLoss.threshold_pct).toFixed(2)}%`
              : "?%";
            const drawdown = stopLoss.current_drawdown_pct !== null && stopLoss.current_drawdown_pct !== undefined
              ? ` Current drawdown ${(Number(stopLoss.current_drawdown_pct) * 100).toFixed(2)}%.`
              : "";
            const baseline = stopLoss.baseline_balance !== null && stopLoss.baseline_balance !== undefined
              ? ` Baseline ${formatCurrency(stopLoss.baseline_balance)}.`
              : "";
            const triggeredAt = stopLoss.triggered_at ? ` Triggered at ${stopLoss.triggered_at}.` : "";
            const stateLabel = stopLoss.triggered ? "<strong>triggered</strong>" : "active";
            stopLossBlock = `
              <div class="status" style="margin-top: 1rem;">
                Stop loss ${stateLabel} at ${threshold}.${drawdown}${baseline}${triggeredAt}
              </div>
            `;
          }

          return `
            <section class="card" data-account="${account.name}">
              <div class="card-header" style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                  <h2 style="margin: 0;">${account.name}</h2>
                  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="badge">${positions.length} position${positions.length === 1 ? "" : "s"}</span>
                    <span class="badge">${orders.length} order${orders.length === 1 ? "" : "s"}</span>
                  </div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                  <button type="button" class="button danger" data-kill-switch="${account.name}">Kill switch</button>
                  <div class="status-message" data-kill-status="${account.name}" hidden></div>
                </div>
              </div>
              ${account.message ? `<div class="status">${account.message}</div>` : ""}
              <div class="metrics">
                <div class="metric">
                  <span class="label">Balance</span>
                  <span class="value">${formatCurrency(account.balance)}</span>
                </div>
                <div class="metric">
                  <span class="label">Daily Realised PnL</span>
                  <span class="value ${Number(account.daily_realized_pnl) >= 0 ? "gain" : "loss"}">${formatCurrency(account.daily_realized_pnl)}</span>
                </div>
                <div class="metric">
                  <span class="label">Gross Exposure</span>
                  <span class="value">${formatCurrency(account.gross_exposure_notional)}</span>
                  <span class="subvalue">${formatPct(account.gross_exposure)}</span>
                </div>
                <div class="metric">
                  <span class="label">Net Exposure</span>
                  <span class="value ${Number(account.net_exposure_notional) >= 0 ? "gain" : "loss"}">${formatCurrency(account.net_exposure_notional)}</span>
                  <span class="subvalue ${Number(account.net_exposure) >= 0 ? "gain" : "loss"}">${formatPct(account.net_exposure)}</span>
                </div>
              <div class="metric">
                <span class="label">Unrealized PnL</span>
                <span class="value ${Number(account.unrealized_pnl) >= 0 ? "gain" : "loss"}">${formatCurrency(account.unrealized_pnl)}</span>
              </div>
            </div>
            ${performanceMetricsBlock}
            ${chartBlock}
            ${stopLossBlock}
            ${accountMetricsTable}
            ${exposuresTable}
            <div class="report-actions" style="margin: 1.5rem 0;">
              <button type="button" class="button secondary" data-generate-report="${account.name}">Generate report</button>
                <div class="status-message" data-report-status="${account.name}" hidden></div>
              </div>
              ${positionsTable}
              ${ordersTable}
            </section>
          `;
        })
        .join("");

      performanceCharts.refreshAccounts(accountsData);

      const meta = snapshot.accounts_meta || {};
      lastAccountsMeta = meta;
      if (typeof meta.page === "number") {
        state.accounts.page = meta.page;
      }
      if (typeof meta.page_size === "number") {
        state.accounts.pageSize = meta.page_size;
      }
      if (typeof meta.sort_key === "string") {
        state.accounts.sortKey = meta.sort_key;
      }
      if (typeof meta.sort_order === "string") {
        state.accounts.sortOrder = meta.sort_order;
      }
      updateAccountsSummary(meta, accountsData.length);
      updateAccountsPagination(meta);
      applyAccountsControlsFromState();
      persistState();
    };

    const setReportStatus = (accountName, message, variant = "info") => {
      const statusEl = document.querySelector(`[data-report-status="${accountName}"]`);
      if (!statusEl) {
        return;
      }
      statusEl.classList.remove("success", "error");
      if (!message) {
        statusEl.textContent = "";
        statusEl.hidden = true;
        return;
      }
      statusEl.textContent = message;
      statusEl.hidden = false;
      if (variant === "success") {
        statusEl.classList.add("success");
      } else if (variant === "error") {
        statusEl.classList.add("error");
      }
    };

    const triggerReportDownload = (downloadUrl, filename) => {
      if (!downloadUrl) {
        return;
      }
      const anchor = document.createElement("a");
      anchor.href = downloadUrl;
      if (filename) {
        anchor.download = filename;
      }
      anchor.rel = "noopener";
      anchor.style.display = "none";
      document.body.appendChild(anchor);
      anchor.click();
      requestAnimationFrame(() => anchor.remove());
    };

    const generateAccountReport = async (accountName, button) => {
      if (!accountName) {
        return;
      }
      const statusEl = document.querySelector(`[data-report-status="${accountName}"]`);
      if (statusEl) {
        statusEl.hidden = false;
        statusEl.classList.remove("success", "error");
        statusEl.textContent = "Generating report...";
      }
      if (button) {
        button.disabled = true;
      }
      try {
        const response = await fetch(`/api/accounts/${encodeURIComponent(accountName)}/reports`, {
          method: "POST",
          credentials: "include",
        });
        if (!response.ok) {
          throw new Error(`Failed to generate report (${response.status})`);
        }
        const payload = await response.json();
        if (statusEl) {
          statusEl.textContent = "Report generated.";
          statusEl.classList.remove("error");
          statusEl.classList.add("success");
        }
        triggerReportDownload(payload.download_url, payload.filename);
      } catch (error) {
        console.error(error);
        if (statusEl) {
          statusEl.textContent = `Report generation failed: ${error.message}`;
          statusEl.classList.remove("success");
          statusEl.classList.add("error");
          statusEl.hidden = false;
        }
      } finally {
        if (button) {
          button.disabled = false;
        }
      }
    };

    const renderAlerts = (snapshot) => {
      const alertsContainer = document.querySelector(
        '[data-page-section="alerts"] [data-alerts]',
      );
      if (!alertsContainer) {
        return;
      }
      if (Array.isArray(snapshot.alerts) && snapshot.alerts.length > 0) {
        if (alertsContainer.tagName === "UL") {
          alertsContainer.innerHTML = snapshot.alerts.map((alert) => `<li>${alert}</li>`).join("");
        } else {
          const ul = document.createElement("ul");
          ul.innerHTML = snapshot.alerts.map((alert) => `<li>${alert}</li>`).join("");
          alertsContainer.replaceWith(ul);
          ul.setAttribute("data-alerts", "");
        }
      } else if (alertsContainer) {
        if (alertsContainer.tagName === "UL") {
          const replacement = document.createElement("p");
          replacement.textContent = "No active alerts. All monitored metrics are within thresholds.";
          replacement.style.color = "var(--muted)";
          replacement.setAttribute("data-alerts", "");
          alertsContainer.replaceWith(replacement);
        } else {
          alertsContainer.textContent = "No active alerts. All monitored metrics are within thresholds.";
        }
      }
    };

    const renderNotifications = (snapshot) => {
      const notificationsContainer = document.querySelector(
        '[data-page-section="alerts"] [data-notifications]',
      );
      if (!notificationsContainer) {
        return;
      }
      if (Array.isArray(snapshot.notifications) && snapshot.notifications.length > 0) {
        if (notificationsContainer.tagName === "UL") {
          notificationsContainer.innerHTML = snapshot.notifications.map((channel) => `<li>${channel}</li>`).join("");
        } else {
          const ul = document.createElement("ul");
          ul.innerHTML = snapshot.notifications.map((channel) => `<li>${channel}</li>`).join("");
          notificationsContainer.replaceWith(ul);
          ul.setAttribute("data-notifications", "");
        }
      } else if (notificationsContainer) {
        if (notificationsContainer.tagName === "UL") {
          const replacement = document.createElement("p");
          replacement.textContent = "No notification channels configured.";
          replacement.style.color = "var(--muted)";
          replacement.setAttribute("data-notifications", "");
          notificationsContainer.replaceWith(replacement);
        } else {
          notificationsContainer.textContent = "No notification channels configured.";
        }
      }
    };

    const renderSnapshot = (snapshot) => {
      latestSnapshot = snapshot;
      const generatedAtEl = document.querySelector("[data-generated-at]");
      if (generatedAtEl && snapshot.generated_at) {
        generatedAtEl.textContent = new Date(snapshot.generated_at).toLocaleString();
      }
      renderPortfolio(snapshot);
      renderAccounts(snapshot);
      renderAlerts(snapshot);
      renderNotifications(snapshot);
    };

    const buildSnapshotParams = () => {
      const params = new URLSearchParams();
      const accountsState = state.accounts;
      const page = Math.max(1, Number(accountsState.page || 1));
      params.set("page", String(page));
      params.set("page_size", String(Math.max(1, Number(accountsState.pageSize || DEFAULT_ACCOUNTS_STATE.pageSize))));
      if (accountsState.search) {
        params.set("search", accountsState.search);
      }
      if (accountsState.exposure && accountsState.exposure !== "any") {
        params.set("exposure", accountsState.exposure);
      }
      if (accountsState.sortKey && accountsState.sortKey !== DEFAULT_SORT_KEY) {
        params.set("sort", accountsState.sortKey);
      }
      if (accountsState.sortOrder && accountsState.sortOrder !== DEFAULT_SORT_ORDER) {
        params.set("sort_order", accountsState.sortOrder);
      }
      return params;
    };

    const fetchSnapshot = async () => {
      const params = buildSnapshotParams();
      const query = params.toString();
      const url = query ? `/api/snapshot?${query}` : "/api/snapshot";
      const response = await fetch(url, { credentials: "include" });
      if (!response.ok) {
        throw new Error(`Snapshot request failed (${response.status})`);
      }
      return response.json();
    };

    const requestSnapshot = async () => {
      if (isFetchingSnapshot) {
        fetchQueued = true;
        return;
      }
      isFetchingSnapshot = true;
      try {
        const snapshot = await fetchSnapshot();
        renderSnapshot(snapshot);
      } catch (error) {
        console.error("Failed to refresh snapshot", error);
      } finally {
        isFetchingSnapshot = false;
        if (fetchQueued) {
          fetchQueued = false;
          requestSnapshot();
        }
      }
    };

    const triggerKillSwitch = async (accountName, button, symbol) => {
      let endpoint = "/api/kill-switch";
      let statusSelector = '[data-kill-status="__portfolio__"]';
      if (accountName) {
        if (symbol) {
          endpoint = `/api/accounts/${encodeURIComponent(accountName)}/positions/${encodeURIComponent(symbol)}/kill-switch`;
          statusSelector = `[data-position-status="${accountName}::${symbol}"]`;
        } else {
          endpoint = `/api/accounts/${encodeURIComponent(accountName)}/kill-switch`;
          statusSelector = `[data-kill-status="${accountName}"]`;
        }
      }
      const statusEl = document.querySelector(statusSelector);
      if (statusEl) {
        statusEl.textContent = "Executing kill switch...";
        statusEl.hidden = false;
        statusEl.classList.remove("success");
      }
      if (button) button.disabled = true;
      try {
        const response = await fetch(endpoint, {
          method: "POST",
          credentials: "include",
        });
        if (!response.ok) {
          throw new Error(`Kill switch failed (${response.status})`);
        }
        const payload = await response.json();
        if (payload && payload.success === false) {
          const details = Array.isArray(payload.errors) && payload.errors.length
            ? payload.errors.join("; ")
            : "Kill switch encountered errors.";
          throw new Error(details);
        }
        if (statusEl) {
          statusEl.textContent = "Kill switch executed.";
          statusEl.classList.add("success");
        }
        await requestSnapshot();
      } catch (error) {
        console.error(error);
        if (statusEl) {
          statusEl.textContent = `Kill switch failed: ${error.message}`;
          statusEl.classList.remove("success");
        }
      } finally {
        if (button) button.disabled = false;
      }
    };

    if (searchInput) {
      searchInput.addEventListener("input", (event) => {
        const { value } = event.target;
        if (searchDebounceHandle) {
          window.clearTimeout(searchDebounceHandle);
        }
        searchDebounceHandle = window.setTimeout(() => {
          state.accounts.search = value.trim();
          state.accounts.page = 1;
          persistState();
          requestSnapshot();
        }, 250);
      });
    }

    if (exposureSelect) {
      exposureSelect.addEventListener("change", () => {
        state.accounts.exposure = exposureSelect.value || "any";
        state.accounts.page = 1;
        persistState();
        requestSnapshot();
      });
    }

    if (pageSizeSelect) {
      pageSizeSelect.addEventListener("change", () => {
        const parsed = Number.parseInt(pageSizeSelect.value, 10);
        if (!Number.isFinite(parsed) || parsed <= 0) {
          return;
        }
        state.accounts.pageSize = parsed;
        state.accounts.page = 1;
        persistState();
        requestSnapshot();
      });
    }

    hideEmptyChips.forEach((chip) => {
      chip.addEventListener("click", () => {
        const key = chip.getAttribute("data-hide-empty");
        if (!key) {
          return;
        }
        const current = Boolean(state.accounts.hideEmpty?.[key]);
        state.accounts.hideEmpty[key] = !current;
        persistState();
        updateHideEmptyChips();
        if (latestSnapshot) {
          renderAccounts(latestSnapshot);
        }
      });
    });

    sortButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const key = button.getAttribute("data-sort-key");
        if (!key) {
          return;
        }
        if (state.accounts.sortKey === key) {
          state.accounts.sortOrder = state.accounts.sortOrder === "asc" ? "desc" : "asc";
        } else {
          state.accounts.sortKey = key;
          state.accounts.sortOrder = key === "name" ? "asc" : DEFAULT_SORT_ORDER;
        }
        state.accounts.page = 1;
        updateSortButtons();
        persistState();
        requestSnapshot();
      });
    });

    if (paginationContainer) {
      paginationContainer.addEventListener("click", (event) => {
        const button = event.target.closest("[data-page]");
        if (!button || button.hasAttribute("disabled")) {
          return;
        }
        const direction = button.getAttribute("data-page");
        if (!direction) {
          return;
        }
        const meta = lastAccountsMeta || {};
        const currentPage = Number(state.accounts.page || meta.page || 1);
        const totalPages = Math.max(1, Number(meta.pages || currentPage));
        if (direction === "prev" && currentPage > 1) {
          state.accounts.page = currentPage - 1;
        } else if (direction === "next" && currentPage < totalPages) {
          state.accounts.page = currentPage + 1;
        } else if (direction === "next") {
          state.accounts.page = currentPage + 1;
        }
        persistState();
        requestSnapshot();
      });
    }

    document.addEventListener("click", (event) => {
      const portfolioKillButton = event.target.closest("[data-kill-portfolio]");
      if (portfolioKillButton) {
        triggerKillSwitch(null, portfolioKillButton);
        return;
      }
      const killButton = event.target.closest("[data-kill-switch]");
      if (killButton) {
        const accountName = killButton.getAttribute("data-kill-switch");
        triggerKillSwitch(accountName, killButton);
        return;
      }
      const positionKillButton = event.target.closest("[data-position-kill]");
      if (positionKillButton) {
        const accountName = positionKillButton.getAttribute("data-position-account");
        const symbol = positionKillButton.getAttribute("data-position-symbol");
        triggerKillSwitch(accountName, positionKillButton, symbol);
        return;
      }
      const reportButton = event.target.closest("[data-generate-report]");
      if (reportButton) {
        const accountName = reportButton.getAttribute("data-generate-report");
        generateAccountReport(accountName, reportButton);
      }
    });

    setInterval(() => {
      requestSnapshot();
    }, REFRESH_INTERVAL_MS);
    requestSnapshot();
  </script>
{% endblock %}