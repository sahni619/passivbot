<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}Risk Management Dashboard{% endblock %}</title>
    <script>
      (function () {
        const STORAGE_KEY = "risk-dashboard.theme";
        const COOKIE_KEY = "dashboard_theme";
        const getCookieTheme = () => {
          const cookie = document.cookie || "";
          const entry = cookie.split(";").map((value) => value.trim()).find((value) => value.startsWith(`${COOKIE_KEY}=`));
          return entry ? entry.split("=")[1] : null;
        };
        let theme = "";
        try {
          theme = window.localStorage.getItem(STORAGE_KEY) || "";
        } catch (error) {
          theme = "";
        }
        if (theme !== "light" && theme !== "dark") {
          theme = getCookieTheme() || "";
        }
        if (theme !== "light" && theme !== "dark") {
          theme = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark";
        }
        document.documentElement.dataset.theme = theme;
        document.documentElement.style.colorScheme = theme;
      })();
    </script>
    <link rel="stylesheet" href="{{ url_for('static', path='css/base.css') }}" />
    {% block head %}{% endblock %}
  </head>
  <body>
    <header class="site-header">
      <div class="site-title">
        <h1>Risk Management Dashboard</h1>
        <p class="site-description">Live portfolio telemetry and trade controls</p>
      </div>
      <div class="header-actions">
        <button type="button" class="button ghost" data-theme-toggle aria-pressed="false">
          <span aria-hidden="true">ðŸŒ“</span>
          <span data-theme-toggle-label>Toggle theme</span>
        </button>
        {% block header_controls %}{% endblock %}
      </div>
    </header>
    <main class="layout">
      {% block content %}{% endblock %}
    </main>
    <footer class="site-footer">
      Updated at <span data-generated-at="true">{% block generated_at %}{% endblock %}</span>
    </footer>
    {% block scripts %}{% endblock %}
    <script>
      (function () {
        const STORAGE_KEY = "risk-dashboard.theme";
        const COOKIE_KEY = "dashboard_theme";
        const root = document.documentElement;
        const toggle = document.querySelector("[data-theme-toggle]");
        const label = document.querySelector("[data-theme-toggle-label]");

        const writeCookie = (theme) => {
          const expires = new Date(Date.now() + 365 * 24 * 60 * 60 * 1000);
          document.cookie = `${COOKIE_KEY}=${theme}; path=/; expires=${expires.toUTCString()}`;
        };

        const applyTheme = (theme) => {
          const next = theme === "light" ? "light" : "dark";
          root.dataset.theme = next;
          root.style.colorScheme = next;
          if (label) {
            label.textContent = next === "dark" ? "Dark mode" : "Light mode";
          }
          if (toggle) {
            toggle.setAttribute("aria-pressed", next === "light" ? "true" : "false");
          }
          try {
            window.localStorage.setItem(STORAGE_KEY, next);
          } catch (error) {
            /* ignore */
          }
          writeCookie(next);
        };

        const currentTheme = root.dataset.theme || "dark";
        applyTheme(currentTheme);

        if (toggle) {
          toggle.addEventListener("click", () => {
            const next = root.dataset.theme === "dark" ? "light" : "dark";
            applyTheme(next);
          });
        }
      })();
    </script>
  </body>
</html>
